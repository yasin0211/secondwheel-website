<!DOCTYPE html>
<html>
<head>
  <title>Upload Vehicle</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script>
    const supabaseUrl = 'https://wbjwvxckbfkutqqbgupq.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indiand2eGNrYmZrdXRxcWJndXBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4NzU3NDEsImV4cCI6MjA2OTQ1MTc0MX0.u_zwikgAryhF5Ccv5yOvjq20hzxE5tbYfKI04uTnNXw';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);
  </script>
  <style>
    body { font-family: Arial; padding: 20px; }
    input, select, textarea { margin-bottom: 10px; width: 100%; padding: 8px; }
    img { max-width: 200px; margin-top: 10px; display: none; }
    button { background: green; color: white; padding: 10px; border: none; cursor: pointer; }
  </style>
</head>
<body>
  <h2>Vehicle Upload Form (Supabase)</h2>

  <form id="vehicleForm">
    <select name="category" required>
      <option value="">Select Category</option>
      <option>Car</option>
      <option>Bike</option>
      <option>Scooter</option>
    </select>
    <input type="text" name="brand" placeholder="Brand" required />
    <input type="text" name="model" placeholder="Model" required />
    <input type="number" name="year" placeholder="Year" required />
    <input type="number" name="price" placeholder="Price" required />
    <input type="text" name="city" placeholder="City" required />
    <input type="text" name="fuel" placeholder="Fuel" required />
    <input type="text" name="condition" placeholder="Condition" required />
    <input type="text" name="ownership" placeholder="Ownership" required />
    <select name="rc" required>
      <option value="">RC Available?</option>
      <option>Yes</option>
      <option>No</option>
    </select>
    <input type="file" id="imageInput" accept="image/*" required />
    <img id="preview" />
    <textarea name="description" placeholder="Description"></textarea>
    <button type="submit" id="submitBtn">Upload</button>
  </form>

  <script>
    const form = document.getElementById('vehicleForm');
    const imageInput = document.getElementById('imageInput');
    const preview = document.getElementById('preview');
    const submitBtn = document.getElementById('submitBtn');
    let imageUrl = "";

    imageInput.addEventListener('change', async () => {
      const file = imageInput.files[0];
      if (!file) return;

      preview.src = URL.createObjectURL(file);
      preview.style.display = "block";

      const filePath = `vehicle-${Date.now()}-${file.name}`;
      const { data, error } = await supabase.storage
        .from('vehicals')
        .upload(filePath, file);

      if (error) {
        alert("Image upload failed: " + error.message);
        imageUrl = "";
      } else {
        const { data: urlData } = supabase.storage
          .from('vehicals')
          .getPublicUrl(filePath);
        imageUrl = urlData.publicUrl;
        console.log("✅ Image uploaded:", imageUrl);
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!imageUrl) {
        alert("Please wait until image finishes uploading.");
        return;
      }

      submitBtn.disabled = true;
      submitBtn.innerText = "Uploading...";

      const formData = new FormData(form);
      const record = {
        category: formData.get('category'),
        brand: formData.get('brand'),
        model: formData.get('model'),
        year: parseInt(formData.get('year')),
        price: parseInt(formData.get('price')),
        city: formData.get('city'),
        fuel: formData.get('fuel'),
        condition: formData.get('condition'),
        ownership: formData.get('ownership'),
        rc: formData.get('rc'),
        image_url: imageUrl,
        description: formData.get('description'),
      };

      const { error } = await supabase.from('vehicles').insert([record]);

      if (error) {
        alert("❌ Upload failed: " + error.message);
      } else {
        alert("✅ Vehicle uploaded successfully!");
        form.reset();
        preview.src = "";
        preview.style.display = "none";
        imageUrl = "";
      }

      submitBtn.disabled = false;
      submitBtn.innerText = "Upload";
    });
  </script>
</body>
</html>
