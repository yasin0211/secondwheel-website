<!DOCTYPE html>
<html>
<head>
  <title>Upload Vehicle</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    input, select, textarea { margin-bottom: 10px; width: 100%; padding: 8px; }
    img.preview { max-width: 150px; margin-right: 10px; display: inline-block; }
    button { background: green; color: white; padding: 10px; border: none; cursor: pointer; }
  </style>
</head>
<body>
  <h2>Vehicle Upload Form (Supabase - Multiple Images)</h2>

  <form id="vehicleForm">
    <select name="category" required>
      <option value="">Select Category</option>
      <option>Car</option>
      <option>Bike</option>
      <option>Scooter</option>
    </select>
    <input type="text" name="brand" placeholder="Brand" required />
    <input type="text" name="model" placeholder="Model" required />
    <input type="number" name="year" placeholder="Year" required />
    <input type="number" name="price" placeholder="Price" required />
    <input type="text" name="city" placeholder="City" required />
    <input type="text" name="fuel" placeholder="Fuel" required />
    <input type="text" name="condition" placeholder="Condition" required />
    <input type="text" name="ownership" placeholder="Ownership" required />
    <select name="rc" required>
      <option value="">RC Available?</option>
      <option>Yes</option>
      <option>No</option>
    </select>
    
    <input type="file" id="imageInput" accept="image/*" multiple required />
    <div id="previewContainer"></div>

    <textarea name="description" placeholder="Description"></textarea>
    <button type="submit" id="submitBtn">Upload</button>
  </form>

  <script>
    const supabaseUrl = 'https://wbjwvxckbfkutqqbgupq.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indiand2eGNrYmZrdXRxcWJndXBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4NzU3NDEsImV4cCI6MjA2OTQ1MTc0MX0.u_zwikgAryhF5Ccv5yOvjq20hzxE5tbYfKI04uTnNXw';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    const form = document.getElementById('vehicleForm');
    const imageInput = document.getElementById('imageInput');
    const previewContainer = document.getElementById('previewContainer');
    const submitBtn = document.getElementById('submitBtn');
    let imageUrls = [];

    imageInput.addEventListener('change', async () => {
      const files = imageInput.files;
      previewContainer.innerHTML = "";
      imageUrls = [];

      for (const file of files) {
        const imgTag = document.createElement('img');
        imgTag.src = URL.createObjectURL(file);
        imgTag.classList.add('preview');
        previewContainer.appendChild(imgTag);

        const filePath = `vehicle-${Date.now()}-${file.name}`;
        const { data, error } = await supabase.storage
          .from('vehicals')
          .upload(filePath, file);

        if (error) {
          alert("Image upload failed: " + error.message);
        } else {
          const { data: urlData } = supabase
            .storage
            .from('vehicals')
            .getPublicUrl(filePath);
          imageUrls.push(urlData.publicUrl);
        }
      }

      console.log("✅ Uploaded Images:", imageUrls);
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (imageUrls.length === 0) {
        alert("Please wait until all images are uploaded.");
        return;
      }

      submitBtn.disabled = true;
      submitBtn.innerText = "Uploading...";

      const formData = new FormData(form);
      const record = {
        category: formData.get('category'),
        brand: formData.get('brand'),
        model: formData.get('model'),
        year: parseInt(formData.get('year')),
        price: parseInt(formData.get('price')),
        city: formData.get('city'),
        fuel: formData.get('fuel'),
        condition: formData.get('condition'),
        ownership: formData.get('ownership'),
        rc: formData.get('rc'),
        image_urls: imageUrls, // ← array of links
        description: formData.get('description'),
      };

      const { error } = await supabase.from('vehicles').insert([record]);

      if (error) {
        alert("❌ Upload failed: " + error.message);
      } else {
        alert("✅ Vehicle uploaded successfully!");
        form.reset();
        previewContainer.innerHTML = "";
        imageUrls = [];
      }

      submitBtn.disabled = false;
      submitBtn.innerText = "Upload";
    });
  </script>
</body>
</html>
