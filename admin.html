<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Second Wheel — Admin</title>

<style>
body{font-family:system-ui;background:#f7f8fb;margin:0;padding:20px}
.panel{background:#fff;border:1px solid #ddd;border-radius:12px;padding:14px;margin-bottom:16px}
.list{display:grid;gap:10px}
.item{display:grid;grid-template-columns:1fr;gap:4px;padding:10px;border:1px solid #e5e7eb;border-radius:10px}
.item small{color:#6b7280}
input,textarea{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #d1d5db}
button{padding:10px 14px;border-radius:8px;border:none;cursor:pointer}
.primary{background:#f59e0b}
.danger{background:#ef4444;color:#fff}
</style>
</head>

<body>

<h2>Second Wheel — Admin</h2>

<!-- FEATURED LIST -->
<div class="panel">
  <h3>Featured Vehicles</h3>
  <div id="featuredList" class="list"></div>
</div>

<!-- EDITOR -->
<div class="panel">
  <b id="vidShow">VID: -</b>

  <input id="brand" placeholder="Brand">
  <input id="title" placeholder="Title / Model">
  <input id="price" type="number" placeholder="Price">
  <input id="year" type="number" placeholder="Year">
  <input id="km" type="number" placeholder="KM">
  <input id="owner" type="number" placeholder="Owner">

  <textarea id="desc" placeholder="Description"></textarea>

  <label><input type="checkbox" id="featured"> Featured</label><br><br>

  <button class="primary" id="btnSave">Save</button>
  <button class="danger" id="btnDelete">Delete</button>

  <div id="status"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ===== CONFIG ===== */
var SUPABASE_URL = 'https://wbjwvxckbfkutqqbgupq.supabase.co';
var SUPABASE_KEY = 'YOUR_ANON_KEY';
var BUCKET = 'vehicals';
var sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ===== ELEMENTS ===== */
const $ = id => document.getElementById(id);
const brand=$('brand'), title=$('title'), price=$('price'),
      year=$('year'), km=$('km'), owner=$('owner'),
      desc=$('desc'), featured=$('featured'),
      featuredList=$('featuredList'),
      vidShow=$('vidShow'), statusEl=$('status');

/* ===== KEEP YOUR ID LOGIC SAME ===== */
function makeVID(){
  return Date.now().toString().slice(-8);
}
let CURRENT_VID = makeVID();
vidShow.textContent = 'VID: ' + CURRENT_VID;

/* ===== SHORT DESCRIPTION HELPER (IMPORTANT FIX) ===== */
function shortDesc(txt){
  if(!txt) return '';
  return txt.length > 45 ? txt.slice(0,45) + '…' : txt;
}

/* ===== SAVE VEHICLE ===== */
async function saveVehicle(){

  if(owner.value < 1 || owner.value > 5){
    statusEl.textContent='Owner must be 1–5'; return;
  }
  if(price.value<=0 || year.value<1990){
    statusEl.textContent='Invalid price/year'; return;
  }

  let meta={
    vid: CURRENT_VID,
    brand: brand.value.trim().toUpperCase(),
    title: title.value.trim(),
    price:Number(price.value),
    year:Number(year.value),
    km:Number(km.value),
    owner:Number(owner.value),
    description: desc.value.trim() ||
      (year.value+' • '+km.value+' km • Owner '+owner.value),
    updatedAt:new Date().toISOString()
  };

  let blob=new Blob([JSON.stringify(meta,null,2)],{type:'application/json'});

  await sb.storage.from(BUCKET)
    .upload('car/'+CURRENT_VID+'/meta.json',blob,{upsert:true});

  if(featured.checked){
    await sb.storage.from(BUCKET)
      .upload('featured/'+CURRENT_VID+'/meta.json',blob,{upsert:true});
  }

  statusEl.textContent='Saved ✓';
  loadFeatured();
}

/* ===== LOAD FEATURED WITH SHORT DESCRIPTION ONLY ===== */
async function loadFeatured(){
  featuredList.innerHTML='';
  let {data}=await sb.storage.from(BUCKET).list('featured');
  if(!data) return;

  for(let f of data){
    let url=sb.storage.from(BUCKET)
      .getPublicUrl('featured/'+f.name+'/meta.json').data.publicUrl;

    let res=await fetch(url);
    if(!res.ok) continue;
    let m=await res.json();

    let div=document.createElement('div');
    div.className='item';
    div.innerHTML=`
      <b>${m.title}</b>
      <small>${m.brand} • ₹${m.price}</small>
      <small>${shortDesc(m.description)}</small>
    `;
    featuredList.appendChild(div);
  }
}

$('btnSave').onclick=saveVehicle;
loadFeatured();
</script>

</body>
</html>
