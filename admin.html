<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Second Wheel ‚Äî Admin (Featured & Inventory Manager)</title>
<meta name="theme-color" content="#ffffff"/>
<style>
  :root{
    --bg:#f7f8fb; --card:#ffffff; --text:#0b0f17; --muted:#5b667a;
    --brand:#f59e0b; --ok:#22c55e; --danger:#ef4444; --line:rgba(0,0,0,.12);
    --elev:0 8px 20px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  a{color:inherit;text-decoration:none}
  header{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
  .wrap{max-width:1200px;margin:0 auto;padding:14px 16px}
  h1{font-size:18px;margin:0 0 4px}
  .hint{color:var(--muted);font-size:12px}

  main .grid{display:grid;grid-template-columns:380px 1fr;gap:14px}
  @media(max-width:920px){main .grid{grid-template-columns:1fr}}

  .panel{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:var(--elev)}
  h2{font-size:16px;margin:0 0 10px}
  .rowbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between}
  .pill{padding:4px 10px;border-radius:999px;background:#f2f4f8;border:1px solid var(--line);font-size:12px}

  .filters{display:flex;gap:8px;flex-wrap:wrap}
  .input,.select{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#f2f4f8;color:var(--text);outline:none}

  .list{display:grid;gap:8px;max-height:62vh;overflow:auto}
  @media(max-width:920px){.list{max-height:none}}
  .item{display:grid;grid-template-columns:56px 1fr;gap:10px;padding:8px;border:1px solid var(--line);border-radius:12px;background:#fff;cursor:pointer;box-shadow:var(--elev)}
  .item:hover{background:#fcfcff}
  .thumb{width:56px;height:56px;border-radius:10px;object-fit:cover;background:#f2f4f8;border:1px solid var(--line)}
  .meta b{display:block}
  .meta small{color:var(--muted)}

  label{display:block;margin:8px 0 6px;color:var(--muted);font-weight:600}
  input,select,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:#f2f4f8;color:var(--text);outline:none}
  input:focus,select:focus,textarea:focus{border-color:#3b82f6;background:#fff}
  textarea{min-height:120px;resize:vertical}

  .fields{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  @media(max-width:920px){.fields{grid-template-columns:1fr 1fr}}
  @media(max-width:560px){.fields{grid-template-columns:1fr}}

  .btn{display:inline-flex;gap:8px;align-items:center;justify-content:center;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#ffffff;cursor:pointer;min-width:120px;box-shadow:var(--elev)}
  .btn:active{transform:translateY(1px)}
  .primary{background:linear-gradient(180deg,#f59e0b,#b45309);color:#111;border:none}
  .danger{background:linear-gradient(180deg,#ef4444,#b91c1c);color:#fff;border:none}
  .secondary{background:linear-gradient(180deg,#60a5fa,#2563eb);color:#fff;border:none}
  .ghost{background:#f2f4f8}
  .btnBlock{display:flex;gap:10px;flex-wrap:wrap}
  @media(max-width:560px){.btn{width:100%} .btnBlock{flex-direction:column}}

  .tick{appearance:none;width:20px;height:20px;border-radius:6px;border:1px solid var(--line);display:inline-grid;place-items:center;background:#f2f4f8;margin-right:8px}
  .tick:checked{background:#f59e0b;border-color:#f59e0b}

  .upl{border:1px dashed var(--line);border-radius:12px;padding:12px;background:#fff}
  .limit{color:var(--muted);font-size:12px}
  .status{min-height:20px;color:#374151;margin-top:6px}
  .status.ok{color:#15803d}
  .status.err{color:#b91c1c}

  .ghead{display:flex;justify-content:space-between;align-items:center;margin-top:12px;gap:8px;flex-wrap:wrap}
  .ggrid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px}
  @media(max-width:920px){.ggrid{grid-template-columns:repeat(3,1fr)}}
  @media(max-width:560px){.ggrid{grid-template-columns:repeat(2,1fr)}}
  .gcard{position:relative;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#fff;box-shadow:var(--elev)}
  .gcard img{width:100%;height:100px;object-fit:cover;display:block;cursor:pointer}
  .gact{position:absolute;right:6px;top:6px;display:flex;gap:6px}
  .icon{display:inline-grid;place-items:center;width:30px;height:30px;border-radius:8px;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.2);cursor:pointer;color:#fff}
  .sectionHead{margin-top:10px;font-weight:700;color:#374151}

  /* ====== PIN LOCK OVERLAY ====== */
  .lock{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(11,15,23,.88);z-index:9999;padding:20px}
  .lockCard{width:100%;max-width:380px;background:#111827;color:#e5e7eb;border:1px solid rgba(255,255,255,.12);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.4);padding:18px}
  .lockCard h3{margin:0 0 8px}
  .lockRow{display:flex;gap:8px;margin:10px 0}
  .pin{letter-spacing:8px;text-align:center;font-size:22px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:#0b1220;color:#e5e7eb;flex:1}
  .lockBtn{border:0;border-radius:12px;padding:12px 14px;cursor:pointer}
  .okBtn{background:#22c55e;color:#0b0f17}
  .xBtn{background:#374151;color:#e5e7eb}
  .lockHint{color:#9aa3b2;font-size:12px}
  .err{color:#fca5a5;font-size:13px;margin-top:6px;min-height:18px}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#f59e0b;color:#111;font-weight:800;font-size:12px;margin-left:6px}
  .logout{margin-left:auto}
</style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex;gap:10px;align-items:center;justify-content:space-between">
    <div>
      <h1>Second Wheel ‚Äî Admin <span class="badge">PIN</span></h1>
      <div class="hint">Featured control ‚Ä¢ Create/Update ‚Ä¢ Gallery upload/delete ‚Ä¢ Owner (only number) ‚Ä¢ Description syncs to Buy page</div>
    </div>
    <button id="btnLogout" class="btn ghost logout" title="Lock admin">üîí Logout</button>
  </div>
</header>

<main class="wrap" id="appMain" aria-hidden="true">
  <div class="grid">
    <!-- LEFT: Featured List -->
    <section class="panel">
      <div class="rowbar">
        <h2 style="margin:0">Featured List</h2>
        <button id="btnNew" class="btn ghost">+ New</button>
      </div>
      <div class="filters" style="margin:8px 0">
        <input id="q" class="input" placeholder="Search (title / brand)"/>
        <select id="fType" class="select">
          <option value="">All types</option>
          <option value="car">car</option>
          <option value="bike">bike</option>
          <option value="scooter">scooter</option>
        </select>
      </div>
      <div id="featuredList" class="list" aria-live="polite"></div>
    </section>

    <!-- RIGHT: Editor -->
    <section class="panel">
      <div class="rowbar">
        <h2 style="margin:0">Create / Edit</h2>
        <div class="pill"><span id="vidShow">VID: -</span></div>
      </div>

      <div class="fields">
        <div><label>Brand</label><input id="brand" placeholder="HYUNDAI"/></div>
        <div><label>Title / Model</label><input id="title" placeholder="i10 Sportz 2008"/></div>
        <div>
          <label>Type</label>
          <select id="type">
            <option value="car">car</option>
            <option value="bike">bike</option>
            <option value="scooter">scooter</option>
          </select>
        </div>
        <div><label>Price (‚Çπ)</label><input id="price" type="number" inputmode="numeric" placeholder="165000"/></div>
        <div><label>Year</label><input id="year" type="number" inputmode="numeric" placeholder="2008"/></div>
        <div><label>KM</label><input id="km" type="number" inputmode="numeric" placeholder="82000"/></div>
      </div>

      <label>Description</label>
      <textarea id="desc" placeholder="Well maintained single-owner vehicle with service history."></textarea>

      <div class="fields" style="margin-top:8px">
        <div><label>Owner (number)</label><input id="owner" type="number" inputmode="numeric" placeholder="1 for 1st owner"/></div>
      </div>

      <label style="display:flex;align-items:center;margin-top:10px">
        <input id="featured" type="checkbox" class="tick"/>
        <span>Mark as Featured (also write to <b>vehicals/featured/VID/</b>)</span>
      </label>

      <div class="upl" style="margin-top:12px">
        <div class="ghead">
          <label>Gallery</label>
          <label class="hint" style="display:flex;align-items:center;gap:6px">
            <input id="delBoth" type="checkbox"/>
            <span>Delete in BOTH (type + featured)</span>
          </label>
        </div>
        <input id="files" type="file" accept="image/*" multiple/>
        <div class="limit">Cars: up to 20 images ‚Ä¢ Bikes/Scooters: up to 10 images</div>
        <div class="btnBlock" style="margin-top:10px">
          <button id="btnUpload" class="btn secondary">‚Üë Upload Gallery</button>
          <button id="btnSave" class="btn primary">Save / Update</button>
          <button id="btnDelete" class="btn danger">Delete Vehicle</button>
        </div>
        <div id="status" class="status"></div>

        <div class="ghead">
          <strong>Gallery Preview</strong>
          <span class="hint" id="gHint">‚Äî</span>
        </div>
        <div id="gallery" class="ggrid"></div>
      </div>
    </section>
  </div>
</main>

<!-- PIN LOCK OVERLAY -->
<div id="lock" class="lock" role="dialog" aria-modal="true">
  <div class="lockCard">
    <h3>Admin PIN ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï</h3>
    <div class="lockHint">Enter your 4‚Äì8 digit PIN to continue.</div>
    <div class="lockRow"><input id="pinInput" class="pin" maxlength="8" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" type="password" inputmode="numeric" autocomplete="off"/></div>
    <div class="lockRow">
      <button id="pinSubmit" class="lockBtn okBtn">Unlock</button>
      <button id="pinClear" class="lockBtn xBtn">Clear</button>
    </div>
    <div id="pinErr" class="err"></div>
    <div class="lockHint" id="pinInfo"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ---------- SIMPLE PIN GATE (client-side) ---------- */
var ADMIN_PIN = '1008';            // <- ‡§§‡•Å‡§Æ‡§ö‡§æ PIN
var MAX_ATTEMPTS = 5;
var LOCK_MINUTES = 5;

var lockEl = document.getElementById('lock');
var appMain = document.getElementById('appMain');
var pinInput = document.getElementById('pinInput');
var pinSubmit = document.getElementById('pinSubmit');
var pinClear = document.getElementById('pinClear');
var pinErr = document.getElementById('pinErr');
var pinInfo = document.getElementById('pinInfo');
var btnLogout = document.getElementById('btnLogout');

function getAuthState(){
  var raw = localStorage.getItem('sw_admin_auth') || '{}';
  try { return JSON.parse(raw); } catch(e){ return {}; }
}
function setAuthState(obj){
  localStorage.setItem('sw_admin_auth', JSON.stringify(obj||{}));
}
function isLockedOut(st){ return !!(st && st.lockedUntil && Date.now() < st.lockedUntil); }
function showLockedMsg(st){
  var rem = Math.max(0, st.lockedUntil - Date.now());
  var mins = Math.ceil(rem/60000);
  pinErr.textContent = 'Too many attempts. Try again in ~' + mins + ' min.';
  pinInfo.textContent = 'Locked until: ' + new Date(st.lockedUntil).toLocaleTimeString();
}
function renderLock(){
  var st = getAuthState();
  if(st && st.ok){
    lockEl.style.display='none';
    appMain.removeAttribute('aria-hidden');
    return;
  }
  lockEl.style.display='flex';
  appMain.setAttribute('aria-hidden','true');
  pinInput.value='';
  pinInput.focus();
  pinErr.textContent='';
  if(isLockedOut(st)) showLockedMsg(st); else pinInfo.textContent='';
}
function tryUnlock(){
  var st = getAuthState();
  if(isLockedOut(st)){ showLockedMsg(st); return; }
  var val = String(pinInput.value||'').trim();
  if(!/^\d{4,8}$/.test(val)){ pinErr.textContent='Enter 4‚Äì8 digits.'; return; }
  if(val === ADMIN_PIN){
    setAuthState({ ok:true, attempts:0, lockedUntil:0, ts: Date.now() });
    renderLock();
    refreshFeatured();
    note('Ready.', true);
  }else{
    var attempts = (st.attempts||0)+1;
    var upd = { ok:false, attempts:attempts };
    if(attempts >= MAX_ATTEMPTS){ upd.lockedUntil = Date.now() + LOCK_MINUTES*60*1000; }
    setAuthState(upd);
    if(upd.lockedUntil){ showLockedMsg(upd); }
    else { pinErr.textContent = 'Wrong PIN ('+attempts+'/'+MAX_ATTEMPTS+').'; }
  }
}
function doLogout(){ setAuthState({ ok:false }); renderLock(); }

pinSubmit.onclick = tryUnlock;
pinClear.onclick = function(){ pinInput.value=''; pinErr.textContent=''; };
btnLogout.onclick = doLogout;
pinInput.addEventListener('keydown',function(e){ if(e.key==='Enter') tryUnlock(); });

renderLock();

/* ---------- CONFIG (Supabase) ---------- */
var SUPABASE_URL = 'https://wbjwvxckbfkutqqbgupq.supabase.co';
var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indiand2eGNrYmZrdXRxcWJndXBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4NzU3NDEsImV4cCI6MjA2OTQ1MTc0MX0.u_zwikgAryhF5Ccv5yOvjq20hzxE5tbYfKI04uTnNXw';
var BUCKET = 'vehicals';
var sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ---------- EL ---------- */
function $(id){ return document.getElementById(id); }
var featuredList = $('featuredList');
var brand = $('brand'), title = $('title'), price = $('price'), year = $('year'),
    km = $('km'), type = $('type'), desc = $('desc'), featured = $('featured'), owner = $('owner');
var files = $('files'); var statusEl = $('status'); var vidShow = $('vidShow');
var btnSave = $('btnSave'), btnDelete = $('btnDelete'), btnUpload = $('btnUpload'), btnNew = $('btnNew');
var q = $('q'), fType = $('fType');
var gallery = $('gallery'), gHint = $('gHint'), delBoth = $('delBoth');

/* ---------- STATE ---------- */
var CURRENT_VID = makeVID();
var FEATURED_CACHE = [];
updateVIDBadge();

/* ---------- UTIL ---------- */
function authGuard(){ var st=getAuthState(); if(!st.ok){ alert('Locked. Enter PIN.'); renderLock(); throw new Error('Not authenticated'); } }
function makeVID(){ var rand=Math.random().toString(36).slice(2,6); var ts=Date.now().toString(36).slice(-4); return ts+'-'+rand; }
function slugify(s){ return (s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
function note(msg, ok, err){ statusEl.textContent=msg; statusEl.className='status'; if(ok) statusEl.classList.add('ok'); if(err) statusEl.classList.add('err'); }
function updateVIDBadge(){ vidShow.textContent='VID: '+CURRENT_VID; }
function clearForm(){ authGuard(); brand.value=''; title.value=''; price.value=''; year.value=''; km.value=''; desc.value=''; owner.value=''; type.value='car'; featured.checked=false; files.value=''; CURRENT_VID=makeVID(); updateVIDBadge(); note('Ready.', true); renderGallery(); }
function pathFeatured(){ return 'featured/'+CURRENT_VID; }
function pathType(){ return type.value+'/'+CURRENT_VID; }
function pubUrl(path){ var out = sb.storage.from(BUCKET).getPublicUrl(path); return out && out.data ? out.data.publicUrl : ''; }
async function listKeys(prefix){ authGuard(); var resp = await sb.storage.from(BUCKET).list(prefix,{limit:200}); if(resp.error){ console.error(resp.error); return []; } return (resp.data||[]).filter(Boolean); }
async function removeFolder(prefix){ authGuard(); var entries=await listKeys(prefix); if(entries.length===0) return true; var keys=entries.map(function(f){ return prefix+'/'+f.name; }); var r=await sb.storage.from(BUCKET).remove(keys); if(r.error){ console.error('remove error',r.error); return false;} return true; }
async function uploadJSON(prefix,name,obj){ authGuard(); var blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'}); var r=await sb.storage.from(BUCKET).upload(prefix+'/'+name, blob, { upsert:true, contentType:'application/json' }); if(r.error){ console.error('meta write error',r.error); throw r.error; } }
function isImg(name){ return /\.(jpe?g|png|webp|avif)$/i.test(name); }

/* ---------- FEATURED LIST (LEFT) ---------- */
async function firstImageUrl(prefix){ var files=await listKeys(prefix); var img=files.filter(function(f){return isImg(f.name);}).sort(function(a,b){return a.name.localeCompare(b.name);})[0]; return img?pubUrl(prefix+'/'+img.name):''; }

async function refreshFeatured(){
  try{ authGuard(); }catch(e){ return; }
  featuredList.innerHTML='<div class="hint">Loading‚Ä¶</div>';
  var roots=await listKeys('featured');
  var folders=roots.filter(function(x){return x && x.name && !(/\./.test(x.name));});
  var items=[];
  for(var i=0;i<folders.length;i++){
    var f=folders[i];
    var vid=f.name;
    var metaPath='featured/'+vid+'/meta.json';
    var pub = sb.storage.from(BUCKET).getPublicUrl(metaPath);
    var meta=null;
    try{
      var res=await fetch(pub.data.publicUrl,{cache:'no-store'});
      if(res.ok){ meta=await res.json(); }
    }catch(e){}
    if(meta){
      var thumb = await firstImageUrl('featured/'+vid) || await firstImageUrl((meta.type||'car')+'/'+vid) || '';
      items.push({ vid:vid, meta:meta, thumb:thumb });
    }
  }
  items.sort(function(a,b){ return (b.meta&&b.meta.updatedAt||'').localeCompare(a.meta&&a.meta.updatedAt||''); });
  FEATURED_CACHE=items;
  renderFeaturedList();
}

function renderFeaturedList(){
  var term=(q.value||'').toLowerCase().trim();
  var tfilter=(fType.value||'').trim();
  var view=FEATURED_CACHE.filter(function(it){
    var hitQ = !term || ((it.meta.title||'').toLowerCase().includes(term) || (it.meta.brand||'').toLowerCase().includes(term));
    var hitT = !tfilter || (it.meta.type===tfilter);
    return hitQ && hitT;
  });
  featuredList.innerHTML='';
  if(view.length===0){ featuredList.innerHTML='<div class="hint">No results</div>'; return; }
  for(var i=0;i<view.length;i++){
    var it=view[i];
    var div=document.createElement('div');
    div.className='item';
    div.innerHTML='<img class="thumb" src="'+(it.thumb||'')+'" alt="">' +
      '<div class="meta"><b>'+ (it.meta.title||'-') +' <span class="pill">'+ (it.meta.type||'') +'</span></b>' +
      '<small>'+ String(it.meta.brand||'').toUpperCase() +' ‚Ä¢ ‚Çπ'+ (it.meta.price||'') +'</small></div>';
    div.onclick=(function(v,m){ return function(){ loadToForm(v,m); };})(it.vid,it.meta);
    featuredList.appendChild(div);
  }
}
q.addEventListener('input',renderFeaturedList);
fType.addEventListener('change',renderFeaturedList);

function loadToForm(vid, meta){
  try{ authGuard(); }catch(e){ return; }
  CURRENT_VID=vid; updateVIDBadge();
  brand.value=meta.brand||''; title.value=meta.title||'';
  price.value=meta.price||''; year.value=meta.year||''; km.value=meta.km||'';
  type.value=meta.type||'car'; desc.value=meta.description||'';
  owner.value=meta.owner||'';
  featured.checked=true;
  note('Loaded '+vid, true);
  renderGallery();
}

/* ---------- META WRITE & BUMP ---------- */
async function writeMeta(){
  var meta={
    vid: CURRENT_VID,
    brand: (brand.value||'').trim(),
    title: (title.value||'').trim(),
    price: Number(price.value)||0,
    year: Number(year.value)||0,
    km: Number(km.value)||0,
    owner: Number(owner.value)||0,
    type: type.value,
    description: (desc.value||'').trim(),
    updatedAt: new Date().toISOString()
  };
  await uploadJSON(pathType(),'meta.json',meta);
  if(featured.checked){ await uploadJSON(pathFeatured(),'meta.json',meta); }
  return meta;
}
async function bumpUpdatedAt(){
  try{
    var metaUrl = pubUrl(pathType()+'/meta.json');
    var res = await fetch(metaUrl,{cache:'no-store'});
    var base = res.ok ? await res.json() : { vid: CURRENT_VID, type: type.value };
    base.updatedAt = new Date().toISOString();
    await uploadJSON(pathType(),'meta.json',base);
    if(featured.checked){ await uploadJSON(pathFeatured(),'meta.json',base); }
  }catch(e){}
}

/* ---------- SAVE / UPDATE ---------- */
async function saveVehicle(){
  try{
    authGuard();
    note('Saving‚Ä¶');
    await writeMeta();
    if(!featured.checked){ await removeFolder(pathFeatured()); }
    note('Saved ‚úì', true);
    await refreshFeatured();
    await renderGallery();
  }catch(e){ console.error(e); note('Save failed: '+(e && e.message ? e.message : e), false, true); }
}

/* ---------- GALLERY HELPERS ---------- */
function maxAllowed(){ return (type.value==='car')?20:10; }
async function listImages(prefix){
  var arr=await listKeys(prefix);
  return arr.filter(function(f){return isImg(f.name);})
            .sort(function(a,b){return a.name.localeCompare(b.name);})
            .map(function(x){ return { name:x.name, url:pubUrl(prefix+'/'+x.name), path:prefix+'/'+x.name }; });
}
async function deleteFrom(folder, filename){
  authGuard();
  var path = (folder==='featured') ? (pathFeatured()+'/'+filename) : (pathType()+'/'+filename);
  var r = await sb.storage.from(BUCKET).remove([path]);
  if(r.error) throw r.error;
}
async function deleteBoth(filename){
  authGuard();
  var paths=[pathType()+'/'+filename, pathFeatured()+'/'+filename];
  var r = await sb.storage.from(BUCKET).remove(paths);
  if(r.error) throw r.error;
}

/* ---------- UPLOAD ---------- */
async function uploadGallery(){
  try{
    authGuard();
    var filesArr=Array.prototype.slice.call(files.files||[]);
    if(filesArr.length===0){ note('Select images first'); return; }
    var existing=await listImages(pathType());
    var max=maxAllowed();
    if(existing.length + filesArr.length > max){
      note('Too many images. Limit '+max+'. Existing '+existing.length+', you selected '+filesArr.length+'.', false, true);
      return;
    }
    note('Uploading images‚Ä¶');
    var ok=0, fail=0, i=0;
    for(var k=0;k<filesArr.length;k++){
      var f=filesArr[k];
      var clean=slugify(f.name);
      i++; var fname=Date.now()+'-'+i+'-'+clean;
      var targets=[pathType()+'/'+fname];
      if(featured.checked) targets.push(pathFeatured()+'/'+fname);
      for(var t=0;t<targets.length;t++){
        var key=targets[t];
        var r=await sb.storage.from(BUCKET).upload(key, f, { upsert:true, contentType:f.type||'image/jpeg' });
        if(r.error){ fail++; console.error('upload error',key,r.error); } else { ok++; }
      }
    }
    note('Gallery uploaded: '+ok+' ok, '+fail+' failed.', fail===0, fail>0);
    await bumpUpdatedAt();
    await renderGallery();
  }catch(e){ note('Upload failed: '+(e && e.message ? e.message : e), false, true); }
}

/* ---------- RENDER GALLERY (SECTIONS + TAP TO DELETE) ---------- */
async function renderGallery(){
  try{ authGuard(); }catch(e){ return; }
  gallery.innerHTML='';
  var typePrefix=pathType();
  var featPrefix=pathFeatured();

  var typeImgs=await listImages(typePrefix);
  var featImgs=await listImages(featPrefix);

  var blocks=[];
  if(typeImgs.length) blocks.push({ title:(type.value.toUpperCase()+' ¬∑ '+typeImgs.length), src:'type', items:typeImgs });
  if(featImgs.length) blocks.push({ title:('FEATURED ¬∑ '+featImgs.length), src:'featured', items:featImgs });

  gHint.textContent = blocks.length ? blocks.map(function(b){return b.title;}).join('  |  ') : 'No images yet';
  if(!blocks.length) return;

  for(var b=0;b<blocks.length;b++){
    var block=blocks[b];
    var head=document.createElement('div');
    head.className='sectionHead';
    head.textContent = block.title + (block.src==='featured' ? ' (tap deletes from FEATURED)' : ' (tap deletes from TYPE)');
    gallery.appendChild(head);

    for(var j=0;j<block.items.length;j++){
      var im=block.items[j];
      var card=document.createElement('div');
      card.className='gcard';
      card.innerHTML='<img src="'+im.url+'" alt="">' +
        '<div class="gact"><a class="icon" href="'+im.url+'" target="_blank" title="Open">üîç</a>' +
        '<button class="icon" title="Delete">üóëÔ∏è</button></div>';

      var doDelete = (function(blockRef, imRef){
        return async function(){
          try{
            authGuard();
            var both = !!(delBoth && delBoth.checked);
            var msg = 'Delete this image from ' + (both ? 'BOTH (type+featured)' : blockRef.src.toUpperCase()) + '?';
            if(!confirm(msg)) return;
            if(both) await deleteBoth(imRef.name); else await deleteFrom(blockRef.src, imRef.name);
            await bumpUpdatedAt();
            await renderGallery();
          }catch(e){ alert('Delete failed: '+(e && e.message ? e.message : e)); }
        };
      })(block, im);

      card.querySelector('img').onclick = doDelete;
      card.querySelector('button').onclick = doDelete;

      gallery.appendChild(card);
    }
  }
}

/* ---------- DELETE VEHICLE ---------- */
async function deleteVehicle(){
  try{
    authGuard();
    if(!confirm('Delete this vehicle from featured & buy folders?')) return;
    note('Deleting‚Ä¶');
    await removeFolder(pathType());
    await removeFolder(pathFeatured());
    note('Deleted ‚úì', true);
    clearForm();
    refreshFeatured();
  }catch(e){ note('Delete failed: '+(e && e.message ? e.message : e), false, true); }
}

/* ---------- NEW / EVENTS ---------- */
btnNew.onclick = function(){ try{ clearForm(); }catch(e){} };
btnSave.onclick = function(){ try{ saveVehicle(); }catch(e){} };
btnUpload.onclick = function(){ try{ uploadGallery(); }catch(e){} };
btnDelete.onclick = function(){ try{ deleteVehicle(); }catch(e){} };

/* ---------- INIT (data loads after PIN unlock) ---------- */
</script>
</body>
</html>
