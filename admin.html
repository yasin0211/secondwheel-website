<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Second Wheel – Admin Panel</title>

<style>
body{margin:0;font-family:system-ui;background:#f3f4f6}
.wrap{max-width:1200px;margin:auto;padding:16px}
.card{background:#fff;border-radius:14px;padding:16px;margin-bottom:16px;
box-shadow:0 8px 20px rgba(0,0,0,.08)}

input,select,textarea{
  width:100%;padding:10px;border-radius:8px;
  border:1px solid #d1d5db;margin-bottom:10px
}

button{
  padding:8px 14px;border-radius:8px;border:none;cursor:pointer
}
.primary{background:#f59e0b}
.secondary{background:#2563eb;color:#fff}
.danger{background:#ef4444;color:#fff}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:10px
}

/* IMAGE PREVIEW */
.imgGrid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(90px,1fr));
  gap:8px
}
.imgBox{
  position:relative;
  border-radius:8px;
  overflow:hidden
}
.imgBox img{
  width:100%;
  height:80px;
  object-fit:cover
}
.imgBox button{
  position:absolute;
  top:4px;
  right:4px;
  padding:4px 6px;
  font-size:12px;
  border-radius:6px
}

/* LOGIN */
.login{
  position:fixed;inset:0;
  background:#111827;
  display:flex;align-items:center;justify-content:center
}
.hide{display:none}
.login .card{max-width:360px;width:100%}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="login" id="loginBox">
  <div class="card">
    <h3>Admin Login</h3>
    <input id="pin" type="password" placeholder="Enter PIN">
    <button class="primary" onclick="unlock()">Unlock</button>
    <small id="err"></small>
  </div>
</div>

<div class="wrap hide" id="admin">

<h2>Second Wheel – Admin Panel</h2>

<div class="card">
<b id="vidShow"></b><br><br>

<select id="type">
  <option value="car">Car</option>
  <option value="bike">Bike</option>
  <option value="scooter">Scooter</option>
</select>

<div class="grid">
  <input id="brand" placeholder="Brand">
  <input id="title" placeholder="Title">
  <input id="model" placeholder="Model">
  <input id="year" type="number" placeholder="Year">
  <input id="km" type="number" placeholder="KM">
  <input id="price" type="number" placeholder="Price">
</div>

<textarea id="desc" placeholder="Description"></textarea>
<label><input type="checkbox" id="featured"> Featured</label>

<hr>

<input type="file" id="files" multiple accept="image/*">
<button class="secondary" onclick="uploadImages()">Upload Images</button>

<div class="imgGrid" id="preview"></div>

<hr>

<button class="primary" onclick="saveVehicle()">Save Vehicle</button>
<button class="danger" onclick="deleteVehicle()">Delete Vehicle</button>

<small id="status"></small>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ================= CONFIG ================= */
const ADMIN_PIN="1008";

const SUPABASE_URL="https://wbjwvxckbfkutqqbgupq.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indiand2eGNrYmZrdXRxcWJndXBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4NzU3NDEsImV4cCI6MjA2OTQ1MTc0MX0.u_zwikgAryhF5Ccv5yOvjq20hzxE5tbYfKI04uTnNXw";
const BUCKET="vehicals";

const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
const $=id=>document.getElementById(id);

/* ================= STATE ================= */
let CURRENT_VID=Date.now().toString().slice(-8);
vidShow.textContent="VID: "+CURRENT_VID;

/* ================= LOGIN ================= */
function unlock(){
  if(pin.value===ADMIN_PIN){
    loginBox.style.display="none";
    admin.classList.remove("hide");
  }else err.textContent="Wrong PIN";
}

/* ================= IMAGE UPLOAD (FIXED) ================= */
async function uploadImages(){
  if(!files.files.length){
    alert("Select images first");
    return;
  }

  for(let i=0;i<files.files.length;i++){
    const f=files.files[i];
    const name=Date.now()+"-"+i+"-"+f.name.replace(/\s+/g,'-');
    const path=`${type.value}/${CURRENT_VID}/${name}`;

    const {error}=await sb.storage
      .from(BUCKET)
      .upload(path,f,{upsert:true,contentType:f.type});

    if(error){
      alert("Upload failed");
      console.error(error);
      return;
    }
  }

  files.value="";
  loadPreview();
}

/* ================= IMAGE PREVIEW ================= */
async function loadPreview(){
  preview.innerHTML="";
  const {data}=await sb.storage
    .from(BUCKET)
    .list(`${type.value}/${CURRENT_VID}`);

  if(!data) return;

  data.filter(f=>!f.name.endsWith(".json")).forEach(f=>{
    const url=sb.storage
      .from(BUCKET)
      .getPublicUrl(`${type.value}/${CURRENT_VID}/${f.name}`).data.publicUrl;

    const box=document.createElement("div");
    box.className="imgBox";
    box.innerHTML=`
      <img src="${url}">
      <button class="danger">✕</button>
    `;

    box.querySelector("button").onclick=async()=>{
      await sb.storage
        .from(BUCKET)
        .remove([`${type.value}/${CURRENT_VID}/${f.name}`]);
      loadPreview();
    };

    preview.appendChild(box);
  });
}

/* ================= SAVE META ================= */
async function saveVehicle(){
  const meta={
    vid:CURRENT_VID,
    type:type.value,
    brand:brand.value,
    title:title.value,
    model:model.value,
    year:+year.value,
    km:+km.value,
    price:+price.value,
    description:desc.value,
    featured:featured.checked,
    updatedAt:new Date().toISOString()
  };

  const blob=new Blob([JSON.stringify(meta,null,2)],{type:"application/json"});

  await sb.storage.from(BUCKET)
    .upload(`${type.value}/${CURRENT_VID}/meta.json`,blob,{upsert:true});

  if(featured.checked){
    await sb.storage.from(BUCKET)
      .upload(`featured/${CURRENT_VID}/meta.json`,blob,{upsert:true});
  }

  status.textContent="Saved ✓";
}

/* ================= DELETE VEHICLE ================= */
async function deleteVehicle(){
  if(!confirm("Delete vehicle permanently?")) return;

  async function del(path){
    const {data}=await sb.storage.from(BUCKET).list(path);
    if(data?.length){
      await sb.storage.from(BUCKET)
        .remove(data.map(f=>path+"/"+f.name));
    }
  }

  await del(`${type.value}/${CURRENT_VID}`);
  await del(`featured/${CURRENT_VID}`);

  CURRENT_VID=Date.now().toString().slice(-8);
  vidShow.textContent="VID: "+CURRENT_VID;
  preview.innerHTML="";
  status.textContent="Deleted ✓";
}
</script>
</body>
</html>
