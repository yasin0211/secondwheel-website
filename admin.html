<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Panel | Second Wheel</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:system-ui;background:#f7f8fb;margin:0;padding:16px}
h2{margin-top:0}
.card{background:#fff;padding:16px;border-radius:14px;max-width:1000px;margin:auto}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:700px){.grid{grid-template-columns:1fr}}
input,select,textarea{
  width:100%;padding:10px;border-radius:10px;border:1px solid #ccc
}
button{
  padding:12px;border:none;border-radius:999px;
  background:#f59e0b;font-weight:700;cursor:pointer
}
button.danger{background:#dc2626;color:#fff}
.images{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.images div{position:relative}
.images img{width:90px;height:70px;object-fit:cover;border-radius:8px}
.images span{
  position:absolute;top:-6px;right:-6px;
  background:#dc2626;color:#fff;
  border-radius:999px;padding:2px 6px;font-size:12px;
  cursor:pointer
}
.list div{
  border:1px solid #ddd;padding:8px;margin-top:6px;
  display:flex;justify-content:space-between;align-items:center
}
.topbar{display:flex;justify-content:space-between;align-items:center}
.logout{background:#111;color:#fff}
</style>
</head>

<body>

<div class="card">
  <div class="topbar">
    <h2>ðŸš˜ Vehicle Manager</h2>
    <button class="logout" onclick="logout()">Logout</button>
  </div>

  <div class="grid">
    <select id="type" onchange="genId()">
      <option value="car">Car</option>
    </select>

    <input id="vid" readonly placeholder="Vehicle ID">
    <input id="title" placeholder="Title">
    <input id="brand" placeholder="Brand">
    <input id="year" type="number" placeholder="Year">
    <input id="km" type="number" placeholder="KM">
    <input id="price" type="number" placeholder="Price">
  </div>

  <textarea id="desc" placeholder="Full Description"></textarea>

  <label>
    <input type="checkbox" id="featured"> Featured Vehicle
  </label>

  <input id="featured_note" placeholder="Featured short description">

  <hr>

  <input id="images" type="file" multiple accept="image/*">
  <div class="images" id="imgBox"></div>

  <br>
  <button onclick="save()">Save / Update</button>
  <button class="danger" onclick="removeVehicle()">Delete Vehicle</button>

  <hr>
  <h3>ðŸ“‹ Existing Vehicles</h3>
  <div class="list" id="list"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const sb = supabase.createClient(
  "https://wbjwvxckbfkutqqbgupq.supabase.co",
  "sb_publishable_QjJXmzREzdg3qB6dbfG-1A_0jLQNt66"
);

const BUCKET="vehicals";
const MAX_IMAGES=20;
const $=id=>document.getElementById(id);

/* LOGIN CHECK */
(async()=>{
  const { data } = await sb.auth.getSession();
  if(!data.session){
    location.href="login.html"; return;
  }
  genId();
  loadList();
})();

/* AUTO ID */
async function genId(){
  const {count}=await sb.from("vehicles")
    .select("*",{count:"exact",head:true})
    .eq("type","car");
  vid.value="SWC"+String(count+1).padStart(3,"0");
}

/* IMAGE LIMIT */
images.onchange=()=>{
  if(images.files.length>MAX_IMAGES){
    alert("Max 20 images"); images.value="";
  }
};

/* SAVE */
async function save(){
  const payload={
    vid:vid.value,
    type:"car",
    title:title.value,
    brand:brand.value,
    year:year.value,
    km:km.value,
    price:price.value,
    description:desc.value,
    featured:featured.checked,
    featured_note:featured_note.value
  };

  await sb.from("vehicles").upsert(payload,{onConflict:"vid"});

  // ðŸ”¥ CORRECT PATH
  const base=`car/car/${vid.value}`;

  for(let i=0;i<images.files.length;i++){
    const name=i===0?"cover.jpg":`${Date.now()}_${i}.jpg`;
    await sb.storage.from(BUCKET).upload(
      `${base}/${name}`,
      images.files[i],
      {upsert:true}
    );
  }

  alert("Saved âœ…");
  loadList();
}

/* LOAD LIST */
async function loadList(){
  list.innerHTML="";
  const {data}=await sb.from("vehicles")
    .select("*").order("created_at",{ascending:false});

  data.forEach(v=>{
    const d=document.createElement("div");
    d.innerHTML=`${v.vid} - ${v.title}
      <button onclick="edit('${v.vid}')">Edit</button>`;
    list.appendChild(d);
  });
}

/* EDIT */
async function edit(v){
  const {data}=await sb.from("vehicles")
    .select("*").eq("vid",v).single();

  vid.value=data.vid;
  title.value=data.title;
  brand.value=data.brand;
  year.value=data.year;
  km.value=data.km;
  price.value=data.price;
  desc.value=data.description;
  featured.checked=data.featured;
  featured_note.value=data.featured_note||"";

  loadImages(v);
}

/* LOAD IMAGES */
async function loadImages(v){
  imgBox.innerHTML="";
  const {data}=await sb.storage.from(BUCKET).list(`car/car/${v}`);
  if(!data) return;

  data.forEach(f=>{
    if(!f.name.match(/\.(jpg|jpeg|png)$/i))return;
    const url=sb.storage.from(BUCKET)
      .getPublicUrl(`car/car/${v}/${f.name}`).data.publicUrl;

    const wrap=document.createElement("div");
    wrap.innerHTML=`<img src="${url}">
      <span onclick="delImg('${v}','${f.name}')">âœ•</span>`;
    imgBox.appendChild(wrap);
  });
}

/* DELETE IMAGE */
async function delImg(v,n){
  if(confirm("Delete image?")){
    await sb.storage.from(BUCKET)
      .remove([`car/car/${v}/${n}`]);
    loadImages(v);
  }
}

/* DELETE VEHICLE */
async function removeVehicle(){
  if(!confirm("Delete vehicle?"))return;
  const v=vid.value;

  const {data}=await sb.storage.from(BUCKET).list(`car/car/${v}`);
  for(const f of data){
    await sb.storage.from(BUCKET)
      .remove([`car/car/${v}/${f.name}`]);
  }
  await sb.from("vehicles").delete().eq("vid",v);
  alert("Deleted");
  loadList();
}

/* LOGOUT */
async function logout(){
  await sb.auth.signOut();
  location.href="login.html";
}
</script>

</body>
</html>
