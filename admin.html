<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Second Wheel • Admin</title>
<style>
  :root{--bg:#0b0f17;--card:#111827;--ink:#e5e7eb;--line:rgba(255,255,255,.08);--brand:#f59e0b}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial}
  header{padding:14px 16px;background:#030712;font-weight:800;color:var(--brand)}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  .grid{display:grid;gap:16px}
  @media(min-width:860px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
  label{font-size:12px;color:#94a3b8;display:block;margin:6px 0 4px}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0f172a;color:var(--ink)}
  textarea{min-height:90px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  button{border:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));color:var(--ink);padding:10px 12px;border-radius:12px;cursor:pointer}
  .primary{background:linear-gradient(180deg,#f59e0b,#b45309);color:#111;border-color:transparent}
  .danger{border-color:#7f1d1d;background:linear-gradient(180deg,#dc2626,#991b1b);color:#fff}
  .muted{color:#9aa3b2}
  .list{display:grid;gap:10px;max-height:420px;overflow:auto}
  .item{border:1px solid var(--line);border-radius:10px;padding:10px;background:#0f172a;display:flex;gap:10px;align-items:center}
  .item img{width:80px;height:60px;object-fit:cover;border-radius:8px;background:#111}
  .tiny{font-size:12px}
  .pill{display:inline-flex;align-items:center;gap:8px}
</style>
</head>
<body>
<header>Admin Panel — Add / Delete / Featured Upload</header>
<div class="wrap">

  <!-- VID Control -->
  <div class="card">
    <div class="pill">
      <b>Current VID:</b> <span id="currVid" class="muted">—</span>
      <button onclick="newVid()">Create New VID</button>
      <button onclick="clearVid()">Reset VID</button>
      <button onclick="copyVid()">Copy VID</button>
    </div>
    <div class="tiny muted" style="margin-top:6px">
      VID = ऑटो जनरेटेड unique id (timestamp–title). ह्याच VID फोल्डरमध्ये files जातील: <code>vehicals/featured/&lt;VID&gt;/</code>
    </div>
  </div>

  <div class="grid">
    <!-- Left: Meta / Featured -->
    <div class="card">
      <h3 style="margin:0 0 8px">Vehicle Details</h3>
      <div class="row">
        <div>
          <label>Brand</label>
          <input id="brand" placeholder="Maruti Suzuki">
        </div>
        <div>
          <label>Title / Model</label>
          <input id="title" placeholder="Swift VXI 2016">
        </div>
      </div>
      <div class="row">
        <div>
          <label>Price</label>
          <input id="price" placeholder="₹3,45,000">
        </div>
        <div>
          <label>Year</label>
          <input id="year" placeholder="2016">
        </div>
      </div>
      <div class="row">
        <div>
          <label>KM</label>
          <input id="km" placeholder="38,500">
        </div>
        <div>
          <label>Type</label>
          <select id="type">
            <option value="">Select</option>
            <option value="car">Car</option>
            <option value="bike">Bike</option>
            <option value="scooter">Scooter</option>
          </select>
        </div>
      </div>

      <label>Description</label>
      <textarea id="desc" placeholder="Well maintained, single owner..."></textarea>

      <div style="margin-top:10px">
        <label class="pill">
          <input type="checkbox" id="featuredFlag"> Mark as Featured
        </label>
        <div class="tiny muted">हे ऑन ठेवल्यास <code>meta.json</code> मध्ये <code>featured: true</code> सेव्ह होईल.</div>
      </div>

      <div class="btns">
        <button class="primary" onclick="saveVehicle()">Save / Update Vehicle</button>
        <button class="" onclick="loadMeta()">Load meta (from VID)</button>
      </div>
      <div class="btns">
        <button class="danger" onclick="deleteVehicle()">Delete Vehicle (folder)</button>
      </div>
      <div class="muted tiny" style="margin-top:6px">Delete Vehicle: त्या VID फोल्डरमधील सर्व images + meta.json delete होतील.</div>
    </div>

    <!-- Right: Gallery -->
    <div class="card">
      <h3 style="margin:0 0 8px">Gallery Upload</h3>
      <label>Images (multiple)</label>
      <input id="images" type="file" accept="image/*" multiple>
      <div class="btns">
        <button onclick="uploadImages()">Upload Images</button>
        <button onclick="refreshList()">Refresh List</button>
      </div>
      <div class="list" id="galList"><div class="muted">No items</div></div>
    </div>
  </div>

  <!-- All existing featured folders -->
  <div class="card">
    <h3 style="margin:0 0 8px">All Featured Vehicles (Storage)</h3>
    <div id="allList" class="list"><div class="muted">Loading…</div></div>
  </div>

</div>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ====== Config ====== */
const SUPABASE_URL = 'https://wbjwvxckbfkutqqbgupq.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indiand2eGNrYmZrdXRxcWJndXBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4NzU3NDEsImV4cCI6MjA2OTQ1MTc0MX0.u_zwikgAryhF5Ccv5yOvjq20hzxE5tbYfKI04uTnNXw';
const BUCKET = 'vehicals';                // <- बकेट spelling तसंच
const ROOT = 'featured';                  // <- सर्व फाईल्स इथेच जातील (upload = “featured मध्ये”)
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ====== VID helpers ====== */
const VID_KEY = 'sw_current_vid';
const currVidEl = document.getElementById('currVid');
function sluggify(s){return String(s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');}
function setVid(id){ localStorage.setItem(VID_KEY,id); currVidEl.textContent=id||'—'; }
function getVid(){ return localStorage.getItem(VID_KEY)||''; }
function newVid(){
  const base = sluggify(document.getElementById('title').value || document.getElementById('brand').value || 'vehicle');
  const id = `${Date.now()}-${base||'item'}`;
  setVid(id); alert('VID: '+id);
}
function clearVid(){ localStorage.removeItem(VID_KEY); setVid(''); }
function copyVid(){ const id=getVid(); if(!id) return; navigator.clipboard.writeText(id); alert('Copied: '+id); }

/* ====== Meta (Add/Update/Load/Delete) ====== */
async function saveVehicle(){
  let vid = getVid();
  if(!vid){ newVid(); vid = getVid(); }
  const meta = {
    title: document.getElementById('title').value.trim(),
    brand: document.getElementById('brand').value.trim(),
    price: document.getElementById('price').value.trim(),
    year:  document.getElementById('year').value.trim(),
    km:    document.getElementById('km').value.trim(),
    type:  document.getElementById('type').value,
    description: document.getElementById('desc').value.trim(),
    featured: document.getElementById('featuredFlag').checked === true
  };
  const blob = new Blob([JSON.stringify(meta,null,2)], {type:'application/json'});
  const path = `${ROOT}/${vid}/meta.json`;
  const { error } = await sb.storage.from(BUCKET).upload(path, blob, {upsert:true, contentType:'application/json', cacheControl:'3600'});
  if(error){ alert('Meta upload failed: '+error.message); console.error(error); }
  else { alert('Saved ✅'); refreshList(); loadAll(); }
}

async function loadMeta(){
  const vid = getVid();
  if(!vid){ alert('VID नाही. आधी Create New VID करा किंवा सूचीमधून एक निवडा.'); return; }
  const res = await sb.storage.from(BUCKET).download(`${ROOT}/${vid}/meta.json`);
  if(res.error){ alert('meta.json सापडला नाही. आधी Save Vehicle करा.'); return; }
  try{
    const m = JSON.parse(await res.data.text());
    document.getElementById('title').value = m.title || '';
    document.getElementById('brand').value = m.brand || '';
    document.getElementById('price').value = m.price || '';
    document.getElementById('year').value  = m.year  || '';
    document.getElementById('km').value    = m.km    || '';
    document.getElementById('type').value  = m.type  || '';
    document.getElementById('desc').value  = m.description || '';
    document.getElementById('featuredFlag').checked = !!m.featured;
    alert('Loaded meta ✅');
  }catch(e){ alert('meta.json parse error'); }
}

async function deleteVehicle(){
  const vid = getVid();
  if(!vid){ alert('VID निवडा'); return; }
  if(!confirm(`Delete vehicle folder?\n${ROOT}/${vid}`)) return;
  // फोल्डरमधले सर्व files मिळवा आणि delete करा
  const { data, error } = await sb.storage.from(BUCKET).list(`${ROOT}/${vid}`, {limit: 1000});
  if(error){ alert('List error'); return; }
  const paths = (data||[]).map(f => `${ROOT}/${vid}/${f.name}`);
  if(paths.length){
    const { error:delErr } = await sb.storage.from(BUCKET).remove(paths);
    if(delErr){ alert('Delete failed: '+delErr.message); return; }
  }
  // रिकामे फोल्डर आपोआप हटत नाही—काही हरकत नाही.
  alert('Vehicle deleted ✅');
  clearVid(); refreshList(); loadAll();
}

/* ====== Images (Upload/List/Delete) ====== */
async function uploadImages(){
  const vid = getVid();
  if(!vid){ alert('पहिले Save Vehicle करा (VID तयार होईल)'); return; }
  const files = document.getElementById('images').files;
  if(!files.length){ alert('Images निवडा'); return; }
  for(const f of files){
    const p = `${ROOT}/${vid}/${f.name}`;
    const { error } = await sb.storage.from(BUCKET).upload(p, f, {upsert:true, contentType:f.type||'application/octet-stream', cacheControl:'3600'});
    if(error){ console.error('IMG FAIL', p, error.message); }
  }
  alert('Uploads done ✅'); refreshList();
}

async function refreshList(){
  const vid = getVid(); const box = document.getElementById('galList');
  if(!vid){ box.innerHTML='<div class="muted">No VID</div>'; return; }
  const { data, error } = await sb.storage.from(BUCKET).list(`${ROOT}/${vid}`, {limit:200});
  if(error){ box.innerHTML='<div class="muted">Error listing</div>'; return; }
  const imgs = (data||[]).filter(x=>/\.(jpg|jpeg|png|webp)$/i.test(x.name));
  if(!imgs.length){ box.innerHTML='<div class="muted">No images yet</div>'; return; }
  box.innerHTML = imgs.map(f=>{
    const url = sb.storage.from(BUCKET).getPublicUrl(`${ROOT}/${vid}/${f.name}`).data.publicUrl;
    return `<div class="item">
      <img src="${url}" alt="${f.name}">
      <div style="flex:1">${f.name}<div class="tiny muted">${ROOT}/${vid}/${f.name}</div></div>
      <button class="danger tiny" onclick="deleteImage('${f.name}')">Delete</button>
    </div>`;
  }).join('');
}

async function deleteImage(fileName){
  const vid = getVid(); if(!vid) return;
  if(!confirm(`Delete image?\n${fileName}`)) return;
  const path = `${ROOT}/${vid}/${fileName}`;
  const { error } = await sb.storage.from(BUCKET).remove([path]);
  if(error){ alert('Delete failed: '+error.message); }
  else { refreshList(); }
}

/* ====== All folders list (pick VID quickly) ====== */
const allList = document.getElementById('allList');
async function loadAll(){
  allList.innerHTML='<div class="muted">Loading…</div>';
  const { data, error } = await sb.storage.from(BUCKET).list(ROOT, {limit:500, sortBy:{column:'name', order:'desc'}});
  if(error){ allList.innerHTML='<div class="muted">Error</div>'; return; }
  const folders = (data||[]).filter(x=>x && !(/\./.test(x.name))).map(x=>x.name);
  if(!folders.length){ allList.innerHTML='<div class="muted">No vehicles</div>'; return; }

  const rows = [];
  for(const id of folders){
    // first image (preview)
    const files = await sb.storage.from(BUCKET).list(`${ROOT}/${id}`, {limit:200});
    let url=''; if(!files.error){
      const pic = (files.data||[]).find(f=>/\.(jpg|jpeg|png|webp)$/i.test(f.name));
      if(pic){ url = sb.storage.from(BUCKET).getPublicUrl(`${ROOT}/${id}/${pic.name}`).data.publicUrl; }
    }
    // title from meta (optional)
    let title = id, brand='', price='';
    const metaTry = await sb.storage.from(BUCKET).download(`${ROOT}/${id}/meta.json`);
    if(!metaTry.error){ try{ const m = JSON.parse(await metaTry.data.text()); title = m.title||id; brand=m.brand||''; price=m.price||''; }catch{} }

    rows.push(`<div class="item">
      <img src="${url||'data:image/svg+xml,<svg xmlns=%27http://www.w3.org/2000/svg%27 width=%2780%27 height=%2760%27><rect width=%2780%27 height=%2760%27 fill=%27%23111827%27/></svg>'}">
      <div style="flex:1">
        <div><b>${title}</b></div>
        <div class="tiny muted">${brand} ${price}</div>
        <div class="tiny">
          <button onclick="setVid('${id}'); refreshList(); window.scrollTo({top:0,behavior:'smooth'})">Use this VID</button>
          <button onclick="setVid('${id}'); loadMeta();">Load meta</button>
        </div>
      </div>
    </div>`);
  }
  allList.innerHTML = rows.join('');
}

/* ====== Init ====== */
(function init(){
  setVid(getVid());
  refreshList();
  loadAll();
})();
</script>
</body>
</html>
