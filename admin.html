<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Second Wheel ‚Äì Admin Panel (Final)</title>

<style>
/* ================= BASIC UI (UNCHANGED) ================= */
body{margin:0;font-family:system-ui;background:#f3f4f6}
.wrap{max-width:1200px;margin:auto;padding:16px}
.card{background:#fff;border-radius:14px;padding:16px;margin-bottom:16px;
box-shadow:0 8px 20px rgba(0,0,0,.08)}
input,textarea,select{width:100%;padding:10px;border-radius:8px;
border:1px solid #d1d5db;margin-bottom:10px}
button{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
.primary{background:#f59e0b}
.secondary{background:#2563eb;color:#fff}
.danger{background:#ef4444;color:#fff}
.badge{background:#facc15;padding:2px 8px;border-radius:999px;font-size:12px}
.hide{display:none}

.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px}
.stat{background:#111827;color:#fff;border-radius:12px;padding:12px;text-align:center}

.listItem{border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-bottom:10px}
.listItem h4{margin:0 0 4px}
.listItem small{color:#6b7280}
.actions{margin-top:8px;display:flex;gap:8px}

/* Image preview grid */
.imgGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(90px,1fr));gap:8px}
.imgGrid div{position:relative}
.imgGrid img{width:100%;height:80px;object-fit:cover;border-radius:8px}
.imgGrid button{position:absolute;top:4px;right:4px}

/* LOGIN */
.login{position:fixed;inset:0;background:#111827;
display:flex;align-items:center;justify-content:center}
.login .card{max-width:360px;width:100%}
</style>
</head>

<body>

<!-- ================= LOGIN ================= -->
<div class="login" id="loginBox">
  <div class="card">
    <h3>Admin Login</h3>
    <input id="user" placeholder="Username">
    <input id="pass" type="password" placeholder="Password">
    <button class="primary" onclick="login()">Login</button>
    <small id="loginErr"></small>
  </div>
</div>

<div class="wrap hide" id="admin">

<h2>Second Wheel ‚Äì Admin Panel</h2>

<!-- ================= DASHBOARD ================= -->
<div class="card">
<h3>Dashboard</h3>
<div class="stats">
  <div class="stat">Cars<br><b id="cCars">0</b></div>
  <div class="stat">Bikes<br><b id="cBikes">0</b></div>
  <div class="stat">Scooters<br><b id="cScooters">0</b></div>
  <div class="stat">Featured<br><b id="cFeatured">0</b></div>
  <div class="stat">Sold<br><b id="cSold">0</b></div>
  <div class="stat">Total<br><b id="cTotal">0</b></div>
</div>
</div>

<!-- ================= FORM ================= -->
<div class="card">
<b id="vidShow"></b><br><br>

<select id="type">
  <option value="car">Car</option>
  <option value="bike">Bike</option>
  <option value="scooter">Scooter</option>
</select>

<div class="grid">
  <input id="brand" placeholder="Brand">
  <input id="title" placeholder="Title / Model">
  <input id="year" type="number" placeholder="Year">
  <input id="owner" type="number" placeholder="Owner">
  <input id="km" type="number" placeholder="KM">
  <input id="price" type="number" placeholder="Price">
</div>

<textarea id="desc" placeholder="Full Description (Buy page)"></textarea>
<textarea id="fdesc" placeholder="Featured Short Description (optional)"></textarea>

<label><input type="checkbox" id="featured"> Featured</label><br>
<label><input type="checkbox" id="sold"> Mark as SOLD</label><br><br>

<input type="file" id="images" multiple accept="image/*">

<button class="secondary" onclick="previewImages()">Preview Images</button>
<button class="secondary" onclick="uploadImages()">Upload Images</button>
<button class="primary" onclick="saveVehicle()">Save / Update</button>

<small id="status"></small>

<h4>Image Preview (drag to reorder)</h4>
<div id="preview" class="imgGrid"></div>
</div>

<!-- ================= BULK CSV ================= -->
<div class="card">
<h3>Bulk Upload (CSV)</h3>
<input type="file" id="csv" accept=".csv">
<button class="secondary" onclick="bulkUpload()">Upload CSV</button>
<button class="secondary" onclick="exportCSV()">Export Backup CSV</button>
<small>CSV: type,year,brand,title,price,km,owner,description,featured</small>
</div>

<!-- ================= VEHICLE LIST ================= -->
<div class="card">
<h3>Vehicle List</h3>
<input id="search" placeholder="Search">
<div id="vehicleList"></div>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ================= LOGIN ================= */
const ADMIN_USER="secondwheel";
const ADMIN_PASS="1008";

function login(){
  if(user.value===ADMIN_USER && pass.value===ADMIN_PASS){
    loginBox.style.display="none";
    admin.classList.remove("hide");
    loadAll();
  }else loginErr.textContent="Invalid login";
}

/* ================= SUPABASE ================= */
const SUPABASE_URL="https://wbjwvxckbfkutqqbgupq.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indiand2eGNrYmZrdXRxcWJndXBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4NzU3NDEsImV4cCI6MjA2OTQ1MTc0MX0.u_zwikgAryhF5Ccv5yOvjq20hzxE5tbYfKI04uTnNXw";
const BUCKET="vehicals";
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

const $=id=>document.getElementById(id);

/* ================= VID (YEAR-WISE) ================= */
async function generateVID(type,year){
  const key=`_counters/${type}_${year}.json`;
  let n=0;
  try{
    const url=sb.storage.from(BUCKET).getPublicUrl(key).data.publicUrl;
    const r=await fetch(url); if(r.ok){const j=await r.json(); n=j.last||0;}
  }catch(e){}
  let next=n+1;

  if(type==="bike") next=Math.min(99,next);
  if(type==="scooter") next=Math.max(100,next);
  if(type==="car") next=Math.max(1000,next);

  await sb.storage.from(BUCKET)
    .upload(key,new Blob([JSON.stringify({last:next})],{type:"application/json"}),{upsert:true});
  return year+""+next;
}

/* ================= IMAGE PREVIEW ================= */
let PREVIEW_FILES=[];
function previewImages(){
  preview.innerHTML="";
  PREVIEW_FILES=[...images.files];
  PREVIEW_FILES.forEach((f,i)=>{
    const d=document.createElement("div");
    d.draggable=true;
    const im=document.createElement("img");
    im.src=URL.createObjectURL(f);
    const b=document.createElement("button");
    b.textContent="‚úï"; b.className="danger";
    b.onclick=()=>{PREVIEW_FILES.splice(i,1);previewImages()};
    d.appendChild(im); d.appendChild(b);
    preview.appendChild(d);
  });
}

/* ================= UPLOAD ================= */
let CURRENT_VID=null;

async function uploadImages(){
  if(!CURRENT_VID){status.textContent="Save meta first";return;}
  let i=0;
  for(const f of PREVIEW_FILES){
    i++;
    await sb.storage.from(BUCKET)
      .upload(`${type.value}/${CURRENT_VID}/${String(i).padStart(3,"0")}-${f.name}`,f,{upsert:true});
  }
  status.textContent="Images uploaded";
}

/* ================= SAVE META ================= */
async function saveVehicle(){
  if(!CURRENT_VID){
    CURRENT_VID=await generateVID(type.value,year.value);
    vidShow.textContent="VID: "+CURRENT_VID;
  }
  const meta={
    vid:CURRENT_VID,
    type:type.value,
    brand:brand.value,
    title:title.value,
    year:+year.value,
    owner:+owner.value,
    km:+km.value,
    price:+price.value,
    description:desc.value,
    featuredDesc:fdesc.value||`${title.value} ${year.value}`,
    featured:featured.checked,
    sold:sold.checked,
    soldAt:sold.checked?new Date().toISOString():null,
    views:0,
    updatedAt:new Date().toISOString()
  };
  await sb.storage.from(BUCKET)
    .upload(`${type.value}/${CURRENT_VID}/meta.json`,
      new Blob([JSON.stringify(meta,null,2)],{type:"application/json"}),
      {upsert:true});
  if(featured.checked){
    await sb.storage.from(BUCKET)
      .upload(`featured/${CURRENT_VID}/meta.json`,
        new Blob([JSON.stringify(meta,null,2)],{type:"application/json"}),
        {upsert:true});
  }
  status.textContent="Saved ‚úì";
  loadAll();
}

/* ================= LOAD ALL + DASHBOARD ================= */
let ALL=[];
async function loadAll(){
  ALL=[];
  let counts={car:0,bike:0,scooter:0,featured:0,sold:0};
  for(const t of ["car","bike","scooter"]){
    const {data}=await sb.storage.from(BUCKET).list(t);
    if(!data) continue;
    for(const f of data){
      const url=sb.storage.from(BUCKET)
        .getPublicUrl(`${t}/${f.name}/meta.json`).data.publicUrl;
      const r=await fetch(url);
      if(!r.ok) continue;
      const m=await r.json();
      ALL.push(m);
      counts[t]++;
      if(m.featured) counts.featured++;
      if(m.sold) counts.sold++;
    }
  }
  cCars.textContent=counts.car;
  cBikes.textContent=counts.bike;
  cScooters.textContent=counts.scooter;
  cFeatured.textContent=counts.featured;
  cSold.textContent=counts.sold;
  cTotal.textContent=ALL.length;
  renderList();
}

/* ================= LIST ================= */
function renderList(){
  vehicleList.innerHTML="";
  ALL.filter(v=>v.title.toLowerCase().includes(search.value.toLowerCase()))
  .forEach(v=>{
    const d=document.createElement("div");
    d.className="listItem";
    d.innerHTML=`
      <h4>${v.title} ${v.sold?'<span class="badge">SOLD</span>':''}</h4>
      <small>${v.type.toUpperCase()} ‚Ä¢ ${v.brand} ‚Ä¢ ‚Çπ${v.price} ‚Ä¢ üëÅ ${v.views||0}</small>`;
    vehicleList.appendChild(d);
  });
}
search.oninput=renderList;

/* ================= CSV BULK ================= */
async function bulkUpload(){
  const f=csv.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=async()=>{
    const rows=r.result.split("\n").slice(1);
    for(const row of rows){
      const c=row.split(",");
      if(c.length<9) continue;
      CURRENT_VID=null;
      type.value=c[0]; year.value=c[1];
      brand.value=c[2]; title.value=c[3];
      price.value=c[4]; km.value=c[5];
      owner.value=c[6]; desc.value=c[7];
      featured.checked=c[8].trim().toLowerCase()==="yes";
      await saveVehicle();
    }
    alert("Bulk upload done");
  };
  r.readAsText(f);
}

/* ================= CSV EXPORT ================= */
function exportCSV(){
  let rows=["vid,type,year,brand,title,price,km,owner,featured,sold"];
  ALL.forEach(m=>{
    rows.push([m.vid,m.type,m.year,m.brand,m.title,m.price,m.km,m.owner,m.featured,m.sold].join(","));
  });
  const blob=new Blob([rows.join("\n")],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="secondwheel_backup.csv";
  a.click();
}
</script>

</body>
</html>
