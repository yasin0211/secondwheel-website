<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>SecondWheel Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  *{box-sizing:border-box} body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#f6f7fb;margin:0;color:#142033}
  header{background:#0a2c5f;color:#fff;padding:14px;text-align:center}
  .wrap{max-width:1100px;margin:18px auto;padding:0 14px}
  .card{background:#fff;border:1px solid #e6ebf3;border-radius:14px;padding:16px;margin-bottom:16px}
  .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  label{font-weight:600;font-size:.92rem;margin-bottom:4px;display:block}
  input,select,textarea{width:100%;padding:10px;border:1px solid #cfd6e4;border-radius:10px;background:#fff}
  textarea{min-height:80px;resize:vertical}
  .btn{background:#0a2c5f;color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn.ghost{background:#fff;color:#142033;border:1px solid #cfd6e4}
  .muted{color:#5a6b85;font-size:.9rem}
  .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .thumbs img{width:80px;height:60px;object-fit:cover;border-radius:8px;border:1px solid #e0e6ef}
  .hidden{display:none}
  .ok{color:#127c36} .err{color:#b00020}
  .pinbox{max-width:360px;margin:40px auto}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #eef1f6;padding:10px;text-align:left;font-size:.95rem;vertical-align:top}
  th{background:#f7f9fc}
  .pill{padding:3px 8px;border-radius:999px;font-size:.8rem;border:1px solid #cfd6e4;cursor:pointer}
  .pill.car{background:#e9f2ff;border-color:#9dc0ff}
  .pill.bike{background:#eaffef;border-color:#9ed9a8}
  .actions{display:flex;gap:6px;flex-wrap:wrap}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
</style>
</head>
<body>
<header><h2>SecondWheel Admin</h2></header>

<div class="wrap">
  <!-- PIN Gate -->
  <div id="gate" class="card pinbox">
    <label>Admin PIN</label>
    <input id="pin" type="password" placeholder="Enter PIN" />
    <button id="enterBtn" class="btn" style="margin-top:10px">Enter</button>
    <div class="muted" style="margin-top:6px">तात्पुरती सुरक्षा. पुढे Supabase Auth टाकू.</div>
  </div>

  <!-- Admin App -->
  <div id="app" class="hidden">

    <!-- Add / Edit form -->
    <div class="card">
      <h3 id="formTitle" style="margin:0 0 8px">Add Vehicle</h3>
      <div class="row">
        <input id="rowId" type="hidden">
        <div><label>Type</label>
          <select id="type"><option value="car">Car</option><option value="bike">Bike</option></select>
        </div>
        <div><label>Title</label><input id="title" placeholder="e.g., Swift Dzire VXI"></div>
        <div><label>Brand</label><input id="brand" placeholder="Maruti, Hyundai..."></div>
        <div><label>Model</label><input id="model" placeholder="i20 Sportz"></div>
        <div><label>Year</label><input id="year" type="number" placeholder="2016"></div>
        <div><label>KM</label><input id="km" type="number" placeholder="88000"></div>
        <div><label>City</label><input id="city" placeholder="Satara"></div>
        <div><label>Price (₹)</label><input id="price" type="number" placeholder="510000"></div>
        <div><label>Featured?</label>
          <select id="featured"><option value="">No</option><option value="true">Yes</option></select>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div>
          <label>Upload Images (max 8)</label>
          <input id="files" type="file" accept="image/*" multiple />
          <div class="muted">Bucket: <code id="bucketNameShow"></code></div>
          <div id="thumbs" class="thumbs"></div>
        </div>
        <div>
          <label>OR Image URLs (one per line)</label>
          <textarea id="imageUrls" placeholder="https://.../front.jpg
https://.../side.jpg"></textarea>
          <div class="muted">URLs दिले तर upload optional.</div>
        </div>
      </div>

      <!-- ✅ Description field added -->
      <div style="margin-top:12px">
        <label>Description</label>
        <textarea id="desc" placeholder="Extra details about the vehicle"></textarea>
      </div>

      <div style="margin-top:14px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button id="saveBtn" class="btn">Save</button>
        <button id="resetBtn" class="btn ghost">Reset</button>
        <span id="msg" class="muted"></span>
      </div>
    </div>

    <!-- Listing table -->
    <div class="card">
      <div class="toolbar">
        <h3 style="margin:0">All Vehicles</h3>
        <div class="muted" id="countNote"></div>
        <div class="spacer" style="flex:1"></div>
        <input id="q" placeholder="Search title/brand/model/city" style="min-width:220px">
        <select id="typeFilter">
          <option value="">All</option><option value="car">Cars</option><option value="bike">Bikes</option>
        </select>
        <button id="refreshBtn" class="btn ghost">Refresh</button>
      </div>
      <div style="overflow:auto">
        <table id="tbl">
          <thead>
            <tr>
              <th>Type</th>
              <th>Title</th>
              <th>City</th>
              <th>Year</th>
              <th>KM</th>
              <th>Price</th>
              <th>Featured</th>
              <th>Images</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"><tr><td colspan="9">Loading…</td></tr></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

  // ===== CONFIG: तुझ्या प्रोजेक्टनुसार बदल =====
  const SUPABASE_URL  = 'https://wbjwvxckbfkutqqbgupq.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indiand2eGNrYmZrdXRxcWJndXBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4NzU3NDEsImV4cCI6MjA2OTQ1MTc0MX0.u_zwikgAryhF5Ccv5yOvjq20hzxE5tbYfKI04uTnNXw';
  const BUCKET        = 'vehicals'; // तुमचा storage bucket
  const ADMIN_PIN     = '292955';   // बदला

  document.getElementById('bucketNameShow').textContent = BUCKET;
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON);

  // ===== STATE =====
  let allRows = [];
  const BIKE_HINTS = ['splendor','shine','activa','pulsar','duke','hf ','cb ','cbz','apache','hornet','fzs','jupiter','ntorq','scooty','xtreme','unicorn'];
  const CAR_HINTS  = ['alto','swift','dzire','i10','i20','creta','baleno','city','nexon','punch','verna','innova','xuv','thar','wagon','ciaz','venue','brezza'];

  // ===== Gate =====
  enterBtn.onclick = () => {
    if (pin.value === ADMIN_PIN) { gate.classList.add('hidden'); app.classList.remove('hidden'); loadAll(); }
    else alert('Wrong PIN');
  };

  // ===== Form helpers =====
  files.addEventListener('change', () => {
    thumbs.innerHTML = '';
    [...files.files].slice(0,8).forEach(f => {
      const img = document.createElement('img');
      img.src = URL.createObjectURL(f);
      thumbs.appendChild(img);
    });
  });

  function suggestType(){
    const t = (title.value + ' ' + model.value + ' ' + brand.value).toLowerCase();
    if (BIKE_HINTS.some(k=>t.includes(k))) type.value = 'bike';
    else if (CAR_HINTS.some(k=>t.includes(k))) type.value = 'car';
  }
  title.addEventListener('input', suggestType);
  brand.addEventListener('input', suggestType);
  model.addEventListener('input', suggestType);

  resetBtn.onclick = () => resetForm();

  // ===== Save (insert / update) =====
  saveBtn.onclick = async () => {
    msg.textContent = 'Saving…';

    // Collect URLs from textarea
    let urls = imageUrls.value.split('\n').map(s => s.trim()).filter(Boolean);

    // Upload files to Storage
    if (files.files.length) {
      for (const f of [...files.files].slice(0,8)) {
        const fname = `${Date.now()}_${Math.random().toString(36).slice(2)}_${f.name.replace(/\s+/g,'_')}`;
        const up = await sb.storage.from(BUCKET).upload(fname, f, { cacheControl: '3600', upsert:false });
        if (up.error) { console.error(up.error); msg.innerHTML = '<span class="err">Upload failed</span>'; return; }
        const { data:pub } = sb.storage.from(BUCKET).getPublicUrl(fname);
        urls.push(pub.publicUrl);
      }
    }

    // Build row data  ✅ desc आता आहे
    const row = {
      type: type.value,
      title: title.value.trim(),
      brand: brand.value.trim(),
      model: model.value.trim(),
      year: Number(year.value)||null,
      km: Number(km.value)||null,
      city: city.value.trim(),
      price: Number(price.value)||null,
      featured: featured.value === 'true',
      description: (document.getElementById('desc').value || '').trim() || null,
      image: urls[0] || null,
      images: urls.length ? urls : null
    };

    if (!row.type || !row.title || !row.price) { msg.innerHTML = '<span class="err">Type, Title, Price आवश्यक.</span>'; return; }

    let resp;
    if (rowId.value) resp = await sb.from('vehicles').update(row).eq('id', rowId.value);
    else             resp = await sb.from('vehicles').insert(row);

    if (resp.error) { console.error(resp.error); msg.innerHTML = '<span class="err">DB error</span>'; return; }

    msg.innerHTML = '<span class="ok">Saved ✅</span>';
    await loadAll();
    resetForm();
  };

  function resetForm(){
    formTitle.textContent = 'Add Vehicle';
    rowId.value=''; type.value='car'; title.value=brand.value=model.value=city.value='';
    year.value=km.value=price.value=''; featured.value='';
    imageUrls.value=''; files.value=''; thumbs.innerHTML=''; msg.textContent='';
    document.getElementById('desc').value='';
  }

  // ===== Table load / render =====
  refreshBtn.onclick = () => loadAll();
  q.addEventListener('input', renderFiltered);
  typeFilter.addEventListener('change', renderFiltered);

  async function loadAll(){
    tbody.innerHTML = '<tr><td colspan="9">Loading…</td></tr>';
    const { data, error } = await sb.from('vehicles').select('*').order('created_at',{ascending:false}).limit(500);
    if (error) { console.error(error); tbody.innerHTML = '<tr><td colspan="9">Error loading</td></tr>'; return; }
    allRows = data || [];
    countNote.textContent = `${allRows.length} record(s)`;
    renderFiltered();
  }

  function renderFiltered(){
    const term = q.value.trim().toLowerCase();
    const tfl  = typeFilter.value;
    const filtered = allRows.filter(r=>{
      const hay = [r.title,r.brand,r.model,r.city].filter(Boolean).join(' ').toLowerCase();
      const hit = hay.includes(term);
      const tOk = tfl ? (r.type||'')===tfl : true;
      return hit && tOk;
    });
    tbody.innerHTML = filtered.map(r => rowHtml(r)).join('') || '<tr><td colspan="9">No results</td></tr>';
    countNote.textContent = `${filtered.length} / ${allRows.length}`;
  }

  function rowHtml(r){
    const pill = `<button class="pill ${r.type==='car'?'car':'bike'}"
      title="Click to toggle Car/Bike"
      onclick="toggleType('${r.id}','${r.type==='car'?'bike':'car'}')">${r.type||'-'}</button>`;
    const feat = `<button class="pill" title="Toggle Featured" onclick="toggleFeatured('${r.id}', ${!r.featured})">${r.featured?'Yes':'No'}</button>`;
    const imgCount = (Array.isArray(r.images) ? r.images.length : r.image ? 1 : 0);
    const imgCell = imgCount ? `${imgCount} img` : '—';
    return `<tr>
      <td>${pill}</td>
      <td>${escapeHtml(r.title || [r.brand,r.model].filter(Boolean).join(' '))}</td>
      <td>${escapeHtml(r.city||'')}</td>
      <td>${r.year||''}</td>
      <td>${r.km||''}</td>
      <td>₹${Number(r.price||0).toLocaleString('en-IN')}</td>
      <td>${feat}</td>
      <td>${imgCell}</td>
      <td>
        <div class="actions">
          <button class="btn ghost" onclick='editRow(${JSON.stringify(r).replace(/'/g,"&#39;")})'>Edit</button>
          <button class="btn" onclick="delRow('${r.id}')">Delete</button>
        </div>
      </td>
    </tr>`;
  }

  // ===== Row actions =====
  window.editRow = (r) => {
    formTitle.textContent = 'Edit Vehicle';
    rowId.value = r.id || '';
    type.value = r.type || 'car';
    title.value = r.title || '';
    brand.value = r.brand || '';
    model.value = r.model || '';
    year.value = r.year || '';
    km.value = r.km || '';
    city.value = r.city || '';
    price.value = r.price || '';
    featured.value = r.featured ? 'true' : '';
    imageUrls.value = Array.isArray(r.images)? r.images.join('\n') : (r.image||'');
    thumbs.innerHTML = (Array.isArray(r.images)?r.images:[r.image]).filter(Boolean).slice(0,8)
      .map(u=>`<img src="${escapeAttr(u)}">`).join('');
    document.getElementById('desc').value = (r.description || '');
    window.scrollTo({top:0, behavior:'smooth'});
  };

  window.delRow = async (id) => {
    if (!confirm('Delete this listing?')) return;
    const { error } = await sb.from('vehicles').delete().eq('id', id);
    if (error) { alert('Delete failed'); return; }
    await loadAll();
  };

  window.toggleFeatured = async (id, val) => {
    const { error } = await sb.from('vehicles').update({ featured: !!val }).eq('id', id);
    if (error) { alert('Toggle failed'); return; }
    await loadAll();
  };

  window.toggleType = async (id, newType) => {
    const { error } = await sb.from('vehicles').update({ type: newType }).eq('id', id);
    if (error) { alert('Type update failed'); return; }
    await loadAll();
  };

  // ===== helpers =====
  function escapeHtml(s=''){ return String(s).replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }
  function escapeAttr(s=''){ return String(s).replace(/"/g,'&quot;'); }
</script>
</body>
</html>
