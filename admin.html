<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Second Wheel — Admin (Inventory & Featured Manager)</title>
<meta name="theme-color" content="#0b0f17" />
<style>
  :root{--bg:#0b0f17;--card:#121826;--muted:#9aa3b2;--ink:#e5e7eb;--brand:#f59e0b;--ok:#22c55e;--err:#ef4444;--line:rgba(255,255,255,.10);--shadow:0 8px 28px rgba(0,0,0,.35)}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial}
  a{color:inherit}
  header{position:sticky;top:0;z-index:9;background:rgba(11,15,23,.8);backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
  .container{max-width:1200px;margin:0 auto;padding:14px}
  .nav{display:flex;align-items:center;gap:12px;justify-content:space-between}
  .brand{display:flex;gap:10px;align-items:center}
  .brand img{width:40px;height:40px;border-radius:10px;box-shadow:var(--shadow)}
  .grid{display:grid;gap:14px}
  @media(min-width:980px){.grid-3{grid-template-columns:280px 1fr 360px}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:var(--shadow)}
  label{display:block;margin:8px 0 4px;color:var(--muted)}
  input,select,textarea{width:100%;padding:10px 12px;background:#0f1522;color:var(--ink);border:1px solid var(--line);border-radius:10px;outline:none}
  textarea{min-height:110px;resize:vertical}
  input:focus,select:focus,textarea:focus{border-color:#3b82f6}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,#f59e0b,#b45309);color:#111;border-color:transparent}
  .btn.danger{background:linear-gradient(180deg,#ef4444,#991b1b);color:#fff;border-color:transparent}
  .btn.ghost{background:transparent}
  .muted{color:var(--muted)}
  .ok{color:var(--ok)}
  .err{color:var(--err)}
  .list{max-height:460px;overflow:auto;border:1px solid var(--line);border-radius:12px}
  .item{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06);cursor:pointer}
  .item.active{background:rgba(255,255,255,.06)}
  .pill{padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.08);font-size:12px}
  .progress{height:8px;background:#0f1522;border-radius:8px;overflow:hidden;border:1px solid var(--line)}
  .bar{height:100%;width:0%;background:#3b82f6;transition:width .2s}
  .thumbs{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  @media(min-width:700px){.thumbs{grid-template-columns:repeat(3,1fr)}}
  .thumb{position:relative;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .thumb img{width:100%;height:180px;object-fit:cover;display:block}
  .thumb .actions{position:absolute;left:6px;top:6px;display:flex;gap:6px}
  .thumb .actions .btn{padding:6px 8px;border-radius:8px}
  .line{height:1px;background:var(--line);margin:10px 0}
  .hide{display:none !important}
</style>
</head>
<body>
<header>
  <div class="container nav">
    <div class="brand">
      <img src="https://wbjwvxckbfkutqqbgupq.supabase.co/storage/v1/object/public/vehicals/logo.png" alt="logo">
      <div>
        <strong>Second Wheel — Admin</strong>
        <div class="muted">Inventory & Featured Manager</div>
      </div>
    </div>
    <div class="row">
      <button id="btnNew" class="btn">New</button>
      <button id="btnRefresh" class="btn">Refresh</button>
    </div>
  </div>
</header>

<main class="container grid grid-3">
  <!-- Left: list -->
  <section class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">Vehicles</h3>
      <label class="row" style="align-items:center;gap:6px;margin:0">
        <input type="checkbox" id="onlyFeatured">
        <span class="pill">Featured only</span>
      </label>
    </div>
    <div class="line"></div>
    <div id="list" class="list"></div>
  </section>

  <!-- Middle: form -->
  <section class="card">
    <h3 id="formTitle" style="margin-top:0">Create / Edit</h3>
    <div class="grid">
      <div class="row" style="gap:10px">
        <div style="flex:1">
          <label>VID (auto)</label>
          <input id="vid" placeholder="Auto generated" disabled />
        </div>
        <div style="width:160px">
          <label>Type</label>
          <select id="vtype">
            <option value="car">car</option>
            <option value="bike">bike</option>
            <option value="scooter">scooter</option>
          </select>
        </div>
        <label class="row" style="align-items:center;gap:8px;margin-left:6px">
          <input type="checkbox" id="isFeatured" />
          <span class="pill">Mark as Featured</span>
        </label>
      </div>

      <div class="row">
        <div style="flex:1">
          <label>Brand</label>
          <input id="brand" placeholder="Maruti Suzuki" />
        </div>
        <div style="flex:1">
          <label>Title / Model</label>
          <input id="title" placeholder="Swift VXI 2016" />
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label>Price</label>
          <input id="price" placeholder="₹3.25L / 165000" />
        </div>
        <div style="width:120px">
          <label>Year</label>
          <input id="year" type="number" min="1990" max="2099" placeholder="2016" />
        </div>
        <div style="width:140px">
          <label>KM</label>
          <input id="km" placeholder="72,000" />
        </div>
      </div>

      <div>
        <label>Description</label>
        <textarea id="desc" placeholder="Variant, owners, service history, condition, extras…"></textarea>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn primary" id="btnSave">Save / Update</button>
      <button class="btn danger" id="btnDelete">Delete Vehicle</button>
    </div>
    <div id="metaMsg" class="muted" style="margin-top:8px"></div>
  </section>

  <!-- Right: gallery -->
  <section class="card">
    <h3 style="margin-top:0">Gallery</h3>
    <div class="row">
      <input id="files" type="file" accept=".jpg,.jpeg,.png,.webp" multiple />
      <button id="btnUpload" class="btn primary">Upload</button>
    </div>
    <div class="row" style="justify-content:space-between;margin-top:8px">
      <div class="muted">Images used: <span id="imgCount">0/0</span></div>
      <div class="pill" id="limitTag">car: 0/20</div>
    </div>
    <div class="progress" style="margin:8px 0"><div id="bar" class="bar"></div></div>
    <div id="upMsg" class="muted" style="margin-top:4px"></div>
    <div id="thumbs" class="thumbs" style="margin-top:12px"></div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // -------------------- Supabase Config --------------------
  const SUPABASE_URL = 'https://wbjwvxckbfkutqqbgupq.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indiand2eGNrYmZrdXRxcWJndXBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4NzU3NDEsImV4cCI6MjA2OTQ1MTc0MX0.u_zwikgAryhF5Ccv5yOvjq20hzxE5tbYfKI04uTnNXw';
  const STORAGE_BUCKET = 'vehicals';
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // -------------------- Elements --------------------
  const listEl = document.getElementById('list');
  const btnRefresh = document.getElementById('btnRefresh');
  const btnNew = document.getElementById('btnNew');
  const onlyFeatured = document.getElementById('onlyFeatured');

  const vid = document.getElementById('vid');
  const vtype = document.getElementById('vtype');
  const isFeatured = document.getElementById('isFeatured');
  const brand = document.getElementById('brand');
  const title = document.getElementById('title');
  const price = document.getElementById('price');
  const year = document.getElementById('year');
  const km = document.getElementById('km');
  const desc = document.getElementById('desc');
  const btnSave = document.getElementById('btnSave');
  const btnDelete = document.getElementById('btnDelete');
  const metaMsg = document.getElementById('metaMsg');

  const files = document.getElementById('files');
  const btnUpload = document.getElementById('btnUpload');
  const bar = document.getElementById('bar');
  const upMsg = document.getElementById('upMsg');
  const thumbs = document.getElementById('thumbs');
  const imgCount = document.getElementById('imgCount');
  const limitTag = document.getElementById('limitTag');

  // -------------------- Helpers --------------------
  const IMG_LIMIT = { car: 20, bike: 10, scooter: 10 };
  const IMG_REGEX = /\.(jpe?g|png|webp)$/i;

  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
  function msg(el, text, type='info'){
    el.textContent = text;
    el.classList.remove('ok','err');
    if(type==='ok') el.classList.add('ok');
    if(type==='err') el.classList.add('err');
  }
  function safeName(name){ return name.replace(/[^a-zA-Z0-9._-]/g,'_'); }
  function newVID(){
    const d=new Date();
    const pad=n=>String(n).padStart(2,'0');
    const stamp=`${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}${pad(d.getHours())}${pad(d.getMinutes())}`;
    const rand=Math.random().toString(36).slice(2,6);
    return `v${stamp}-${rand}`;
  }
  function metaPath(id){ return `items/${id}/meta.json`; }
  function itemBase(id){ return `items/${id}`; }
  function featuredBase(id){ return `featured/${id}`; }
  function publicUrl(path){
    const { data } = sb.storage.from(STORAGE_BUCKET).getPublicUrl(path);
    return data?.publicUrl || '#';
  }

  function buildMeta(){
    return {
      vid: vid.value,
      type: vtype.value,
      featured: !!isFeatured.checked,
      brand: brand.value.trim(),
      title: title.value.trim(),
      price: price.value.trim(),
      year: Number(year.value||'0'),
      km: km.value.trim(),
      description: desc.value.trim(),
      updatedAt: new Date().toISOString()
    };
  }

  function fillForm(m){
    vid.value = m.vid || '';
    vtype.value = m.type || 'car';
    isFeatured.checked = !!m.featured;
    brand.value = m.brand || '';
    title.value = m.title || '';
    price.value = m.price || '';
    year.value = m.year || '';
    km.value = m.km || '';
    desc.value = m.description || '';
    document.getElementById('formTitle').textContent = (m.vid?`Edit ${m.vid}`:'Create / Edit');
    refreshImgCounter(m.vid);
    loadGallery(m.vid);
  }

  // -------------------- List / Load --------------------
  async function listVehicles(){
    listEl.innerHTML = '<div class="item">Loading…</div>';
    // List under items/
    const { data, error } = await sb.storage.from(STORAGE_BUCKET).list('items', { limit: 1000 });
    if(error){ listEl.innerHTML='<div class="item err">List failed</div>'; return; }
    const folders = (data||[]).filter(x=>x && !(/\./.test(x.name)));

    const out=[];
    for(const f of folders){
      const p = metaPath(f.name);
      const { data:dl, error:er } = await sb.storage.from(STORAGE_BUCKET).download(p);
      if(er) continue;
      try{
        const m = JSON.parse(await dl.text());
        out.push(m);
      }catch(e){}
    }

    // Filter
    const featOnly = onlyFeatured.checked;
    const list = featOnly ? out.filter(x=>x.featured) : out;

    // render
    list.sort((a,b)=> (b.updatedAt||'').localeCompare(a.updatedAt||''));
    listEl.innerHTML='';
    for(const it of list){
      const div=document.createElement('div');
      div.className='item';
      div.innerHTML = `<strong>${it.title||it.brand||it.vid}</strong>
        <div class="muted">${it.brand||''} • ${it.price||''} <span class="pill">${it.type}</span> ${it.featured?'<span class="pill" style="background:#f59e0b;color:#111">Featured</span>':''}</div>`;
      div.addEventListener('click',()=>{
        listEl.querySelectorAll('.item').forEach(x=>x.classList.remove('active'));
        div.classList.add('active');
        fillForm(it);
      });
      listEl.appendChild(div);
    }
    if(!list.length) listEl.innerHTML = '<div class="item">No items</div>';
  }

  // -------------------- Save / Delete --------------------
  async function saveMeta(){
    if(!vid.value){ msg(metaMsg,'No VID found','err'); return; }
    const meta = buildMeta();
    // save to items/<vid>/meta.json
    const blob = new Blob([JSON.stringify(meta,null,2)],{type:'application/json'});
    const { error } = await sb.storage.from(STORAGE_BUCKET).upload(metaPath(meta.vid), blob, { upsert:true });
    if(error){ msg(metaMsg,'Save failed: '+error.message,'err'); return; }

    // Featured mirror
    if(meta.featured){
      const fb = `${featuredBase(meta.vid)}/meta.json`;
      await sb.storage.from(STORAGE_BUCKET).upload(fb, blob, { upsert:true });
    }else{
      // remove featured mirror if exists
      const { data:fl } = await sb.storage.from(STORAGE_BUCKET).list(featuredBase(meta.vid));
      if(fl && fl.length){
        const paths = fl.map(o=>`${featuredBase(meta.vid)}/${o.name}`);
        await sb.storage.from(STORAGE_BUCKET).remove(paths);
      }
    }

    msg(metaMsg,'Saved ✔','ok');
    await listVehicles();
  }

  async function deleteVehicle(){
    if(!vid.value){ msg(metaMsg,'No VID to delete','err'); return; }
    if(!confirm('Delete entire vehicle (meta + images)?')) return;

    const base = itemBase(vid.value);
    const { data:list1 } = await sb.storage.from(STORAGE_BUCKET).list(base,{limit:1000});
    const paths1 = (list1||[]).map(o=>`${base}/${o.name}`);
    if(paths1.length) await sb.storage.from(STORAGE_BUCKET).remove(paths1);

    // featured mirror
    const fbase = featuredBase(vid.value);
    const { data:list2 } = await sb.storage.from(STORAGE_BUCKET).list(fbase,{limit:1000});
    const paths2 = (list2||[]).map(o=>`${fbase}/${o.name}`);
    if(paths2.length) await sb.storage.from(STORAGE_BUCKET).remove(paths2);

    brand.value=title.value=price.value=km.value=desc.value='';
    year.value=''; vtype.value='car'; isFeatured.checked=false; vid.value='';
    thumbs.innerHTML=''; imgCount.textContent='0/0'; limitTag.textContent='';
    msg(metaMsg,'Vehicle deleted ✔','ok');
    await listVehicles();
  }

  // -------------------- Gallery / Limits --------------------
  async function countExistingImages(id){
    const { data, error } = await sb.storage.from(STORAGE_BUCKET).list(itemBase(id), { limit: 1000 });
    if(error) return 0;
    return (data||[]).filter(o=>IMG_REGEX.test(o.name)).length;
  }

  async function refreshImgCounter(id){
    if(!id){ imgCount.textContent='0/0'; limitTag.textContent=''; return {used:0,limit:0}; }
    const limit = IMG_LIMIT[(vtype.value||'car')] || 10;
    const used = await countExistingImages(id);
    imgCount.textContent = `${used}/${limit}`;
    limitTag.textContent = `${vtype.value}: ${used}/${limit}`;
    return { used, limit };
  }

  async function loadGallery(id){
    thumbs.innerHTML = '<div class="muted">Loading…</div>';
    if(!id){ thumbs.innerHTML='<div class="muted">No VID</div>'; return; }
    const { data, error } = await sb.storage.from(STORAGE_BUCKET).list(itemBase(id), { limit: 1000 });
    if(error){ thumbs.innerHTML='<div class="err">Failed to load</div>'; return; }
    const imgs = (data||[]).filter(o=>IMG_REGEX.test(o.name));
    if(!imgs.length){ thumbs.innerHTML='<div class="muted">No images yet</div>'; return; }
    thumbs.innerHTML='';
    for(const im of imgs){
      const path = `${itemBase(id)}/${im.name}`;
      const url = publicUrl(path);
      const d=document.createElement('div');
      d.className='thumb';
      d.innerHTML = `
        <img src="${url}" alt="${im.name}">
        <div class="actions">
          <button class="btn" data-primary="${path}" title="Make Primary">⭐</button>
          <a class="btn" href="${url}" target="_blank" title="Open">🔍</a>
          <button class="btn danger" data-del="${path}" title="Delete">🗑️</button>
        </div>`;
      // Delete
      d.querySelector('[data-del]').addEventListener('click', async ()=>{
        if(!confirm('Delete this image?')) return;
        const { error:e2 } = await sb.storage.from(STORAGE_BUCKET).remove([path]);
        if(e2){ alert('Delete failed: '+e2.message); return; }
        await refreshImgCounter(id); loadGallery(id);
      });
      // Make Primary (copy to featured mirror if featured)
      d.querySelector('[data-primary]').addEventListener('click', async ()=>{
        if(!isFeatured.checked){ alert('Mark as Featured to set primary.'); return; }
        const fname = path.split('/').pop();
        const fPath = `${featuredBase(id)}/${fname}`;
        // download then upload to mirror
        const { data:bin, error:e1 } = await sb.storage.from(STORAGE_BUCKET).download(path);
        if(e1){ alert('Primary set failed: '+e1.message); return; }
        await sb.storage.from(STORAGE_BUCKET).upload(fPath, bin, { upsert:true });
        alert('Primary image copied to featured ✔');
      });
      thumbs.appendChild(d);
    }
  }

  btnUpload.addEventListener('click', async ()=>{
    const id = vid.value.trim();
    if(!id){ msg(upMsg,'Set/Save vehicle first (VID empty).','err'); return; }
    const fileList = Array.from(files.files||[]);
    if(!fileList.length){ msg(upMsg,'Select images to upload.','err'); return; }

    const { used, limit } = await refreshImgCounter(id);
    const remaining = Math.max(0, limit - used);
    if(remaining === 0){ msg(upMsg,`Limit reached (${used}/${limit}).`,'err'); return; }

    const chosen = fileList.filter(f=>IMG_REGEX.test(f.name)).slice(0, remaining);
    if(!chosen.length){ msg(upMsg,'No valid images (.jpg/.jpeg/.png/.webp).','err'); return; }
    if(chosen.length < fileList.length){ msg(upMsg,`Only ${chosen.length} allowed now (remaining ${remaining}).`,'err'); }

    const base = `${itemBase(id)}/`;
    let uploaded = 0; bar.style.width='0%';
    for(const f of chosen){
      const path = `${base}${Date.now()}-${safeName(f.name)}`;
      const { error } = await sb.storage.from(STORAGE_BUCKET).upload(path, f, { upsert:false });
      if(error){ msg(upMsg,'Upload failed: '+error.message,'err'); return; }
      uploaded++; bar.style.width = Math.round((uploaded/chosen.length)*100)+'%';
      await sleep(30);
    }
    msg(upMsg,`Uploaded ${uploaded}/${chosen.length} ✔`,'ok');
    await refreshImgCounter(id); loadGallery(id);
  });

  // -------------------- Events --------------------
  btnRefresh.addEventListener('click', listVehicles);
  onlyFeatured.addEventListener('change', listVehicles);

  btnNew.addEventListener('click', ()=>{
    vid.value = newVID();
    vtype.value = 'car'; isFeatured.checked=false;
    brand.value=title.value=price.value=km.value=desc.value='';
    document.getElementById('formTitle').textContent = 'Create '+vid.value;
    refreshImgCounter(vid.value);
    thumbs.innerHTML='<div class="muted">No images yet</div>';
    msg(metaMsg,'', 'info');
  });

  btnSave.addEventListener('click', saveMeta);
  btnDelete.addEventListener('click', deleteVehicle);
  vtype.addEventListener('change', ()=>{ if(vid.value) refreshImgCounter(vid.value); });

  // -------------------- Init --------------------
  (async function init(){
    await listVehicles();
  })();
</script>
</body>
</html>
