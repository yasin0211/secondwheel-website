<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Second Wheel – Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:system-ui;background:#f4f6fb}
header{background:#111827;color:#fff;padding:12px 16px;display:flex;justify-content:space-between;align-items:center}
h1{font-size:18px;margin:0}
button{cursor:pointer;border:0;border-radius:8px;padding:10px 14px}
.btn{background:#2563eb;color:#fff}
.btn.ghost{background:#e5e7eb;color:#111}
.btn.danger{background:#dc2626;color:#fff}
main{max-width:900px;margin:auto;padding:16px}
.panel{background:#fff;border-radius:14px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
label{font-weight:600;font-size:13px;margin-top:10px;display:block}
input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;margin-top:6px}
textarea{min-height:90px}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.note{margin-top:8px;font-size:13px}
.ok{color:#15803d}
.err{color:#b91c1c}
.gallery{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
.gimg{position:relative}
.gimg img{width:100%;height:110px;object-fit:cover;border-radius:10px}
.gimg button{
  position:absolute;
  top:6px;right:6px;
  background:rgba(0,0,0,.6);
  color:#fff;border:0;
  border-radius:6px;
  padding:4px 6px;
  cursor:pointer
}
</style>
</head>

<body>
<header>
  <h1>Second Wheel — Admin</h1>
  <button id="logout" class="btn ghost">Logout</button>
</header>

<main id="app" hidden>
<div class="panel">

<b id="vidLabel">VID:</b>

<label>Brand</label>
<input id="brand">

<label>Title</label>
<input id="title">

<label>Type</label>
<select id="type">
  <option value="car">Car</option>
  <option value="bike">Bike</option>
  <option value="scooter">Scooter</option>
</select>

<label>Price</label>
<input type="number" id="price">

<label>Year</label>
<input type="number" id="year">

<label>KM</label>
<input type="number" id="km">

<label>Owner</label>
<input type="number" id="owner">

<label>Description</label>
<textarea id="desc"></textarea>

<label>
  <input type="checkbox" id="featured"> Mark as Featured
</label>

<label>Images</label>
<input type="file" id="files" multiple accept="image/*">

<div class="actions">
  <button id="upload" class="btn ghost">Upload Images</button>
  <button id="save" class="btn">Save / Update</button>
  <button id="new" class="btn ghost">New</button>
</div>

<div id="msg" class="note"></div>
<div id="gallery" class="gallery"></div>

</div>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* CONFIG */
const SUPABASE_URL = "https://wbjwvxckbfkutqqbgupq.supabase.co";
const SUPABASE_KEY = "sb_publishable_QjJXmzREzdg3qB6dbfG-1A_0jLQNt66";
const BUCKET = "vehicals";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* AUTH */
async function checkAuth(){
  const { data } = await sb.auth.getSession();
  if(!data.session){ location.href="login.html"; return; }
  document.getElementById("app").hidden=false;
}
checkAuth();

/* HELPERS */
const el = id => document.getElementById(id);
let VID = Date.now().toString();
el("vidLabel").innerText="VID: "+VID;

/* IMAGE DELETE */
async function deleteImage(filename){
  if(!confirm("Delete image?")) return;

  await sb.storage.from(BUCKET)
    .remove([el("type").value+"/"+VID+"/"+filename]);

  if(el("featured").checked){
    await sb.storage.from(BUCKET)
      .remove(["featured/"+VID+"/"+filename]);
  }

  loadImages();
}

/* LOAD IMAGES */
async function loadImages(){
  el("gallery").innerHTML="";
  const path = el("type").value+"/"+VID;
  const { data } = await sb.storage.from(BUCKET).list(path);

  if(!data) return;

  for(const f of data){
    if(!f.name.match(/\.(jpg|png|jpeg|webp)$/)) continue;
    const url = sb.storage.from(BUCKET)
      .getPublicUrl(path+"/"+f.name).data.publicUrl;

    const wrap=document.createElement("div");
    wrap.className="gimg";

    const img=document.createElement("img");
    img.src=url;

    const del=document.createElement("button");
    del.innerText="❌";
    del.onclick=()=>deleteImage(f.name);

    wrap.appendChild(img);
    wrap.appendChild(del);
    el("gallery").appendChild(wrap);
  }
}

/* UPLOAD */
async function uploadImages(){
  const files = el("files").files;
  if(!files.length){ alert("Select images"); return; }

  for(const file of files){
    const name=Date.now()+"-"+file.name;
    const path=el("type").value+"/"+VID+"/"+name;

    const { error } = await sb.storage.from(BUCKET)
      .upload(path,file,{upsert:true});

    if(error){ alert(error.message); return; }

    if(el("featured").checked){
      await sb.storage.from(BUCKET)
        .upload("featured/"+VID+"/"+name,file,{upsert:true});
    }
  }
  loadImages();
}

/* SAVE META */
async function saveMeta(){
  const meta={
    vid:VID,
    brand:el("brand").value,
    title:el("title").value,
    type:el("type").value,
    price:+el("price").value,
    year:+el("year").value,
    km:+el("km").value,
    owner:+el("owner").value,
    description:el("desc").value,
    updatedAt:new Date().toISOString()
  };

  const base=meta.type+"/"+VID;
  await sb.storage.from(BUCKET)
    .upload(base+"/meta.json",
      new Blob([JSON.stringify(meta)],{type:"application/json"}),
      {upsert:true});

  if(el("featured").checked){
    await sb.storage.from(BUCKET)
      .upload("featured/"+VID+"/meta.json",
        new Blob([JSON.stringify(meta)],{type:"application/json"}),
        {upsert:true});
  }

  el("msg").innerText="Saved successfully";
  el("msg").className="note ok";
}

/* BUTTONS */
el("upload").onclick=uploadImages;
el("save").onclick=saveMeta;

el("new").onclick=()=>{
  VID=Date.now().toString();
  el("vidLabel").innerText="VID: "+VID;
  el("gallery").innerHTML="";
  el("msg").innerText="";
};

el("logout").onclick=async()=>{
  await sb.auth.signOut();
  location.href="login.html";
};
</script>
</body>
</html>
