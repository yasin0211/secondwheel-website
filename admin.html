<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Second Wheel ‚Äî Admin (Featured & Inventory Manager)</title>
<meta name="theme-color" content="#ffffff"/>
<style>
  :root{
    --bg:#f7f8fb; --card:#ffffff; --text:#0b0f17; --muted:#5b667a;
    --brand:#f59e0b; --ok:#22c55e; --danger:#ef4444; --line:rgba(0,0,0,.12);
    --elev:0 8px 20px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  a{color:inherit;text-decoration:none}
  header{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
  .wrap{max-width:1200px;margin:0 auto;padding:14px 16px}
  h1{font-size:18px;margin:0 0 4px}
  .hint{color:var(--muted);font-size:12px}

  main .grid{display:grid;grid-template-columns:380px 1fr;gap:14px}
  @media(max-width:920px){main .grid{grid-template-columns:1fr}}

  .panel{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:var(--elev)}
  h2{font-size:16px;margin:0 0 10px}
  .rowbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between}

  .filters{display:flex;gap:8px;flex-wrap:wrap}
  .input,.select{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#f2f4f8;color:var(--text);outline:none}

  .list{display:grid;gap:8px;max-height:62vh;overflow:auto}
  @media(max-width:920px){.list{max-height:none}}
  .item{display:grid;grid-template-columns:56px 1fr;gap:10px;padding:8px;border:1px solid var(--line);border-radius:12px;background:#fff;cursor:pointer;box-shadow:var(--elev)}
  .item:hover{background:#fcfcff}
  .thumb{width:56px;height:56px;border-radius:10px;object-fit:cover;background:#f2f4f8;border:1px solid var(--line)}
  .meta b{display:block}
  .meta small{color:var(--muted)}
  .pill{padding:2px 8px;border-radius:999px;background:#f2f4f8;font-size:11px;margin-left:6px;border:1px solid var(--line)}

  label{display:block;margin:8px 0 6px;color:var(--muted);font-weight:600}
  input,select,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:#f2f4f8;color:var(--text);outline:none}
  input:focus,select:focus,textarea:focus{border-color:#3b82f6;background:#fff}
  textarea{min-height:120px;resize:vertical}

  .fields{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  @media(max-width:920px){.fields{grid-template-columns:1fr 1fr}}
  @media(max-width:560px){.fields{grid-template-columns:1fr}}

  .btn{display:inline-flex;gap:8px;align-items:center;justify-content:center;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#ffffff;cursor:pointer;min-width:120px;box-shadow:var(--elev)}
  .btn:active{transform:translateY(1px)}
  .primary{background:linear-gradient(180deg,#f59e0b,#b45309);color:#111;border:none}
  .danger{background:linear-gradient(180deg,#ef4444,#b91c1c);color:#fff;border:none}
  .secondary{background:linear-gradient(180deg,#60a5fa,#2563eb);color:#fff;border:none}
  .ghost{background:#f2f4f8}
  .btnBlock{display:flex;gap:10px;flex-wrap:wrap}
  @media(max-width:560px){.btn{width:100%} .btnBlock{flex-direction:column}}

  .tick{appearance:none;width:20px;height:20px;border-radius:6px;border:1px solid var(--line);display:inline-grid;place-items:center;background:#f2f4f8;margin-right:8px}
  .tick:checked{background:#f59e0b;border-color:#f59e0b}

  .upl{border:1px dashed var(--line);border-radius:12px;padding:12px;background:#fff}
  .limit{color:var(--muted);font-size:12px}
  .status{min-height:20px;color:#374151;margin-top:6px}
  .status.ok{color:#15803d}
  .status.err{color:#b91c1c}

  .ghead{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
  .ggrid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px}
  @media(max-width:920px){.ggrid{grid-template-columns:repeat(3,1fr)}}
  @media(max-width:560px){.ggrid{grid-template-columns:repeat(2,1fr)}}
  .gcard{position:relative;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#fff;box-shadow:var(--elev)}
  .gcard img{width:100%;height:100px;object-fit:cover;display:block}
  .gact{position:absolute;right:6px;top:6px;display:flex;gap:6px}
  .icon{display:inline-grid;place-items:center;width:30px;height:30px;border-radius:8px;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.2);cursor:pointer;color:#fff}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Second Wheel ‚Äî Admin</h1>
    <div class="hint">Featured control ‚Ä¢ Create/Update ‚Ä¢ Gallery upload/delete ‚Ä¢ Owner (only number) ‚Ä¢ Description syncs to Buy page</div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <!-- LEFT: Featured List -->
    <section class="panel">
      <div class="rowbar">
        <h2 style="margin:0">Featured List</h2>
        <button id="btnNew" class="btn ghost">+ New</button>
      </div>
      <div class="filters" style="margin:8px 0">
        <input id="q" class="input" placeholder="Search (title / brand)"/>
        <select id="fType" class="select">
          <option value="">All types</option>
          <option value="car">car</option>
          <option value="bike">bike</option>
          <option value="scooter">scooter</option>
        </select>
      </div>
      <div id="featuredList" class="list" aria-live="polite"></div>
    </section>

    <!-- RIGHT: Editor -->
    <section class="panel">
      <div class="rowbar">
        <h2 style="margin:0">Create / Edit</h2>
        <!-- NOTE: VID badge removed (hidden) -->
      </div>

      <div class="fields">
        <div>
          <label>Brand</label>
          <input id="brand" placeholder="HYUNDAI"/>
        </div>
        <div>
          <label>Title / Model</label>
          <input id="title" placeholder="i10 Sportz 2008"/>
        </div>
        <div>
          <label>Type</label>
          <select id="type">
            <option value="car">car</option>
            <option value="bike">bike</option>
            <option value="scooter">scooter</option>
          </select>
        </div>
        <div>
          <label>Price (‚Çπ)</label>
          <input id="price" type="number" inputmode="numeric" placeholder="165000"/>
        </div>
        <div>
          <label>Year</label>
          <input id="year" type="number" inputmode="numeric" placeholder="2008"/>
        </div>
        <div>
          <label>KM</label>
          <input id="km" type="number" inputmode="numeric" placeholder="82000"/>
        </div>
      </div>

      <label>Description</label>
      <textarea id="desc" placeholder="Well maintained single-owner vehicle with service history."></textarea>

      <!-- OWNER (ONLY NUMBER) -->
      <div class="fields" style="margin-top:8px">
        <div>
          <label>Owner (number)</label>
          <input id="owner" type="number" inputmode="numeric" placeholder="1 for 1st owner"/>
        </div>
      </div>

      <label style="display:flex;align-items:center;margin-top:10px">
        <input id="featured" type="checkbox" class="tick"/>
        <span>Mark as Featured (also write to <b>vehicals/featured/VID/</b>)</span>
      </label>

      <div class="upl" style="margin-top:12px">
        <label>Gallery</label>
        <input id="files" type="file" accept="image/*" multiple/>
        <div class="limit">Cars: up to 20 images ‚Ä¢ Bikes/Scooters: up to 10 images</div>
        <div class="btnBlock" style="margin-top:10px">
          <button id="btnUpload" class="btn secondary">‚Üë Upload Gallery</button>
          <button id="btnSave" class="btn primary">Save / Update</button>
          <button id="btnDelete" class="btn danger">Delete Vehicle</button>
        </div>
        <div id="status" class="status"></div>

        <div class="ghead">
          <strong>Gallery Preview</strong>
          <span class="hint" id="gHint">‚Äî</span>
        </div>
        <div id="gallery" class="ggrid"></div>
      </div>
    </section>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ---------- CONFIG ---------- */
const SUPABASE_URL = 'https://wbjwvxckbfkutqqbgupq.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indiand2eGNrYmZrdXRxcWJndXBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4NzU3NDEsImV4cCI6MjA2OTQ1MTc0MX0.u_zwikgAryhF5Ccv5yOvjq20hzxE5tbYfKI04uTnNXw';
const BUCKET = 'vehicals';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ---------- EL ---------- */
const $ = id => document.getElementById(id);
const featuredList = $('featuredList');
const brand = $('brand'), title = $('title'), price = $('price'), year = $('year'),
      km = $('km'), type = $('type'), desc = $('desc'), featured = $('featured'), owner = $('owner');
const files = $('files'); const statusEl = $('status');
const btnSave = $('btnSave'), btnDelete = $('btnDelete'), btnUpload = $('btnUpload'), btnNew = $('btnNew');
const q = $('q'), fType = $('fType');
const gallery = $('gallery'), gHint = $('gHint');

/* ---------- STATE ---------- */
let CURRENT_VID = makeVID();   // Hidden; only used in paths
let FEATURED_CACHE = [];

/* ---------- UTIL ---------- */
function makeVID(){ const rand=Math.random().toString(36).slice(2,6); const ts=Date.now().toString(36).slice(-4); return `${ts}-${rand}`; }
function slugify(s){ return (s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
function note(msg, ok=false, err=false){ statusEl.textContent=msg; statusEl.className='status'; if(ok) statusEl.classList.add('ok'); if(err) statusEl.classList.add('err'); }
function clearForm(){
  brand.value=title.value=price.value=year.value=km.value=desc.value='';
  owner.value=''; type.value='car'; featured.checked=false; files.value='';
  CURRENT_VID=makeVID();            // generate new hidden VID
  note('Ready.', true);
  renderGallery();
}
function pathFeatured(){ return `featured/${CURRENT_VID}`; }
function pathType(){ return `${type.value}/${CURRENT_VID}`; }
function pubUrl(path){ const { data }=sb.storage.from(BUCKET).getPublicUrl(path); return data?.publicUrl; }
async function listKeys(prefix){ const { data, error }=await sb.storage.from(BUCKET).list(prefix,{limit:200}); if(error){console.error(error);return [];} return (data||[]).filter(Boolean); }
async function removeFolder(prefix){ const entries=await listKeys(prefix); if(entries.length===0) return true; const keys=entries.map(f=>`${prefix}/${f.name}`); const { error }=await sb.storage.from(BUCKET).remove(keys); if(error){console.error('remove error',error);return false;} return true; }
async function uploadJSON(prefix,name,obj){ const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'}); const { error }=await sb.storage.from(BUCKET).upload(`${prefix}/${name}`, blob, { upsert:true, contentType:'application/json' }); if(error){console.error('meta write error',error); throw error;} }
function isImg(name){ return /\.(jpe?g|png|webp|avif)$/i.test(name); }

/* ---------- FEATURED LIST (LEFT) ---------- */
async function firstImageUrl(prefix){ const files=await listKeys(prefix); const img=files.filter(f=>isImg(f.name)).sort((a,b)=>a.name.localeCompare(b.name))[0]; return img?pubUrl(`${prefix}/${img.name}`):''; }

async function refreshFeatured(){
  featuredList.innerHTML='<div class="hint">Loading‚Ä¶</div>';
  const roots=await listKeys('featured');
  const folders=roots.filter(x=>x && x.name && !(/\./.test(x.name)));
  const items=[];
  for(const f of folders){
    const vid=f.name;
    const metaPath=`featured/${vid}/meta.json`;
    const { data }=sb.storage.from(BUCKET).getPublicUrl(metaPath);
    let meta=null;
    try{ const res=await fetch(data.publicUrl,{cache:'no-store'}); if(res.ok) meta=await res.json(); }catch(e){}
    if(meta){
      const thumb = await firstImageUrl(`featured/${vid}`) || await firstImageUrl(`${meta.type||'car'}/${vid}`) || '';
      items.push({ vid, meta, thumb });
    }
  }
  items.sort((a,b)=>(b.meta?.updatedAt||'').localeCompare(a.meta?.updatedAt||''));
  FEATURED_CACHE=items;
  renderFeaturedList();
}

function renderFeaturedList(){
  const term=(q.value||'').toLowerCase().trim();
  const tfilter=(fType.value||'').trim();
  const view=FEATURED_CACHE.filter(it=>{
    const hitQ=!term || ((it.meta.title||'').toLowerCase().includes(term) || (it.meta.brand||'').toLowerCase().includes(term));
    const hitT=!tfilter || (it.meta.type===tfilter);
    return hitQ && hitT;
  });
  featuredList.innerHTML='';
  if(view.length===0){ featuredList.innerHTML='<div class="hint">No results</div>'; return; }
  for(const it of view){
    const div=document.createElement('div');
    div.className='item';
    div.innerHTML=`<img class="thumb" src="${it.thumb||''}" alt=""><div class="meta"><b>${it.meta.title||'-'} <span class="pill">${it.meta.type||''}</span></b><small>${(it.meta.brand||'').toUpperCase()} ‚Ä¢ ‚Çπ${it.meta.price||''}</small></div>`;
    div.onclick=()=>loadToForm(it.vid,it.meta);
    featuredList.appendChild(div);
  }
}
q.addEventListener('input',renderFeaturedList);
fType.addEventListener('change',renderFeaturedList);

function loadToForm(vid, meta){
  CURRENT_VID=vid;                 // keep hidden
  brand.value=meta.brand||''; title.value=meta.title||'';
  price.value=meta.price||''; year.value=meta.year||''; km.value=meta.km||'';
  type.value=meta.type||'car'; desc.value=meta.description||'';
  owner.value=meta.owner||'';
  featured.checked=true;           // left list is featured
  note('Loaded', true);
  renderGallery();
}

/* ---------- META WRITE & BUMP ---------- */
async function writeMeta(){
  const meta={
    vid: CURRENT_VID,
    brand: brand.value.trim(),
    title: title.value.trim(),
    price: Number(price.value)||0,
    year: Number(year.value)||0,
    km: Number(km.value)||0,
    owner: Number(owner.value)||0,
    type: type.value,
    description: desc.value.trim(),
    updatedAt: new Date().toISOString()
  };
  await uploadJSON(pathType(),'meta.json',meta);
  if(featured.checked){ await uploadJSON(pathFeatured(),'meta.json',meta); }
  return meta;
}

async function bumpUpdatedAt(){
  try{
    const metaUrl = pubUrl(`${pathType()}/meta.json`);
    const res = await fetch(metaUrl,{cache:'no-store'});
    const base = res.ok ? await res.json() : { vid: CURRENT_VID, type: type.value };
    base.updatedAt = new Date().toISOString();
    await uploadJSON(pathType(),'meta.json',base);
    if(featured.checked){ await uploadJSON(pathFeatured(),'meta.json',base); }
  }catch(_){}
}

/* ---------- SAVE / UPDATE ---------- */
async function saveVehicle(){
  try{
    note('Saving‚Ä¶');
    await writeMeta();
    if(!featured.checked){ await removeFolder(pathFeatured()); } // Featured OFF ‚áí clean folder
    note('Saved ‚úì', true);
    await refreshFeatured();
    await renderGallery();
  }catch(e){ console.error(e); note('Save failed', false, true); }
}

/* ---------- GALLERY ---------- */
function maxAllowed(){ return (type.value==='car')?20:10; }
async function listImages(prefix){
  const arr=await listKeys(prefix);
  return arr.filter(f=>isImg(f.name)).sort((a,b)=>a.name.localeCompare(b.name))
            .map(x=>({ name:x.name, url:pubUrl(`${prefix}/${x.name}`), path:`${prefix}/${x.name}` }));
}

async function uploadGallery(){
  const filesArr=Array.from(files.files||[]);
  if(filesArr.length===0){ note('Select images first'); return; }
  const existing=await listImages(pathType());
  const max=maxAllowed();
  if(existing.length + filesArr.length > max){
    note(`Too many images. Limit ${max}. Existing ${existing.length}, you selected ${filesArr.length}.`, false, true);
    return;
  }
  note('Uploading images‚Ä¶');
  let ok=0, fail=0, i=0;
  for(const f of filesArr){
    const clean=slugify(f.name);
    const fname=`${Date.now()}-${(++i)}-${clean}`;
    const targets=[`${pathType()}/${fname}`];
    if(featured.checked) targets.push(`${pathFeatured()}/${fname}`);
    for(const key of targets){
      const { error }=await sb.storage.from(BUCKET).upload(key, f, { upsert:true, contentType:f.type||'image/jpeg' });
      if(error){ fail++; console.error('upload error',key,error); } else { ok++; }
    }
  }
  note(`Gallery uploaded: ${ok} ok, ${fail} failed.`, fail===0, fail>0);
  await bumpUpdatedAt();
  await renderGallery();
}

/* delete image from both places (type + featured) */
async function deleteEverywhere(filename){
  const paths=[`${pathType()}/${filename}`, `${pathFeatured()}/${filename}`];
  await sb.storage.from(BUCKET).remove(paths);
}

async function renderGallery(){
  gallery.innerHTML='';
  const typePrefix=pathType();
  const featPrefix=pathFeatured();
  const pools=[];
  const typeImgs=await listImages(typePrefix);
  if(typeImgs.length) pools.push({ label:`${type.value.toUpperCase()} ¬∑ ${typeImgs.length}`, items:typeImgs });
  const featImgs=featured.checked? await listImages(featPrefix) : [];
  if(featImgs.length) pools.push({ label:`FEATURED ¬∑ ${featImgs.length}`, items:featImgs });
  if(pools.length===0){ gHint.textContent='No images yet'; return; }
  gHint.textContent=pools.map(p=>p.label).join('  |  ');
  for(const pool of pools){
    for(const im of pool.items){
      const card=document.createElement('div');
      card.className='gcard';
      card.innerHTML=`<img src="${im.url}" alt=""><div class="gact"><a class="icon" href="${im.url}" target="_blank" title="Open">üîç</a><button class="icon" title="Delete">üóëÔ∏è</button></div>`;
      card.querySelector('button').onclick=async ()=>{
        if(!confirm('Delete this image everywhere?')) return;
        try{ await deleteEverywhere(im.name); await bumpUpdatedAt(); await renderGallery(); }
        catch(e){ alert('Delete failed'); }
      };
      gallery.appendChild(card);
    }
  }
}

/* ---------- DELETE VEHICLE ---------- */
async function deleteVehicle(){
  if(!confirm('Delete this vehicle from featured & buy folders?')) return;
  note('Deleting‚Ä¶');
  await removeFolder(pathType());
  await removeFolder(pathFeatured());
  note('Deleted ‚úì', true);
  clearForm();
  refreshFeatured();
}

/* ---------- NEW / EVENTS ---------- */
btnNew.onclick = clearForm;
btnSave.onclick = saveVehicle;
btnUpload.onclick = uploadGallery;
btnDelete.onclick = deleteVehicle;

/* ---------- INIT ---------- */
refreshFeatured();
note('Ready.', true);
</script>
</body>
</html>
