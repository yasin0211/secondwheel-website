<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Second Wheel — Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
body{margin:0;font-family:system-ui;background:#f4f6fb}
header{background:#111827;color:#fff;padding:12px 16px;display:flex;justify-content:space-between;align-items:center}
h1{font-size:18px;margin:0}
button{cursor:pointer;border:0;border-radius:8px;padding:10px 14px}
.btn{background:#2563eb;color:#fff}
.btn.danger{background:#dc2626}
.btn.ghost{background:#e5e7eb;color:#111}
main{max-width:1200px;margin:auto;padding:16px;display:grid;grid-template-columns:360px 1fr;gap:16px}
@media(max-width:900px){main{grid-template-columns:1fr}}
.panel{background:#fff;border-radius:14px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
.list{max-height:70vh;overflow:auto}
.item{display:flex;gap:10px;padding:8px;border:1px solid #e5e7eb;border-radius:10px;margin-bottom:8px;cursor:pointer}
.item:hover{background:#f9fafb}
.thumb{width:54px;height:54px;border-radius:8px;object-fit:cover;background:#eee}
label{font-weight:600;font-size:13px;margin-top:10px;display:block}
input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;margin-top:6px}
textarea{min-height:100px}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.gallery{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:10px}
@media(max-width:600px){.gallery{grid-template-columns:repeat(2,1fr)}}
.gimg{position:relative}
.gimg img{width:100%;height:110px;object-fit:cover;border-radius:10px}
.gimg button{position:absolute;top:6px;right:6px;background:rgba(0,0,0,.6);color:#fff}
.note{margin-top:8px;font-size:13px}
.ok{color:#15803d}
.err{color:#b91c1c}
</style>
</head>

<body>
<header>
  <h1>Second Wheel — Admin Panel</h1>
  <button id="logout" class="btn ghost">Logout</button>
</header>

<main id="app" hidden>
  <!-- LEFT -->
  <div class="panel">
    <button id="new" class="btn ghost" style="width:100%">+ New Vehicle</button>
    <div id="list" class="list" style="margin-top:12px"></div>
  </div>

  <!-- RIGHT -->
  <div class="panel">
    <b id="vidLabel">VID: -</b>

    <label>Brand</label>
    <input id="brand">

    <label>Title</label>
    <input id="title">

    <label>Type</label>
    <select id="type">
      <option value="car">Car</option>
      <option value="bike">Bike</option>
      <option value="scooter">Scooter</option>
    </select>

    <label>Price</label>
    <input type="number" id="price">

    <label>Year</label>
    <input type="number" id="year">

    <label>KM</label>
    <input type="number" id="km">

    <label>Owner</label>
    <input type="number" id="owner">

    <label>Description</label>
    <textarea id="desc"></textarea>

    <label>
      <input type="checkbox" id="featured"> Mark as Featured
    </label>

    <label>Upload Images</label>
    <input type="file" id="files" multiple accept="image/*">

    <div class="actions">
      <button id="save" class="btn">Save / Update</button>
      <button id="upload" class="btn ghost">Upload Images</button>
      <button id="delete" class="btn danger">Delete</button>
    </div>

    <div id="msg" class="note"></div>

    <div id="gallery" class="gallery"></div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ===== SUPABASE CONFIG ===== */
const SUPABASE_URL = "https://wbjwvxckbfkutqqbgupq.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_QjJXmzREzdg3qB6dbfG-1A_0jLQNt66";
const BUCKET = "vehicals";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== AUTH GUARD ===== */
async function checkAuth(){
  const { data } = await sb.auth.getSession();
  if(!data.session){
    alert("Not logged in");
    location.href="login.html";
  }
}
checkAuth();

/* ===== STATE ===== */
let VID = Date.now().toString(); // NUMBER ONLY
const el = id=>document.getElementById(id);

function setVID(){
  el("vidLabel").innerText="VID: "+VID;
}
setVID();

/* ===== META ===== */
async function saveMeta(){
  const meta={
    vid:VID,
    brand:el("brand").value,
    title:el("title").value,
    type:el("type").value,
    price:+el("price").value,
    year:+el("year").value,
    km:+el("km").value,
    owner:+el("owner").value,
    description:el("desc").value,
    updatedAt:new Date().toISOString()
  };
  const path=meta.type+"/"+VID+"/meta.json";
  await sb.storage.from(BUCKET).upload(path,new Blob([JSON.stringify(meta)],{type:"application/json"}),{upsert:true});
  if(el("featured").checked){
    await sb.storage.from(BUCKET).upload("featured/"+VID+"/meta.json",new Blob([JSON.stringify(meta)],{type:"application/json"}),{upsert:true});
  }
}

/* ===== UPLOAD IMAGES ===== */
async function uploadImages(){
  const files=el("files").files;
  if(!files.length) return;
  for(let f of files){
    const name=Date.now()+"-"+f.name;
    await sb.storage.from(BUCKET).upload(el("type").value+"/"+VID+"/"+name,f,{upsert:true});
    if(el("featured").checked){
      await sb.storage.from(BUCKET).upload("featured/"+VID+"/"+name,f,{upsert:true});
    }
  }
}

/* ===== BUTTONS ===== */
el("save").onclick=async()=>{
  try{
    await saveMeta();
    el("msg").innerText="Saved successfully";
    el("msg").className="note ok";
  }catch(e){
    el("msg").innerText="Save failed";
    el("msg").className="note err";
  }
};

el("upload").onclick=uploadImages;

el("delete").onclick=async()=>{
  if(!confirm("Delete this vehicle?"))return;
  await sb.storage.from(BUCKET).remove([el("type").value+"/"+VID]);
  await sb.storage.from(BUCKET).remove(["featured/"+VID]);
  VID=Date.now().toString();
  setVID();
};

el("new").onclick=()=>{
  VID=Date.now().toString();
  setVID();
};

el("logout").onclick=async()=>{
  await sb.auth.signOut();
  location.href="login.html";
};

document.getElementById("app").hidden=false;
</script>
</body>
</html>
