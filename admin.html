<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Second Wheel — Admin (Featured & Inventory Manager)</title>
<meta name="theme-color" content="#ffffff"/>

<style>
  :root{
    --bg:#f7f8fb; --card:#ffffff; --text:#0b0f17; --muted:#5b667a;
    --brand:#f59e0b; --ok:#22c55e; --danger:#ef4444; --line:rgba(0,0,0,.12);
    --elev:0 8px 20px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.55 system-ui}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line)}
  .wrap{max-width:1200px;margin:auto;padding:14px}
  .panel{background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px}
  .list{display:grid;gap:8px}
  .item{display:grid;grid-template-columns:56px 1fr;gap:10px;padding:8px;border:1px solid var(--line);border-radius:12px}
  .thumb{width:56px;height:56px;border-radius:8px;object-fit:cover}
  .meta small{color:#6b7280;display:block}
  input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;margin-bottom:8px}
  button{padding:10px 14px;border-radius:8px;border:none;cursor:pointer}
  .primary{background:#f59e0b}
  .danger{background:#ef4444;color:#fff}
  .secondary{background:#2563eb;color:#fff}
</style>
</head>

<body>

<header>
  <div class="wrap">
    <h2>Second Wheel — Admin</h2>
  </div>
</header>

<div class="wrap">

<!-- FEATURED LIST -->
<div class="panel">
  <h3>Featured Vehicles</h3>
  <div id="featuredList" class="list"></div>
</div>

<br>

<!-- EDITOR -->
<div class="panel">
  <b id="vidShow">VID: -</b><br><br>

  <input id="brand" placeholder="Brand">
  <input id="title" placeholder="Title / Model">
  <input id="price" type="number" placeholder="Price">
  <input id="year" type="number" placeholder="Year">
  <input id="km" type="number" placeholder="KM">
  <input id="owner" type="number" placeholder="Owner">

  <textarea id="desc" placeholder="Description"></textarea>

  <label><input type="checkbox" id="featured"> Featured</label><br><br>

  <input type="file" id="files" multiple accept="image/*">
  <br><br>

  <button class="secondary" id="btnUpload">Upload Images</button>
  <button class="primary" id="btnSave">Save</button>
  <button class="danger" id="btnDelete">Delete</button>

  <div id="status"></div>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ===== SUPABASE ===== */
var SUPABASE_URL = 'https://wbjwvxckbfkutqqbgupq.supabase.co';
var SUPABASE_KEY = 'YOUR_ANON_KEY';
var BUCKET = 'vehicals';
var sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ===== ELEMENTS ===== */
const $ = id => document.getElementById(id);
const brand=$('brand'), title=$('title'), price=$('price'),
      year=$('year'), km=$('km'), owner=$('owner'),
      desc=$('desc'), featured=$('featured'),
      featuredList=$('featuredList'),
      files=$('files'),
      statusEl=$('status'),
      vidShow=$('vidShow');

/* ===== FIX 1: ONLY NUMBER VID ===== */
function makeVID(){
  return Date.now().toString().slice(-8);
}
let CURRENT_VID = makeVID();
vidShow.textContent = 'VID: ' + CURRENT_VID;

/* ===== FIX 2: SHORT DESCRIPTION ===== */
function shortDesc(txt){
  if(!txt) return '';
  return txt.length > 45 ? txt.slice(0,45) + '…' : txt;
}

/* ===== SAVE VEHICLE ===== */
async function saveVehicle(){

  let meta={
    vid: CURRENT_VID,
    brand: brand.value.trim().toUpperCase(),
    title: title.value.trim(),
    price:Number(price.value),
    year:Number(year.value),
    km:Number(km.value),
    owner:Number(owner.value),
    description: desc.value.trim(),
    updatedAt:new Date().toISOString()
  };

  let blob=new Blob([JSON.stringify(meta,null,2)],{type:'application/json'});
  await sb.storage.from(BUCKET).upload('car/'+CURRENT_VID+'/meta.json',blob,{upsert:true});

  if(featured.checked){
    await sb.storage.from(BUCKET).upload('featured/'+CURRENT_VID+'/meta.json',blob,{upsert:true});
  }

  statusEl.textContent='Saved ✓';
  loadFeatured();
}

/* ===== UPLOAD IMAGES ===== */
async function uploadImages(){
  if(!files.files.length) return;
  for(let f of files.files){
    let name=Date.now()+'-'+f.name;
    await sb.storage.from(BUCKET).upload('car/'+CURRENT_VID+'/'+name,f,{upsert:true});
    if(featured.checked){
      await sb.storage.from(BUCKET).upload('featured/'+CURRENT_VID+'/'+name,f,{upsert:true});
    }
  }
  statusEl.textContent='Images uploaded ✓';
}

/* ===== LOAD FEATURED (SHORT DESCRIPTION ONLY) ===== */
async function loadFeatured(){
  featuredList.innerHTML='';
  let {data}=await sb.storage.from(BUCKET).list('featured');
  if(!data) return;

  for(let f of data){
    let url=sb.storage.from(BUCKET)
      .getPublicUrl('featured/'+f.name+'/meta.json').data.publicUrl;

    let res=await fetch(url);
    if(!res.ok) continue;
    let m=await res.json();

    let div=document.createElement('div');
    div.className='item';
    div.innerHTML=`
      <div class="meta">
        <b>${m.title}</b>
        <small>${m.brand} • ₹${m.price}</small>
        <small>${shortDesc(m.description)}</small>
      </div>`;
    featuredList.appendChild(div);
  }
}

$('btnSave').onclick=saveVehicle;
$('btnUpload').onclick=uploadImages;
loadFeatured();
</script>

</body>
</html>
