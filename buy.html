<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Second Wheel — Buy Vehicles</title>
  <meta name="theme-color" content="#0b0f17"/>

  <style>
    :root{
      --bg:#0b0f17; --card:#0f172a; --line:#243047;
      --text:#e5e7eb; --muted:#94a3b8; --accent:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:var(--text); font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    a{color:inherit; text-decoration:none}

    header{position:sticky; top:0; z-index:5; background:#0d1423; border-bottom:1px solid var(--line)}
    .wrap{max-width:1100px; margin:auto; padding:14px}
    .brandbar{display:flex; gap:12px; align-items:center}
    .brandbar img{height:42px; width:auto}
    h1{margin:0; font-size:18px; font-weight:700}

    /* Tabs + filters */
    .filters{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:10px; flex-wrap:wrap}
    .tabs{display:flex; gap:8px; background:#0c1322; padding:6px; border:1px solid var(--line); border-radius:999px}
    .pill{padding:8px 12px; border-radius:999px; border:1px solid var(--line); color:#cbd5e1; cursor:pointer}
    .pill.active{background:linear-gradient(180deg,#ffb02e,#b45309); color:#111; border-color:transparent}
    select, input[type="search"]{background:#0c1322; color:#e5e7eb; border:1px solid var(--line); border-radius:10px; padding:10px 12px}

    /* Grid & card */
    .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:14px; margin-top:14px}
    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; overflow:hidden}
    .body{padding:12px}
    .meta{display:flex; justify-content:space-between; align-items:center; color:#cbd5e1}
    .title{font-weight:700; color:#e2e8f0}
    .badge{font-size:12px; padding:4px 8px; border-radius:999px; background:#1f2937; border:1px solid #2f3b52}
    .actions{display:flex; gap:8px; margin-top:10px}
    .btn{padding:10px 12px; border-radius:12px; background:#0b1220; color:#eee; border:1px solid #374151; cursor:pointer}
    .btn-primary{background:linear-gradient(180deg,#ff9e0b,#b45309); color:#111; border-color:transparent}

    /* Mini carousel */
    .gallery{display:flex; gap:8px; overflow:auto; padding:8px; scroll-snap-type:x mandatory; scrollbar-width:none}
    .gallery::-webkit-scrollbar{display:none}
    .gallery img{flex:0 0 auto; width:260px; height:180px; object-fit:cover; border-radius:10px; scroll-snap-align:center; background:#0b1220}
    @media (min-width:720px){
      .gallery img{width:320px; height:200px}
    }

    footer{margin:20px 0 30px; color:var(--muted); text-align:center}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brandbar">
        <img src="https://wbjwvxckbfkutqqbgupq.supabase.co/storage/v1/object/public/vehicals/logo.png" alt="Second Wheel"/>
        <h1>Buy Vehicles</h1>
      </div>

      <div class="filters">
        <div class="tabs" id="typeTabs">
          <button class="pill active" data-type="">All</button>
          <button class="pill" data-type="Car">Car</button>
          <button class="pill" data-type="Bike">Bike</button>
          <button class="pill" data-type="Scooter">Scooter</button>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <select id="brandFilter">
            <option value="">All Brands</option>
          </select>
          <input id="q" type="search" placeholder="Search title / brand"/>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section>
      <div style="display:flex; align-items:center; gap:10px; margin:6px 0 8px">
        <span class="pill" style="background:#111827; color:#f1f5f9; border-color:#2a3448">Featured</span>
        <span class="pill" style="border-style:dashed">Latest picks</span>
      </div>
      <div id="grid" class="grid" aria-live="polite"></div>
    </section>
  </main>

  <footer class="wrap">
    &copy; 2025 Second Wheel
  </footer>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ====== EDIT येथे काहीही बदलू नका (URL/KEY सोडून) ======
    const SUPABASE_URL = 'https://wbjwvxckbfkutqqbgupq.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indiand2eGNrYmZrdXRxcWJndXBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4NzU3NDEsImV4cCI6MjA2OTQ1MTc0MX0.u_zwikgAryhF5Ccv5yOvjq20hzxE5tbYfKI04uTnNXw';
    const STORAGE_BUCKET = 'vehicals';
    const WHATSAPP = '919822292955';

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const grid = document.getElementById('grid');
    const brandFilter = document.getElementById('brandFilter');
    const q = document.getElementById('q');
    const typeTabs = document.getElementById('typeTabs');

    let ALL = [];            // सर्व vehicles
    let CURR_TYPE = '';      // फिल्टर टॅब

    // ===== Helpers =====
    function purl(path){
      if(!path) return '';
      if(/^https?:\/\//i.test(path)) return path;
      return sb.storage.from(STORAGE_BUCKET).getPublicUrl(path).data.publicUrl;
    }

    function inquiry(id){
      const v = ALL.find(x => x.id === id) || {};
      const msg = encodeURIComponent(`Hi, I'm interested in "${v.title || 'this vehicle'}".`);
      window.open(`https://wa.me/${WHATSAPP}?text=${msg}`, '_blank');
    }

    function toggleWish(id){
      const key = 'wish_'+id;
      const now = localStorage.getItem(key) ? '' : '1';
      localStorage.setItem(key, now);
      render(ALL); // UI refresh
    }

    function cardHTML(v){
      const imgs = (v.images && v.images.length ? v.images : (v.gallery || [])).map(purl);
      const pics = (imgs.length? imgs : [purl(v.image)]).filter(Boolean);
      const picsHTML = pics.slice(0,10).map(src => `<img src="${src}" alt="${v.title||'Vehicle'}">`).join('');
      const wished = localStorage.getItem('wish_'+v.id) ? '♥' : '♡';
      return `
        <div class="card">
          <div class="gallery">${picsHTML}</div>
          <div class="body">
            <div class="meta">
              <div>
                <div class="title">${v.title || '—'}</div>
                <div>${v.brand || ''} ${v.year? '• '+v.year:''}</div>
              </div>
              <span class="badge">${v.type || 'Car'}</span>
            </div>
            <div style="margin-top:6px; color:#cbd5e1">${v.description || ''}</div>
            <div class="actions">
              <button class="btn" onclick="toggleWish('${v.id}')">${wished} Wishlist</button>
              <button class="btn btn-primary" onclick="inquiry('${v.id}')">Inquiry Now</button>
            </div>
          </div>
        </div>`;
    }

    function render(list){
      // फिल्टर्स
      let out = list.filter(v => (CURR_TYPE? (v.type||'').toLowerCase()===CURR_TYPE.toLowerCase(): true));
      const b = brandFilter.value.trim().toLowerCase();
      if(b) out = out.filter(v => (v.brand||'').toLowerCase()===b);
      const s = q.value.trim().toLowerCase();
      if(s) out = out.filter(v =>
        (v.title||'').toLowerCase().includes(s) ||
        (v.brand||'').toLowerCase().includes(s)
      );

      grid.innerHTML = out.map(cardHTML).join('') || `<div style="opacity:.8">No items yet</div>`;
    }

    // ===== Data loaders =====
    async function loadFromTable(){
      const { data, error } = await sb.from('vehicles').select('*').order('created_at', { ascending:false });
      if(error) throw error;
      return data || [];
    }

    async function loadFromStorageFeatured(){
      const { data, error } = await sb.storage.from(STORAGE_BUCKET).list('featured', { limit: 100, sortBy:{column:'name', order:'desc'} });
      if(error) throw error;

      // flat files under /featured (jpeg/png/webp)
      const files = (data||[]).filter(f => /\.(jpe?g|png|webp)$/i.test(f.name));
      return files.map((f,i) => ({
        id: 'f_'+i+'_'+f.name,
        title: f.name.replace(/\.(jpe?g|png|webp)$/i,'').replace(/[_-]+/g,' '),
        brand: '',
        type: 'Car',
        images: [`featured/${f.name}`],
        description: ''
      }));
    }

    async function init(){
      try{
        // vehicles टेबल असल्यास ते वापरू; नसेल तर storage/featured fallback
        let rows = await loadFromTable();
        if(!rows.length) rows = await loadFromStorageFeatured();

        ALL = rows;

        // Brand dropdown
        const uniq = [...new Set(ALL.map(v => (v.brand||'').trim()).filter(Boolean))].sort();
        brandFilter.innerHTML = `<option value="">All Brands</option>` + uniq.map(b=>`<option>${b}</option>`).join('');

        render(ALL);
      }catch(e){
        console.error('Load error:', e);
        grid.innerHTML = `<div style="opacity:.8">Could not load vehicles.</div>`;
      }
    }

    // ===== UI wiring =====
    typeTabs.addEventListener('click', (e)=>{
      const b = e.target.closest('.pill');
      if(!b) return;
      typeTabs.querySelectorAll('.pill').forEach(p=>p.classList.remove('active'));
      b.classList.add('active');
      CURR_TYPE = b.dataset.type || '';
      render(ALL);
    });
    brandFilter.addEventListener('change', ()=>render(ALL));
    q.addEventListener('input', ()=>render(ALL));

    init();
  </script>
</body>
</html>
