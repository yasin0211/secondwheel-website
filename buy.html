<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Buy Vehicles</title>
<style>
  :root{--bg:#0b0f17;--ink:#e5e7eb;--muted:#9aa3b2;--card:#121826;--line:rgba(255,255,255,.08);--pill:#f59e0b}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  h1{margin:0 0 10px}
  .tabs{display:flex;gap:10px;margin:6px 0 14px}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.06);cursor:pointer}
  .pill.on{background:linear-gradient(180deg,#f59e0b,#b45309);color:#111;border-color:transparent}
  .grid{display:grid;gap:14px}
  @media(min-width:900px){.grid{grid-template-columns:repeat(3,1fr)}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden}
  .slides{display:flex;overflow:auto;scroll-snap-type:x mandatory;gap:8px;padding:8px;background:#0f1522}
  .slides img{flex:0 0 100%;height:220px;scroll-snap-align:start;object-fit:cover;border-radius:10px;display:block;width:100%}
  @media(min-width:720px){.slides img{height:240px}}
  .meta{padding:12px}
  .meta h3{margin:0 0 6px}
  .muted{color:var(--muted)}
  .price{float:right;font-weight:700}
  .acts{display:flex;gap:8px;margin-top:8px}
  .btn{flex:1;display:flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);cursor:pointer;background:transparent;color:var(--ink)}
  .btn.primary{background:linear-gradient(180deg,#f59e0b,#b45309);color:#111;border-color:transparent}
  .wish.on{background:rgba(245,158,11,.15);border-color:#b45309}
  .ribbon{position:absolute;left:10px;top:10px;background:var(--pill);color:#111;padding:4px 10px;border-radius:8px;font-weight:600}
  .cover{position:relative}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Buy Vehicles</h1>
    <div class="tabs">
      <button class="pill on" data-type="all">All</button>
      <button class="pill" data-type="car">Car</button>
      <button class="pill" data-type="bike">Bike</button>
      <button class="pill" data-type="scooter">Scooter</button>
      <div style="flex:1"></div>
      <span class="muted">Wishlist: <strong id="wlCount">0</strong></span>
    </div>
    <div id="grid" class="grid"></div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ------- Supabase -------
  const SUPABASE_URL = "https://wbjwvxckbfkutqqbgupq.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indiand2eGNrYmZrdXRxcWJndXBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4NzU3NDEsImV4cCI6MjA2OTQ1MTc0MX0.u_zwikgAryhF5Ccv5yOvjq20hzxE5tbYfKI04uTnNXw";
  const STORAGE_BUCKET = "vehicals";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ------- Wishlist (localStorage) -------
  const WL_KEY='sw_wishlist';
  const getWL=()=>{try{return JSON.parse(localStorage.getItem(WL_KEY)||'[]');}catch(_){return[]}};
  const setWL=(arr)=>{localStorage.setItem(WL_KEY,JSON.stringify(arr));document.getElementById('wlCount').textContent=arr.length}
  setWL(getWL());

  // ------- Filters -------
  let activeType='all';
  document.querySelectorAll('.pill[data-type]').forEach(p=>{
    p.onclick=()=>{document.querySelectorAll('.pill').forEach(x=>x.classList.remove('on')); p.classList.add('on'); activeType=p.dataset.type; render(listCache);};
  });

  // ------- Fetch + Render -------
  let listCache=[];
  async function fetchAll(){
    const {data,error}=await sb.storage.from(STORAGE_BUCKET).list('featured',{limit:500});
    if(error){ document.getElementById('grid').innerHTML='<div class="muted">Load failed</div>'; return; }
    const folders=(data||[]).filter(x=>x && !/\./.test(x.name)).map(x=>x.name);
    const out=[];
    for(const vid of folders){
      const meta = await fetchMeta(vid); if(!meta) continue;
      const images = await listImages(vid);
      out.push({vid,meta,images});
    }
    listCache=out.sort((a,b)=>(b.meta.updatedAt||'').localeCompare(a.meta.updatedAt||''));
    render(listCache);
  }

  async function fetchMeta(vid){
    const {data,error}=await sb.storage.from(STORAGE_BUCKET).download(`featured/${vid}/meta.json`);
    if(error) return null; try{ return JSON.parse(await data.text()); }catch(_){ return null; }
  }

  async function listImages(vid){
    const {data,error}=await sb.storage.from(STORAGE_BUCKET).list(`featured/${vid}`,{limit:100});
    if(error||!data) return [];
    const imgs=data.filter(o=>/\.(jpg|jpeg|png|webp)$/i.test(o.name));
    return imgs.map(im=>{
      const {data:pub}=sb.storage.from(STORAGE_BUCKET).getPublicUrl(`featured/${vid}/${im.name}`);
      return pub?.publicUrl;
    });
  }

  function render(list){
    const g=document.getElementById('grid'); g.innerHTML='';
    const filtered=list.filter(it=> activeType==='all' ? true : (it.meta.type===activeType));
    if(!filtered.length){ g.innerHTML='<div class="muted">No items yet</div>'; return; }
    const wl=getWL();
    for(const it of filtered){
      const imgs = it.images.length? it.images : ['https://dummyimage.com/1200x800/111827/ffffff&text=No+Image'];
      const card=document.createElement('div'); card.className='card';
      const sliderId='slides-'+it.vid;
      card.innerHTML=`
        <div class="cover">
          <div class="ribbon">Featured</div>
          <div id="${sliderId}" class="slides"></div>
        </div>
        <div class="meta">
          <h3>${it.meta.title||''} <span class="price">${it.meta.price||''}</span></h3>
          <div class="muted">${(it.meta.brand||'').toUpperCase()}</div>
          <div class="muted">${it.meta.year||''} • ${it.meta.km||''} km</div>
          <div class="acts">
            <button class="btn wish ${wl.includes(it.vid)?'on':''}" data-vid="${it.vid}">❤ Wishlist</button>
            <button class="btn primary" data-vid="${it.vid}">Inquiry Now</button>
          </div>
        </div>`;
      g.appendChild(card);
      // fill slides
      const slides=card.querySelector('#'+sliderId);
      imgs.forEach(u=>{
        const im=document.createElement('img'); im.src=u; im.loading='lazy'; slides.appendChild(im);
      });
      // hook buttons
      const wishBtn=card.querySelector('.wish');
      wishBtn.onclick=()=>{
        let a=getWL();
        if(a.includes(it.vid)){ a=a.filter(x=>x!==it.vid); wishBtn.classList.remove('on'); }
        else { a.push(it.vid); wishBtn.classList.add('on'); }
        setWL(a);
      };
      const inqBtn=card.querySelector('.primary');
      inqBtn.onclick=()=>{
        const txt=encodeURIComponent(`Hi, I'm interested in ${it.meta.title} (${it.meta.year}) — Price: ${it.meta.price}. VID: ${it.vid}`);
        // WhatsApp number ठेऊ इच्छित असाल तर खाली सेट करा (उदा. 91XXXXXXXXXX)
        const WHATSAPP_NUMBER = ""; 
        const url = WHATSAPP_NUMBER 
          ? `https://wa.me/${WHATSAPP_NUMBER}?text=${txt}`
          : `mailto:secondwheel@example.com?subject=${encodeURIComponent('Vehicle Inquiry — '+it.meta.title)}&body=${txt}`;
        window.open(url,'_blank');
      };
    }
  }

  fetchAll();
</script>
</body>
</html>
