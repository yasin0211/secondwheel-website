<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Second Wheel — Buy</title>
<style>
  :root{--bg:#111827;--card:#1f2937;--ink:#e5e7eb;--muted:#9aa3b2;--brand:#f59e0b;--line:rgba(255,255,255,.08)}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial}
  header{background:#0b0f17;padding:14px;text-align:center;font-weight:800;color:var(--brand)}
  .wrap{max-width:1160px;margin:0 auto;padding:16px}

  /* Top bar */
  .top{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .tabs{display:inline-grid;grid-auto-flow:column;gap:8px;background:rgba(255,255,255,.06);border:1px solid var(--line);border-radius:999px;padding:6px}
  .tabs button{border:0;background:transparent;color:var(--ink);padding:8px 12px;border-radius:999px;cursor:pointer}
  .tabs button.active{background:var(--brand);color:#111;font-weight:800}
  .filters{display:flex;gap:10px;flex-wrap:wrap}
  .filters input,.filters select{background:#0f172a;border:1px solid var(--line);color:var(--ink);padding:10px 12px;border-radius:10px;min-width:180px}

  /* Featured row */
  .featured-row{display:grid;grid-auto-flow:column;grid-auto-columns:minmax(260px,1fr);gap:12px;overflow:auto;padding-bottom:6px}
  .featured-title{display:flex;align-items:center;gap:10px;margin:10px 0}
  .pill{background:rgba(245,158,11,.18);border:1px solid var(--line);color:#fbbf24;border-radius:999px;padding:6px 10px;font-weight:700}

 /* --- Force image size patch --- */
.card img,
.slide img,
.fimg {
  width:100% !important;
  height:240px !important;   /* mobile */
  object-fit:cover !important;
  display:block !important;
  border-radius:10px !important;
}
  
@media (min-width:720px){
  .card img,
  .slide img,
  .fimg {
    height:220px !important;  /* desktop */
  }
}
</style>
</head>
<body>
<header>Buy Vehicles</header>

<main class="wrap">
  <!-- Filters -->
  <div class="top">
    <div class="tabs" id="typeTabs">
      <button data-type="" class="active">All</button>
      <button data-type="car">Car</button>
      <button data-type="bike">Bike</button>
      <button data-type="scooter">Scooter</button>
    </div>
    <div class="filters">
      <select id="brandFilter"><option value="">All Brands</option></select>
      <input id="q" type="search" placeholder="Search title or brand…">
      <span class="muted">❤️ <span id="wishCount">0</span></span>
    </div>
  </div>

  <!-- Featured -->
  <div class="featured-title">
    <span class="pill">Featured</span>
    <span class="muted">Latest picks</span>
  </div>
  <div id="featured" class="featured-row">
    <div class="muted" style="padding:8px">Loading…</div>
  </div>

  <!-- All vehicles -->
  <div id="grid" class="grid"></div>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = 'https://wbjwvxckbfkutqqbgupq.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indiand2eGNrYmZrdXRxcWJndXBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4NzU3NDEsImV4cCI6MjA2OTQ1MTc0MX0.u_zwikgAryhF5Ccv5yOvjq20hzxE5tbYfKI04uTnNXw';
const BUCKET = 'vehicals';
const WHATSAPP = '919822292955';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const grid = document.getElementById('grid');
const featuredRow = document.getElementById('featured');
const brandFilter = document.getElementById('brandFilter');
const q = document.getElementById('q');
const typeTabs = document.getElementById('typeTabs');
const wishCount = document.getElementById('wishCount');

let ALL = []; let CURR_TYPE = '';
const WKEY = 'sw_wishlist';
const getWish = ()=>{ try{return JSON.parse(localStorage.getItem(WKEY)||'[]');}catch{return[]} };
const setWish = a => { localStorage.setItem(WKEY, JSON.stringify(a)); wishCount.textContent=a.length; };
function toggleWish(id){
  const w = getWish(); const i = w.indexOf(id); if(i>=0) w.splice(i,1); else w.push(id); setWish(w);
  document.querySelectorAll(`[data-wish="${id}"]`).forEach(b=>b.classList.toggle('wish-on', w.includes(id)));
}
function purl(path){ return sb.storage.from(BUCKET).getPublicUrl(path).data.publicUrl; }
function placeholder(t){ return `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='800' height='450'><rect width='100%' height='100%' fill='%23111827'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%23f59e0b' font-family='Arial' font-size='20'>${encodeURIComponent(t||'Vehicle')}</text></svg>`; }

async function listVIDs(){
  const { data, error } = await sb.storage.from(BUCKET).list('featured', {limit:500, sortBy:{column:'name', order:'desc'}});
  if(error){ console.error(error); return []; }
  return (data||[]).filter(x=>x && !(/\./.test(x.name))).map(x=>x.name);
}
async function readMeta(id){
  const { data: files } = await sb.storage.from(BUCKET).list(`featured/${id}`, {limit:200});
  const ok = (files||[]).some(f=>f.name==='meta.json');
  if(!ok) return { id, title:id };
  const res = await sb.storage.from(BUCKET).download(`featured/${id}/meta.json`);
  if(res.error) return { id, title:id };
  try{ const m = JSON.parse(await res.data.text()); m.id=id; return m; }catch{ return { id, title:id }; }
}
async function listImages(id){
  const { data } = await sb.storage.from(BUCKET).list(`featured/${id}`, {limit:200});
  return (data||[]).filter(o=>/\.(jpg|jpeg|png|webp)$/i.test(o.name)).map(o=>purl(`featured/${id}/${o.name}`));
}

/* ----- UI builders ----- */
function card(v){
  const img = v.images?.[0] || placeholder(v.title||v.id);
  const wa = encodeURIComponent(`Hi, I am interested in ${v.title||v.id}.`);
  const wished = getWish().includes(v.id);
  return `<article class="card">
    <img class="thumb" src="${img}" alt="${v.title||v.id}">
    <div class="body">
      <strong>${v.title||v.id}</strong>
      <div class="meta" style="margin-top:6px"><span>${v.brand||''}</span><span>${v.price||''}</span></div>
      <div class="meta" style="margin-top:4px"><span>${v.year||''}</span><span>${v.km? v.km+' km':''}</span></div>
      <p class="muted" style="min-height:28px;margin:8px 0 0">${v.description||''}</p>
      <div class="actions">
        <button class="btn ${wished?'wish-on':''}" data-wish="${v.id}" onclick="toggleWish('${v.id}')">❤️ Wishlist</button>
        <a class="btn btn-primary" target="_blank" rel="noopener" href="https://wa.me/${WHATSAPP}?text=${wa}">Inquiry Now</a>
      </div>
    </div>
  </article>`;
}
function cardSmall(v){
  const img = v.images?.[0] || placeholder(v.title||v.id);
  const wa = encodeURIComponent(`Hi, I am interested in ${v.title||v.id}.`);
  return `<article class="card">
    <img class="thumb" src="${img}" alt="${v.title||v.id}">
    <div class="body">
      <strong>${v.title||v.id}</strong>
      <div class="meta" style="margin-top:6px"><span>${v.brand||''}</span><span>${v.price||''}</span></div>
      <a class="btn btn-primary" style="margin-top:8px" target="_blank" rel="noopener" href="https://wa.me/${WHATSAPP}?text=${wa}">Inquiry Now</a>
    </div>
  </article>`;
}

/* ----- Render helpers ----- */
function render(list){
  const text = (q.value||'').toLowerCase(); const brand = brandFilter.value;
  const items = list.filter(v =>
    (!CURR_TYPE || v.type===CURR_TYPE) &&
    (!brand || v.brand===brand) &&
    (!text || (v.title||'').toLowerCase().includes(text) || (v.brand||'').toLowerCase().includes(text))
  );
  grid.innerHTML = items.length ? items.map(card).join('') : '<div class="muted" style="grid-column:1/-1">No results</div>';
  wishCount.textContent = getWish().length;
}
function fillBrands(list){
  const brands = Array.from(new Set(list.map(v=>v.brand).filter(Boolean))).sort();
  brandFilter.innerHTML = '<option value="">All Brands</option>'+brands.map(b=>`<option>${b}</option>`).join('');
}

/* ----- Events ----- */
brandFilter.addEventListener('change', ()=>render(ALL));
q.addEventListener('input', ()=>render(ALL));
typeTabs.addEventListener('click', e=>{
  if(e.target.tagName==='BUTTON'){
    CURR_TYPE = e.target.dataset.type||'';
    typeTabs.querySelectorAll('button').forEach(b=>b.classList.toggle('active', b===e.target));
    render(ALL);
  }
});

/* ----- Loaders ----- */
async function loadFeatured(idsAll){
  // IDs already sorted DESC (name starts with timestamp)
  const pick = idsAll.slice(0,3);
  const rows = [];
  for(const id of pick){
    const meta = await readMeta(id);
    meta.id = id; meta.images = await listImages(id);
    rows.push(cardSmall(meta));
  }
  featuredRow.innerHTML = rows.join('') || '<div class="muted" style="padding:8px">No featured items</div>';
}

async function loadAll(){
  setWish(getWish());
  grid.innerHTML = '<div class="muted" style="grid-column:1/-1">Loading…</div>';
  const ids = await listVIDs(); 
  if(!ids.length){ 
    featuredRow.innerHTML = '<div class="muted" style="padding:8px">No featured items</div>';
    grid.innerHTML='<div class="muted" style="grid-column:1/-1">No vehicles</div>'; 
    return; 
  }
  // Featured first
  loadFeatured(ids);

  const arr = [];
  for(const id of ids){
    const meta = await readMeta(id);
    meta.id = id; meta.images = await listImages(id);
    arr.push(meta);
  }
  ALL = arr; fillBrands(arr); render(arr);
}
loadAll();
</script>
</body>
</html>
