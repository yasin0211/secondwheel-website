<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Second Wheel ‚Äî Buy</title>
<meta name="theme-color" content="#0b0f17"/>
<style>
  :root{
    --bg:#0b0f17; --card:#121826; --text:#e5e7eb; --muted:#9aa3b2;
    --brand:#f59e0b; --brand2:#22c55e; --line:rgba(255,255,255,.10);
    --shadow:0 10px 28px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  a{color:inherit;text-decoration:none}
  img{max-width:100%;display:block}

  /* Header */
  header{position:sticky;top:0;z-index:30;background:rgba(11,15,23,.78);backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
  .wrap{max-width:1180px;margin:0 auto;padding:12px 16px}
  .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .brand{display:flex;align-items:center;gap:12px}
  .brand img{width:56px;height:56px;border-radius:14px;box-shadow:var(--shadow)}
  .brand h1{margin:0;font-size:16px;letter-spacing:.4px}
  .seg{display:inline-flex;gap:8px;padding:6px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.04)}
  .seg button{border:0;background:transparent;padding:10px 14px;border-radius:999px;color:var(--text);cursor:pointer}
  .seg button.active{background:var(--brand);color:#111;font-weight:800}
  .util{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.06);cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .btn.round{border-radius:999px}
  .btn.primary{background:linear-gradient(180deg,#f59e0b,#b45309);color:#111;border:none}

  /* Tabs row (Cars/Bikes/Scooters) */
  .tabs{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .chip{padding:10px 16px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.06);cursor:pointer}
  .chip.active{background:var(--brand);color:#111;font-weight:800;border-color:transparent}

  /* Filters */
  .filters{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .input, .select{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0f1626;color:var(--text);outline:none}
  .muted{color:var(--muted)}

  /* Grid */
  .grid{display:grid;grid-template-columns:repeat(1,1fr);gap:14px;margin-top:14px}
  @media(min-width:680px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media(min-width:1040px){ .grid{grid-template-columns:repeat(3,1fr)} }

  /* Vehicle Card */
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
  .media{position:relative}
  .media img.main{width:100%;height:260px;object-fit:cover}
  @media(min-width:720px){ .media img.main{height:220px} }

  .thumbbar{display:flex;gap:6px;padding:8px;overflow:auto;background:#0f1626;border-top:1px solid var(--line)}
  .thumb{width:64px;height:48px;border-radius:8px;object-fit:cover;border:2px solid transparent;cursor:pointer;flex:0 0 auto}
  .thumb.active{border-color:#f59e0b}

  .badge{position:absolute;top:10px;left:10px;background:var(--brand);color:#111;font-weight:800;font-size:12px;padding:4px 8px;border-radius:999px}
  .body{padding:12px}
  .title{font-weight:800;margin:0 0 6px}
  .meta{display:flex;gap:10px;flex-wrap:wrap;font-size:12px;color:#cbd5e1}
  .desc{margin-top:8px;color:#d1d5db;max-height:9.6em;overflow:auto;border-top:1px solid var(--line);padding-top:8px;white-space:pre-wrap}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .wish{background:rgba(255,255,255,.06);border:1px solid var(--line)}
  .wish.active{background:rgba(34,197,94,.15);border-color:rgba(34,197,94,.45)}

  /* Lightbox */
  .lightbox{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.88);z-index:60}
  .lightbox.show{display:flex}
  .lb-img{max-width:92vw;max-height:86vh;border-radius:14px;box-shadow:var(--shadow)}
  .navBtn{position:absolute;top:50%;transform:translateY(-50%);padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.45);cursor:pointer}
  .navBtn.l{left:16px} .navBtn.r{right:16px}
  .navBtn:active{transform:translateY(-50%) scale(.98)}
  .closeBtn{position:absolute;top:16px;right:16px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.45);cursor:pointer}

  /* Toast */
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#111827;color:#e5e7eb;border:1px solid var(--line);padding:10px 14px;border-radius:10px;box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:opacity .25s}
  .toast.show{opacity:1}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <div class="brand">
        <img src="https://wbjwvxckbfkutqqbgupq.supabase.co/storage/v1/object/public/vehicals/logo.png" alt="Second Wheel logo"/>
        <h1>SECOND WHEEL</h1>
      </div>
      <div class="util">
        <div class="seg" id="langSeg">
          <button data-lang="en" class="active">EN</button>
          <button data-lang="hi">HI</button>
          <button data-lang="mr">MR</button>
        </div>
        <button class="btn round" id="darkToggle" aria-label="Toggle dark">üåô</button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs" id="tabs">
      <button class="chip active" data-type="car" data-i18n="tabs.cars">üöó Cars</button>
      <button class="chip" data-type="bike" data-i18n="tabs.bikes">üèçÔ∏è Bikes</button>
      <button class="chip" data-type="scooter" data-i18n="tabs.scooters">üõµ Scooters</button>
    </div>

    <!-- Filters -->
    <div class="filters">
      <input id="q" class="input" placeholder="Search (Title / Brand)"/>
      <select id="brandFilter" class="select"><option value="">All Brands</option></select>
      <span class="muted" id="count">‚Äî</span>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="grid" class="grid" aria-live="polite"></div>
</main>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" role="dialog" aria-modal="true">
  <img id="lbImg" class="lb-img" alt=""/>
  <button class="navBtn l" id="lbPrev">‚ü®</button>
  <button class="navBtn r" id="lbNext">‚ü©</button>
  <button class="closeBtn" id="lbClose">‚úï</button>
</div>

<div id="toast" class="toast">Saved!</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* -------------------- i18n -------------------- */
const I18N = {
  en:{ 'tabs.cars':'Cars','tabs.bikes':'Bikes','tabs.scooters':'Scooters','btn.wishlist':'Wishlist','btn.enquire':'Enquire Now' },
  hi:{ 'tabs.cars':'‡§ï‡§æ‡§∞‡•á‡§Ç','tabs.bikes':'‡§¨‡§æ‡§á‡§ï‡•ç‡§∏','tabs.scooters':'‡§∏‡•ç‡§ï‡•Ç‡§ü‡§∞','btn.wishlist':'‡§µ‡§ø‡§∂‡§≤‡§ø‡§∏‡•ç‡§ü','btn.enquire':'‡§è‡§®‡•ç‡§ï‡•ç‡§µ‡§æ‡§Ø‡§∞ ‡§®‡§æ‡§â' },
  mr:{ 'tabs.cars':'‡§ï‡§æ‡§∞‡•ç‡§∏','tabs.bikes':'‡§¨‡§æ‡§à‡§ï‡•ç‡§∏','tabs.scooters':'‡§∏‡•ç‡§ï‡•Ç‡§ü‡§∞‡•ç‡§∏','btn.wishlist':'‡§µ‡§ø‡§∂‡§≤‡§ø‡§∏‡•ç‡§ü','btn.enquire':'‡§á‡§®‡•ç‡§ï‡•ç‡§µ‡§æ‡§Ø‡§∞‡•Ä' },
};
const langSeg=document.getElementById('langSeg');
function toast(t){ const el=document.getElementById('toast'); el.textContent=t; el.classList.add('show'); clearTimeout(window.__t); window.__t=setTimeout(()=>el.classList.remove('show'),1500); }
function applyLang(l){
  localStorage.setItem('lang', l);
  [...langSeg.querySelectorAll('button')].forEach(b=>b.classList.toggle('active', b.dataset.lang===l));
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const k=el.getAttribute('data-i18n');
    if(I18N[l] && I18N[l][k]) el.textContent = I18N[l][k];
  });
  toast('Language: '+l.toUpperCase());
}
langSeg.addEventListener('click', e=>{ if(e.target.tagName==='BUTTON') applyLang(e.target.dataset.lang);});
applyLang(localStorage.getItem('lang') || 'en');

/* -------------------- Dark mode -------------------- */
const DARK_KEY='secondwheel.dark';
const darkBtn=document.getElementById('darkToggle');
function applyDark(v){ document.documentElement.style.colorScheme = v?'dark':'light'; localStorage.setItem(DARK_KEY, v?'1':'0'); darkBtn.textContent = v?'üåô':'‚òÄÔ∏è'; }
darkBtn.addEventListener('click', ()=>applyDark(!(localStorage.getItem(DARK_KEY)==='1')));
applyDark(localStorage.getItem(DARK_KEY)==='1');

/* -------------------- Supabase -------------------- */
const SUPABASE_URL='https://wbjwvxckbfkutqqbgupq.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indiand2eGNrYmZrdXRxcWJndXBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4NzU3NDEsImV4cCI6MjA2OTQ1MTc0MX0.u_zwikgAryhF5Ccv5yOvjq20hzxE5tbYfKI04uTnNXw';
const BUCKET='vehicals';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const grid = document.getElementById('grid');
const brandFilter = document.getElementById('brandFilter');
const q = document.getElementById('q');
const count = document.getElementById('count');

/* -------------------- State -------------------- */
let ACTIVE = 'car';                // car | bike | scooter
let DATA = [];                     // [{vid, meta, imgs:[url], coverIndex}]
let WISHLIST = new Set(JSON.parse(localStorage.getItem('wishlist')||'[]'));

/* -------------------- Helpers -------------------- */
function pubUrl(path){ const { data } = sb.storage.from(BUCKET).getPublicUrl(path); return data?.publicUrl || ''; }
function isImg(n){ return /\.(jpe?g|png|webp|avif)$/i.test(n); }
function limitFor(type){ return type==='car' ? 20 : 10; }
function money(n){ if(!n && n!==0) return '‚Çπ‚Äî'; try{ return '‚Çπ'+Number(n).toLocaleString('en-IN'); }catch(e){ return '‚Çπ'+n; } }
function wishToggle(vid){ if(WISHLIST.has(vid)){ WISHLIST.delete(vid); } else { WISHLIST.add(vid); } localStorage.setItem('wishlist', JSON.stringify([...WISHLIST])); render(); toast('Wishlist updated'); }
function waLink(meta){ const msg = encodeURIComponent(`Hi Second Wheel,%0AI want to enquire about:%0A${meta.title} (${meta.brand})%0AType: ${meta.type}%0APrice: ${money(meta.price)}%0AYear: ${meta.year} ‚Ä¢ KM: ${meta.km}%0AID: ${meta.vid}`); return `https://wa.me/919822292955?text=${msg}`; }

/* -------------------- Lightbox -------------------- */
const lb = document.getElementById('lightbox'), lbImg=document.getElementById('lbImg'), lbPrev=document.getElementById('lbPrev'), lbNext=document.getElementById('lbNext'), lbClose=document.getElementById('lbClose');
let LB_LIST=[], LB_IDX=0;
function openLB(list, idx){ LB_LIST=list; LB_IDX=idx; lbImg.src=list[idx]; lb.classList.add('show'); }
function closeLB(){ lb.classList.remove('show'); LB_LIST=[]; }
function stepLB(d){ if(!LB_LIST.length) return; LB_IDX=(LB_IDX+d+LB_LIST.length)%LB_LIST.length; lbImg.src=LB_LIST[LB_IDX]; }
lbClose.onclick=closeLB; lbPrev.onclick=()=>stepLB(-1); lbNext.onclick=()=>stepLB(1);
lb.addEventListener('click', e=>{ if(e.target===lb) closeLB(); });
lb.addEventListener('touchstart', onTouchStart, {passive:true});
lb.addEventListener('touchend', onTouchEnd, {passive:true});
let x0=null; function onTouchStart(e){ x0=e.changedTouches[0].clientX; }
function onTouchEnd(e){ const x1=e.changedTouches[0].clientX; if(x0===null) return; const dx=x1-x0; if(Math.abs(dx)>40) stepLB(dx>0?-1:1); x0=null; }

/* -------------------- Loaders -------------------- */
async function list(prefix){
  try{
    const { data, error } = await sb.storage.from(BUCKET).list(prefix, { limit: 200 });
    if(error){ console.error('list error', prefix, error); return []; }
    return data || [];
  }catch(e){ console.error('list exception', prefix, e); return []; }
}
async function allImgUrls(prefix, max){
  const arr = await list(prefix);
  const imgs = arr.filter(f=>isImg(f.name)).sort((a,b)=>a.name.localeCompare(b.name)).slice(0,max);
  return imgs.map(f=>pubUrl(`${prefix}/${f.name}`)).filter(Boolean);
}
async function fetchMeta(prefix){
  try{
    const { data } = sb.storage.from(BUCKET).getPublicUrl(`${prefix}/meta.json`);
    if(!data || !data.publicUrl) return null;
    const res = await fetch(data.publicUrl, { cache:'no-store' });
    if(res.ok) return await res.json();
  }catch(e){ console.warn('meta fetch failed', prefix, e); }
  return null;
}

async function loadType(type){
  ACTIVE = type;
  grid.innerHTML = '<div class="muted" style="padding:16px">Loading‚Ä¶</div>';
  const roots = await list(type);
  const folders = roots.filter(x=>x && x.name && !(/\./.test(x.name))); // only VIDs
  const out=[]; const brands = new Set(); const lim = limitFor(type);
  for(const f of folders){
    const vid = f.name; const base = `${type}/${vid}`;
    const meta = await fetchMeta(base);
    if(!meta) continue;
    const imgs = await allImgUrls(base, lim);
    if(!imgs.length){
      // fallback: show logo so card still appears (optional)
      const logo = pubUrl('vehicals/logo.png');
      if(logo) imgs.push(logo); else continue;
    }
    meta.vid = meta.vid || vid;
    meta.type = meta.type || type;
    out.push({ vid, meta, imgs, coverIndex:0 });
    if(meta.brand) brands.add(String(meta.brand).toUpperCase());
  }
  DATA = out.sort((a,b)=> (b.meta.updatedAt||'').localeCompare(a.meta.updatedAt||''));

  fillBrands([...brands].sort());
  render();
}

function fillBrands(list){
  const curr = brandFilter.value;
  brandFilter.innerHTML = '<option value="">All Brands</option>'+list.map(b=>`<option value="${b}">${b}</option>`).join('');
  if(curr) brandFilter.value = curr;
}

/* -------------------- Render -------------------- */
function render(){
  const term = (q.value||'').toLowerCase().trim();
  const bf = (brandFilter.value||'').trim();
  const view = DATA.filter(it=>{
    const hitQ = !term || ((it.meta.title||'').toLowerCase().includes(term) || (it.meta.brand||'').toLowerCase().includes(term));
    const hitB = !bf || ((String(it.meta.brand||'').toUpperCase())===bf);
    return hitQ && hitB;
  });

  count.textContent = `${view.length} ${ACTIVE.toUpperCase()} found`;
  grid.innerHTML = '';
  if(view.length===0){ grid.innerHTML = '<div class="muted" style="padding:16px">No results</div>'; return; }

  for(const it of view){
    const meta = it.meta;
    const cover = it.imgs[it.coverIndex||0];

    const card = document.createElement('div');
    card.className = 'card';

    // MEDIA (main + thumbs)
    const media = document.createElement('div');
    media.className = 'media';

    const main = document.createElement('img');
    main.className = 'main';
    main.src = cover; main.alt = meta.title||'';
    main.onclick = ()=> openLB(it.imgs, it.coverIndex||0);
    media.appendChild(main);

    const badge=document.createElement('div'); badge.className='badge'; badge.textContent = (meta.type||ACTIVE).toUpperCase();
    media.appendChild(badge);

    const thumbbar=document.createElement('div'); thumbbar.className='thumbbar';
    it.imgs.forEach((u,idx)=>{
      const t=document.createElement('img'); t.className='thumb'+(idx===it.coverIndex?' active':''); t.src=u; t.alt='thumb';
      t.onclick=(e)=>{ e.stopPropagation(); it.coverIndex=idx; main.src=u; [...thumbbar.children].forEach(c=>c.classList.remove('active')); t.classList.add('active'); };
      thumbbar.appendChild(t);
    });
    media.appendChild(thumbbar);

    // BODY
    const body=document.createElement('div'); body.className='body';
    const h=document.createElement('h3'); h.className='title'; h.textContent = meta.title || '-';
    const metaRow=document.createElement('div'); metaRow.className='meta';
    metaRow.innerHTML = `
      <span><b>${(meta.brand||'').toUpperCase()}</b></span>
      <span>${meta.year||'‚Äî'}</span>
      <span>${(meta.km? (Number(meta.km).toLocaleString('en-IN')+' km') : '‚Äî')}</span>
      <span>${money(meta.price)}</span>
      <span>ID: ${meta.vid||it.vid}</span>
    `;

    const desc=document.createElement('div'); desc.className='desc';
    desc.textContent = meta.description || '';

    const actions=document.createElement('div'); actions.className='actions';
    const wbtn=document.createElement('button'); wbtn.className='btn wish'+(WISHLIST.has(meta.vid||it.vid)?' active':''); wbtn.innerHTML='‚ô• <span data-i18n="btn.wishlist">Wishlist</span>';
    wbtn.onclick=()=>wishToggle(meta.vid||it.vid);
    const ebtn=document.createElement('a'); ebtn.className='btn primary'; ebtn.innerHTML='üí¨ <span data-i18n="btn.enquire">Enquire Now</span>';
    ebtn.href = waLink(meta); ebtn.target='_blank'; ebtn.rel='noopener';

    actions.appendChild(wbtn); actions.appendChild(ebtn);

    body.appendChild(h); body.appendChild(metaRow); body.appendChild(desc); body.appendChild(actions);

    card.appendChild(media); card.appendChild(body);
    grid.appendChild(card);
  }

  // IMPORTANT: freshly-added nodes ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§Ö‡§∏‡§≤‡•á‡§≤‡•ç‡§Ø‡§æ data-i18n ‡§∏‡§æ‡§†‡•Ä language ‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§≤‡§æ‡§µ‡§æ
  const currLang = localStorage.getItem('lang') || 'en';
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const k=el.getAttribute('data-i18n');
    if(I18N[currLang] && I18N[currLang][k]) el.textContent = I18N[currLang][k];
  });
}

/* -------------------- Events -------------------- */
document.getElementById('tabs').addEventListener('click', e=>{
  const btn = e.target.closest('.chip');
  if(!btn) return;
  [...document.querySelectorAll('.chip')].forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  loadType(btn.dataset.type);
});
q.addEventListener('input', render);
brandFilter.addEventListener('change', render);

/* -------------------- Init -------------------- */
loadType(ACTIVE);
</script>
</body>
</html>
