<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Second Wheel — Sell Your Vehicle</title>
<meta name="theme-color" content="#0b0f17"/>
<style>
  /* THEME TOKENS */
  :root{
    --bg:#f7f8fb; --text:#0b0f17; --muted:#5b667a; --line:rgba(0,0,0,.12);
    --header-bg:rgba(255,255,255,.9); --card:#ffffff;
    --input:#f2f4f8; --btn-grad1:#f59e0b; --btn-grad2:#b45309;
    --ok1:#22c55e; --ok2:#15803d; --shadow:0 10px 22px rgba(0,0,0,.10);
  }
  :root[data-theme="dark"]{
    --bg:#0b0f17; --text:#e5e7eb; --muted:#9aa3b2; --line:rgba(255,255,255,.12);
    --header-bg:rgba(11,15,23,.85); --card:#121826;
    --input:#0f1626; --btn-grad1:#f59e0b; --btn-grad2:#b45309;
    --ok1:#22c55e; --ok2:#15803d; --shadow:0 12px 32px rgba(0,0,0,.35);
  }

  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:980px;margin:0 auto;padding:16px}

  header{position:sticky;top:0;z-index:20;background:var(--header-bg);backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
  .flex{display:flex;align-items:center;gap:10px}.space{justify-content:space-between}
  .brand img{width:44px;height:44px;border-radius:12px;box-shadow:var(--shadow)} .brand h1{margin:0;font-size:16px;letter-spacing:.3px}

  .seg{display:inline-flex;gap:6px;padding:6px;border:1px solid var(--line);border-radius:999px;background:rgba(0,0,0,.04)}
  :root[data-theme="dark"] .seg{background:rgba(255,255,255,.06)}
  .seg button{border:0;background:transparent;padding:8px 12px;border-radius:999px;color:var(--text);cursor:pointer}
  .seg button.active{background:var(--btn-grad1);color:#111;font-weight:800}

  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,.03);cursor:pointer}
  :root[data-theme="dark"] .btn{background:rgba(255,255,255,.06)}
  .btn.primary{background:linear-gradient(180deg,var(--btn-grad1),var(--btn-grad2));color:#111;border:none}
  .btn.ok{background:linear-gradient(180deg,var(--ok1),var(--ok2));color:#111;border:none}
  .btn:disabled{opacity:.55;cursor:not-allowed}

  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)}
  .pad{padding:16px}
  .title{margin:0 0 8px;font-weight:900}
  .muted{color:var(--muted)}
  .row{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:720px){ .row{grid-template-columns:repeat(2,1fr)} }
  label{font-weight:700;margin:6px 2px;display:block}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--input);color:var(--text);outline:none}

  .steps{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin:10px 0 14px}
  .step{padding:8px 10px;border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,.04);font-weight:700;text-align:center}
  :root[data-theme="dark"] .step{background:rgba(255,255,255,.06)}
  .step.active{background:var(--btn-grad1);color:#111;border-color:transparent}
  .progress{height:6px;background:#d8dde7;border-radius:999px;overflow:hidden;margin-top:6px}
  :root[data-theme="dark"] .progress{background:#1f2937}
  .bar{height:100%;background:linear-gradient(90deg,var(--btn-grad1),#ef4444);width:0%}

  .gauge{position:relative;height:10px;background:#e9edf5;border-radius:999px;overflow:hidden;border:1px solid var(--line);margin-top:6px}
  :root[data-theme="dark"] .gauge{background:#111827}
  .g1{height:100%;background:#ef4444;width:33%}.g2{height:100%;background:#f59e0b;width:34%}.g3{height:100%;background:#22c55e;width:33%}
  .range{display:flex;justify-content:space-between;margin:6px 2px 0}
  .big{font-size:28px;font-weight:900}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.04);font-weight:700}
  :root[data-theme="dark"] .pill{background:rgba(255,255,255,.06)}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#111827;color:#e5e7eb;border:1px solid var(--line);padding:10px 14px;border-radius:10px;box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:opacity .25s}
  :root[data-theme="light"] .toast{background:#ffffff;color:#111}
  .toast.show{opacity:1}

  /* Admin badge */
  body[data-mode="admin"]::after{
    content:"DEALER MODE";
    position:fixed; right:10px; bottom:10px; z-index:9999;
    background:#16a34a; color:#0b0f17; padding:6px 10px; border-radius:8px; font-weight:800;
    box-shadow:0 6px 18px rgba(0,0,0,.35);
  }
</style>
</head>
<body>
<header>
  <div class="wrap flex space">
    <div class="brand flex">
      <img src="https://wbjwvxckbfkutqqbgupq.supabase.co/storage/v1/object/public/vehicals/logo.png" alt="Second Wheel">
      <h1>SECOND WHEEL</h1>
    </div>
    <div class="flex" style="gap:8px">
      <div class="seg" id="langSeg"><button data-lang="en" class="active">EN</button><button data-lang="hi">HI</button><button data-lang="mr">MR</button></div>
      <button id="themeBtn" class="btn" aria-label="Toggle theme">☀️</button>
    </div>
  </div>
</header>

<!-- Hidden On-road Catalog (sample) -->
<script type="application/json" id="onroad-data">
[
  { "brand":"Toyota","model":"INNOVA CRYSTA","variant":"GX", "fuel":"Diesel",  "onroad_price": 2700000, "year_from":2016, "year_to":2022 },
  { "brand":"Hyundai","model":"I10","variant":"MAGNA", "fuel":"Petrol", "onroad_price": 485000, "year_from":2008, "year_to":2011 },
  { "brand":"Maruti Suzuki","model":"ALTO K10","variant":"VXI","fuel":"Petrol","onroad_price": 520000, "year_from":2014, "year_to":2020 }
]
</script>

<main class="wrap" id="app">
  <div class="card pad">
    <h2 class="title" data-i="title">Sell Your Vehicle</h2>
    <div class="steps">
      <div class="step active" id="h1" data-i="s1h">1. Customer</div>
      <div class="step" id="h2" data-i="s2h">2. Vehicle</div>
      <div class="step" id="h3" data-i="s3h">3. Specs</div>
      <div class="step" id="h4" data-i="s4h">4. Condition</div>
      <div class="step" id="h5" data-i="s5h">5. Result</div>
    </div>
    <div class="progress"><div class="bar" id="bar"></div></div>
  </div>

  <!-- STEP 1 -->
  <section class="card pad" id="s1">
    <h3 class="title" data-i="s1.title">Customer Details</h3>
    <div class="row">
      <div><label data-i="s1.name">Name</label><input id="name" placeholder="Your name"/></div>
      <div><label data-i="s1.phone">Mobile Number</label><input id="phone" inputmode="numeric" maxlength="10" placeholder="10-digit"/></div>
      <div><label data-i="s1.city">City</label><input id="city" placeholder="Satara"/></div>
      <div><label data-i="s1.notes">Notes (optional)</label><input id="notes" placeholder="Any info…"/></div>
    </div>
    <div class="flex" style="gap:10px;margin-top:12px">
      <button class="btn primary" id="next1" data-i="next">Continue</button>
    </div>
  </section>

  <!-- STEP 2 -->
  <section class="card pad" id="s2" hidden>
    <h3 class="title" data-i="s2.title">Vehicle Basics</h3>
    <div class="row">
      <div><label data-i="s2.brand">Brand</label><input id="brand" placeholder="Maruti / Hyundai / Honda…"/></div>
      <div><label data-i="s2.model">Model</label><input id="model" placeholder="Swift / Alto K10 / i10…"/></div>
      <div>
        <label data-i="s2.body">Body Type</label>
        <select id="body">
          <option>Hatchback</option><option>Sedan</option><option>Micro</option><option>SUV</option>
          <option>Bike</option><option>Scooter</option><option>EV Car</option><option>EV Bike</option><option>EV Scooter</option>
        </select>
      </div>
      <div>
        <label data-i="s2.seats">Seating</label>
        <select id="seats"><option>4/5</option><option>6</option><option>7</option></select>
      </div>
      <div><label>Registration No.</label><input id="reg" placeholder="MH12 AB 1234"/></div>
    </div>
    <div class="flex" style="gap:10px;margin-top:12px">
      <button class="btn" id="back2" data-i="back">Back</button>
      <button class="btn primary" id="next2" data-i="next">Continue</button>
    </div>
  </section>

  <!-- STEP 3 -->
  <section class="card pad" id="s3" hidden>
    <h3 class="title" data-i="s3.title">Specs</h3>
    <div class="row">
      <div><label>Year</label><input id="year" type="number" min="2001" max="2030" placeholder="2018"/></div>
      <div><label>Fuel</label><select id="fuel">
        <option>Petrol</option><option>Diesel</option>
        <option>CNG (Company)</option><option>CNG (Aftermarket)</option>
        <option>LPG (Company)</option><option>LPG (Aftermarket)</option>
        <option>Electric</option></select>
      </div>
      <div><label>KM</label><input id="km" type="number" min="0" step="500" placeholder="60000"/></div>
      <div id="transWrap"><label>Transmission</label><select id="trans"><option>Manual</option><option>Automatic</option></select></div>
      <div><label>Owners</label><select id="owners"><option>1st</option><option>2nd</option><option>3rd</option><option>4th+</option></select></div>
      <div><label>Color</label><select id="color"><option>White</option><option>Silver</option><option>Grey</option><option>Black</option><option>Blue</option><option>Red</option><option>Other</option></select></div>
      <div><label>New Price (optional)</label><input id="newPrice" type="number" min="0" placeholder="Ex-Showroom / On-Road"/></div>
    </div>
    <div class="flex" style="gap:10px;margin-top:12px">
      <button class="btn" id="back3" data-i="back">Back</button>
      <button class="btn primary" id="next3" data-i="next">Continue</button>
    </div>
  </section>

  <!-- STEP 4 -->
  <section class="card pad" id="s4" hidden>
    <h3 class="title" data-i="s4.title">Condition & Compliance</h3>
    <div class="row">
      <div><label>RC</label><select id="rc"><option>Valid</option><option>Expired</option></select></div>
      <div><label>Insurance</label><select id="ins"><option>Valid</option><option>Expired</option></select></div>
      <div><label>Insurance Valid Till (DD/MM/YYYY)</label><input type="date" id="insTill"/></div>
      <div><label>PUC / Green Tax</label><select id="puc"><option>Valid / Paid</option><option>Expired</option></select></div>
      <div><label>Fitness Certificate</label><select id="fit"><option>Not Required (age &lt; 15)</option><option>Available</option><option>Not Available</option></select></div>
      <div><label>Fitness Expiry (DD/MM/YYYY)</label><input type="date" id="fitExpiry"/></div>
      <div><label>Overall Condition</label><select id="cond"><option>Excellent</option><option>Good</option><option>Average</option><option>Poor</option></select></div>
      <div><label>Inspection Date</label><input type="date" id="datePick"/></div>
      <div><label>Time Slot</label><select id="timePick"><option>10am - 1pm</option><option>3pm - 4pm</option><option>5pm - 7pm</option></select></div>
    </div>
    <div class="flex" style="gap:10px;margin-top:12px">
      <button class="btn" id="back4" data-i="back">Back</button>
      <button class="btn primary" id="calc" data-i="calc">Get Valuation</button>
    </div>
  </section>

  <!-- STEP 5 -->
  <section class="card pad" id="s5" hidden>
    <h3 class="title">Your Estimated Price</h3>
    <div class="flex" style="gap:10px;flex-wrap:wrap;margin-bottom:10px">
      <span class="pill" id="tagBody">—</span>
      <span class="pill" id="tagBrand">—</span>
      <span class="pill" id="tagYear">—</span>
      <span class="pill" id="tagKm">—</span>
      <span class="pill" id="tagRTO">—</span>
      <span class="pill" id="tagIns">—</span>
      <span class="pill" id="tagFit">—</span>
      <span class="pill" id="tagCond">—</span>
    </div>
    <div class="gauge"><div class="g1"></div><div class="g2"></div><div class="g3"></div></div>
    <div class="range"><div class="muted">Conservative</div><div class="muted">Average</div><div class="muted">Excellent</div></div>
    <div class="flex space" style="margin-top:12px;align-items:flex-end">
      <div><div class="muted">Estimated Range</div><div class="big"><span id="min">₹—</span> — <span id="max">₹—</span></div></div>
      <div><div class="muted">Most Likely</div><div class="big" id="mid">₹—</div></div>
    </div>
    <div class="flex" style="gap:10px;margin-top:12px;flex-wrap:wrap">
      <a id="wa" class="btn primary" target="_blank" rel="noopener"
         href="https://wa.me/919822292955?text=Hi%20I%20want%20final%20quote">💬 WhatsApp Final Quote</a>
      <a id="call" class="btn" href="tel:+919822292955">📞 Call Now</a>
      <button id="saveLead" class="btn ok">🚗 Book Doorstep Inspection</button>
      <button id="again" class="btn" style="margin-left:auto">↺ Recalculate</button>
    </div>
    <p class="muted" style="margin-top:10px">*Final price depends on physical inspection and compliance documents.</p>
  </section>
</main>

<!-- FOOTER (same as index) -->
<footer class="sw-footer">
  <style>
    .sw-footer {background:#0e1116;color:#c9d1d9;border-top:1px solid #222;margin-top:40px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Noto Sans',sans-serif;}
    .sw-footer .wrap {max-width:1100px;margin:auto;padding:28px 16px;}
    .sw-footer h3 {margin:0 0 6px;font-size:20px;letter-spacing:.4px;}
    .sw-footer p.muted {margin:0 0 16px;color:#9aa4ad;font-size:13px;}
    .sw-grid {display:grid;grid-template-columns:1.2fr 1fr 1fr 1.2fr;gap:20px;}
    .sw-col h4 {margin:0 0 10px;font-size:14px;color:#aab2bd;text-transform:uppercase;letter-spacing:.6px;}
    .sw-col a {display:flex;align-items:center;gap:6px;margin:6px 0;color:#d6dde4;text-decoration:none;font-size:14px;}
    .sw-col a:hover {color:#fff;text-decoration:underline;}
    .sw-col img {width:16px;height:16px;}
    .sw-bottom {border-top:1px solid #222;margin-top:18px;padding:10px 0;color:#9aa4ad;font-size:12px;text-align:center;}
    @media (max-width:900px){.sw-grid{grid-template-columns:1fr 1fr}}
    @media (max-width:560px){.sw-grid{grid-template-columns:1fr}}
  </style>
  <div class="wrap">
    <div class="sw-grid">
      <div class="sw-col">
        <h3>SECOND WHEEL</h3>
        <p class="muted">Trusted Vehicles, Smart Deals</p>
      </div>
      <div class="sw-col">
        <h4>Company</h4>
        <a href="about.html">About Us</a><a href="contact.html">Contact Us</a>
      </div>
      <div class="sw-col">
        <h4>Legal</h4>
        <a href="terms.html">Terms &amp; Conditions</a><a href="privacy.html">Privacy Policy</a>
      </div>
      <div class="sw-col">
        <h4>Follow Us</h4>
        <a href="https://www.instagram.com/secondwheel.in?igsh=b3V0c3l4dnhoa2pt" target="_blank">
          <img src="https://cdn-icons-png.flaticon.com/512/2111/2111463.png" alt="Instagram"> Instagram</a>
        <a href="https://www.facebook.com/secondwheelin/" target="_blank">
          <img src="https://cdn-icons-png.flaticon.com/512/733/733547.png" alt="Facebook"> Facebook Page</a>
        <a href="https://www.facebook.com/groups/secondwheelin/" target="_blank">
          <img src="https://cdn-icons-png.flaticon.com/512/5968/5968764.png" alt="Facebook Group"> Facebook Group</a>
      </div>
    </div>
    <div class="sw-bottom"><span id="yr"></span> © Second Wheel — All rights reserved.</div>
  </div>
  <script>document.getElementById('yr').textContent=new Date().getFullYear();</script>
</footer>

<div id="toast" class="toast">Saved!</div>

<script>
/* ------------ CONFIG ------------ */
const THEME_KEY='secondwheel.theme';
const SW_MODE_KEY='sw.mode.v1';
const ADMIN_PIN='7264'; // Dealer PIN

/* ------------ Mode Bootstrap ------------ */
function setMode(m){ window.SW_MODE=m; document.body.dataset.mode=m; }
function isAdmin(){ return window.SW_MODE==='admin'; }
(function initMode(){
  setMode('public');
  const saved=+localStorage.getItem(SW_MODE_KEY)||0;
  if(saved && (Date.now()-saved)<24*60*60*1000) setMode('admin');
  document.addEventListener('keydown',(e)=>{
    if(e.altKey && e.shiftKey && e.code==='KeyA'){
      const pin=prompt('Enter admin PIN'); if(pin===ADMIN_PIN){ localStorage.setItem(SW_MODE_KEY,String(Date.now())); setMode('admin'); alert('Dealer mode ON'); }
    }
  });
})();

/* ------------ Theme ------------ */
const themeBtn=document.getElementById('themeBtn');
function setTheme(t){ document.documentElement.setAttribute('data-theme', t==='dark'?'dark':'light'); localStorage.setItem(THEME_KEY,t); themeBtn.textContent=t==='dark'?'🌙':'☀️'; }
setTheme(localStorage.getItem(THEME_KEY)||'light');
themeBtn.onclick=()=> setTheme((localStorage.getItem(THEME_KEY)||'light')==='dark'?'light':'dark');

/* ------------ I18N (short) ------------ */
const I18N={en:{title:'Sell Your Vehicle',next:'Continue',back:'Back',calc:'Get Valuation',
s1h:'1. Customer',s2h:'2. Vehicle',s3h:'3. Specs',s4h:'4. Condition',s5h:'5. Result',
's1.title':'Customer Details','s1.name':'Name','s1.phone':'Mobile Number','s1.city':'City','s1.notes':'Notes (optional)',
's2.title':'Vehicle Basics','s2.brand':'Brand','s2.model':'Model','s2.body':'Body Type','s2.seats':'Seating'}};
function setLang(lang){ document.querySelectorAll('[data-i]').forEach(el=>{const k=el.getAttribute('data-i'); if(I18N[lang]&&I18N[lang][k]) el.textContent=I18N[lang][k]; }); }
document.getElementById('langSeg').addEventListener('click',e=>{const b=e.target.closest('button'); if(!b)return; [...e.currentTarget.children].forEach(x=>x.classList.remove('active')); b.classList.add('active'); setLang(b.dataset.lang);});
setLang('en');

/* ------------ Helpers ------------ */
const $ = id => document.getElementById(id);
const toast=(m)=>{const t=$('toast'); if(!t) return alert(m); t.textContent=m; t.classList.add('show'); clearTimeout(window._t); window._t=setTimeout(()=>t.classList.remove('show'),1400);};
const sections=[$('s1'),$('s2'),$('s3'),$('s4'),$('s5')]; const headers=[$('h1'),$('h2'),$('h3'),$('h4'),$('h5')]; const bar=$('bar');
function go(idx){ sections.forEach((s,i)=>s.hidden=i!==idx); headers.forEach((h,i)=>h.classList.toggle('active',i<=idx)); bar.style.width=(idx/4*100)+'%'; window.scrollTo({top:0,behavior:'smooth'}); }

/* ------------ Body detect ------------ */
const BODY_HINTS={sedan:['DZIRE','CITY','VERNA','CIAZ','RAPID','SLAVIA','AURA'], hatch:['SWIFT','I10','I20','ALTO','WAGON','BALENO','TIAGO'], micro:['KWID','S-PRESSO','REDIGO'],
suv:['ERTIGA','XUV','ALCAZAR','HECTOR','CRETA','BREZZA','VENUE','NEXON','SCORPIO','SAFARI','HARRIER']};
function guessBody(brand,model){ const M=(brand+' '+model).toUpperCase(); for(const [t,arr] of Object.entries(BODY_HINTS)){ if(arr.some(k=>M.includes(k))) return t; } return 'hatch'; }

/* ------------ Base + factors ------------ */
const BASE={sedan:{newP:800000,dep:y=>Math.max(0.12,Math.pow(1-0.16,y))},hatch:{newP:600000,dep:y=>Math.max(0.15,Math.pow(1-0.18,y))},micro:{newP:450000,dep:y=>Math.max(0.18,Math.pow(1-0.20,y))},
suv:{newP:1000000,dep:y=>Math.max(0.10,Math.pow(1-0.15,y))},bike:{newP:80000,dep:y=>Math.max(0.07,Math.pow(1-0.22,y))},scooter:{newP:65000,dep:y=>Math.max(0.07,Math.pow(1-0.20,y))},
evcar:{newP:1400000,dep:y=>Math.max(0.20,Math.pow(1-0.25,y))},evbike:{newP:110000,dep:y=>Math.max(0.25,Math.pow(1-0.28,y))},evscoot:{newP:90000,dep:y=>Math.max(0.25,Math.pow(1-0.28,y))}};
function bodyKey(sel){ const m=sel.toLowerCase(); if(m.includes('ev car'))return'evcar'; if(m.includes('ev bike'))return'evbike'; if(m.includes('ev scooter'))return'evscoot';
  if(m.includes('sedan'))return'sedan'; if(m.includes('micro'))return'micro'; if(m.includes('suv'))return'suv'; if(m.includes('bike'))return'bike'; if(m.includes('scooter'))return'scooter'; return'hatch';}
function fuelFactor(f){ if(f==='Diesel') return 1.06; if(f==='Petrol') return 1.00; if(f.includes('CNG')&&f.includes('Company')) return 0.98; if(f.includes('CNG')&&f.includes('After')) return 0.92; if(f.includes('LPG')&&f.includes('Company')) return 0.94; if(f.includes('LPG')&&f.includes('After')) return 0.88; if(f==='Electric') return 0.90; return 1; }
function colorAdj(c){ c=String(c||'').toUpperCase(); if(['WHITE','SILVER','GREY','GRAY'].includes(c)) return 1.02; if(['BLACK','BLUE','RED'].includes(c)) return 1.00; return 0.98; }
function ownersPenalty(s){ return s.startsWith('1')?1:s.startsWith('2')?0.97:s.startsWith('3')?0.94:0.90; }
const rs=n=>(n||0).toLocaleString('en-IN');

/* ------------ Compliance helpers ------------ */
const PRIORITY_RTOS=["MH09","MH10","MH11","MH12","MH14","MH42","MH50"];
const insBase=(key,fuel)=> (key==='bike'||key==='scooter')?1280:(fuel==='Diesel'?9000:8500);
function insDeductionAmt(key,fuel,insStatus,insTill){
  const base=insBase(key,fuel);
  if(insStatus!=='Valid') return base;
  if(!insTill) return base;
  const d=new Date(insTill+'-01'); if(isNaN(d)) return base;
  const n=new Date(); const rem=(d.getFullYear()-n.getFullYear())*12+(d.getMonth()-n.getMonth());
  if(rem<=0) return base; if(rem>=12) return 0;
  const elapsed=12-rem; return Math.round(base*(elapsed/12));
}
function fitnessCost(key,fuel){ if(key==='bike'||key==='scooter') return 5000; return (fuel==='Diesel')?22000:18000; }
function fitnessFine(expiry){ if(!expiry) return 0; const d=new Date(expiry+'-01'); if(isNaN(d)) return 0; const n=new Date(); const m=(n.getFullYear()-d.getFullYear())*12+(n.getMonth()-d.getMonth()); return m>0?m*500:0; }

/* ================== ON-ROAD CATALOG ================== */
const ONR = new Map();
const U = s => String(s||'').trim();
const UC = s => U(s).toUpperCase();
function normFuel(f){ f=UC(f); if(/PET/.test(f)) return 'PETROL'; if(/DSL|DIE/.test(f)) return 'DIESEL'; if(/CNG/.test(f)) return 'CNG'; if(/LPG/.test(f)) return 'LPG'; if(/ELEC|EV/.test(f)) return 'ELECTRIC'; return f||''; }
const BRAND_ALIASES = { 'MARUTI':'MARUTI SUZUKI','MARUTI SUZUKI':'MARUTI SUZUKI','MSIL':'MARUTI SUZUKI','HYUNDAI':'HYUNDAI','TOYOTA':'TOYOTA','TATA':'TATA','MAHINDRA':'MAHINDRA' };
const MODEL_ALIASES  = { 'ALTO K10':'ALTO K10','I10':'I10','INNOVA':'INNOVA CRYSTA','INNOVA CRYSTA':'INNOVA CRYSTA' };
function normVariant(v){ v=UC(v); v=v.replace(/\bMT\b/g,'MANUAL').replace(/\bAT\b/g,'AUTOMATIC'); return v.replace(/\s+/g,' ').trim(); }
function brandKey(b){ return BRAND_ALIASES[UC(b)] || UC(b); }
function modelKey(m){ m=UC(m); return MODEL_ALIASES[m] || m; }
function catKey(brand, model){ return brandKey(brand)+'|'+modelKey(model); }
(function bootstrapOnRoad(){
  try{
    const tag=document.getElementById('onroad-data'); if(!tag) return;
    const rows=JSON.parse(tag.textContent||'[]');
    rows.forEach(r=>{
      const b=brandKey(r.brand), m=modelKey(r.model), v=normVariant(r.variant||''), f=normFuel(r.fuel||''), price=Number(r.onroad_price)||0;
      const yf=r.year_from?Number(r.year_from):null, yt=r.year_to?Number(r.year_to):null;
      if(!b||!m||!price) return;
      const key=catKey(b,m); const list=ONR.get(key)||[];
      list.push({brand:b,model:m,variant:v,fuel:f,price,yf,yt}); ONR.set(key,list);
    });
  }catch(e){ console.warn('ON-ROAD catalog load failed', e); }
})();
function getOnroadPrice(brand, model, variant, fuel, year){
  if(ONR.size===0) return 0;
  const key=catKey(brand,model), list=ONR.get(key); if(!list||!list.length) return 0;
  const yr=Number(year)||null;
  const matches=(row,needV,needF)=>{
    if(needV && row.variant && normVariant(variant)!==row.variant) return false;
    if(needF && row.fuel && normFuel(fuel)!==row.fuel) return false;
    if(yr && (row.yf && yr<row.yf)) return false;
    if(yr && (row.yt && yr>row.yt)) return false;
    return true;
  };
  let cand=list.find(r=>matches(r,true,true)); if(cand) return cand.price;
  cand=list.find(r=>matches(r,false,true));     if(cand) return cand.price;
  cand=list.find(r=>matches(r,true,false));     if(cand) return cand.price;
  return list[0].price||0;
}
function onroadCapFactor(age){
  if(age<=1) return 0.92;
  if(age<=3) return 0.82;
  if(age<=5) return 0.70;
  if(age<=8) return 0.60;
  if(age<=12) return 0.48;
  if(age<=15) return 0.35;
  return 0.20;
}

/* ------------ Compute (mode-aware) ------------ */
function compute(){
  const brand=$('brand').value||'', model=$('model').value||'';
  let body=$('body').value || 'Hatchback';
  if(body==='Hatchback' && (brand||model))
    body = {sedan:'Sedan',hatch:'Hatchback',micro:'Micro',suv:'SUV'}[guessBody(brand,model)] || body;

  const key=bodyKey(body);
  const seats=$('seats').value;
  const year=Number($('year').value||new Date().getFullYear());
  const age=Math.max(0,new Date().getFullYear()-year);
  const fuel=$('fuel').value;

  // BASE
  const baseCfg=BASE[key]||BASE.hatch;
  let base=baseCfg.newP * baseCfg.dep(age);
  if(key==='suv' && seats==='7') base*=1.06;

  const km=Number($('km').value||0);
  if(['suv','sedan','hatch','micro','evcar'].includes(key)){
    if(km>60000) base -= (km-60000) * 0.75;
    else if(km<30000) base *= 1.04;
  } else {
    if(km>40000) base -= (km-40000) * 0.30;
    else if(km<15000) base *= 1.05;
  }
  if(['suv','sedan','hatch','micro','evcar'].includes(key) && $('trans').value==='Automatic') base*=1.03;
  base*=ownersPenalty($('owners').value);
  base*=fuelFactor(fuel);
  base*=colorAdj($('color').value);

  const np=parseFloat(($('newPrice').value||'').trim());
  if(!isNaN(np) && np>0){ base = Math.round(base*0.85 + np*0.15); }

  // ON-ROAD CAP (cars only)
  const isCarKey = ['sedan','hatch','micro','suv','evcar'].includes(key);
  if(isCarKey){
    const onr = getOnroadPrice(brand, model, $('model').value||'', fuel, year);
    if(onr > 0){
      let cap = onroadCapFactor(age) * onr;
      if(key==='suv') cap = Math.round(cap * 1.06);
      if(base > cap){ base = cap; }
    }
  }

  // PUBLIC vs ADMIN
  const W = isAdmin() ? 1.0 : 0.45;

  // RTO
  const reg=($('reg').value||'').toUpperCase().replace(/\s+/g,'');
  const rto=reg.slice(0,4);
  const rtoDed=PRIORITY_RTOS.includes(rto)?0:Math.round(base*0.10*W);

  // Fitness
  let fitState=$('fit').value, fitCost=0, fine=0;
  if(age>=15){
    if(fitState==='Not Available'){
      fitCost=Math.round(fitnessCost(key,fuel)*W);
      fine=Math.round(fitnessFine($('fitExpiry').value)*W);
    }
  }else{
    fitState='Not Required (age < 15)'; $('fitExpiry').value='';
  }

  // Insurance
  const insStatus=$('ins').value, insTill=$('insTill').value;
  const insDed=Math.round(insDeductionAmt(key,fuel,insStatus,insTill)*W);

  // Condition
  const condSel=$('cond').value;
  const condPct=condSel==='Good'?0.02:condSel==='Average'?0.05:condSel==='Poor'?0.10:0;
  const condDed=Math.round(base*condPct*W);

  // RC/PUC nudges
  if($('rc').value==='Expired') base=Math.round(base*(W<1?0.975:0.95));
  if($('puc').value==='Expired') base=Math.round(base*(W<1?0.995:0.985));

  // Final
  let final=(base - rtoDed) - fitCost - fine - insDed - condDed;
  if(!isAdmin()) final=Math.round(final*1.06);
  final=Math.max(final,(key==='bike'||key==='scooter')?5000:25000);

  const mid=Math.round(final/1000)*1000;
  const min=Math.max(5000,Math.round(mid*(isAdmin()?0.93:0.90)/1000)*1000);
  const max=Math.max(min+1000,Math.round(mid*(isAdmin()?1.07:1.12)/1000)*1000);

  // <-- FIX: breakdown मध्ये backticks (template strings)
  const breakdown = [
    `Base (computed): ₹${rs(Math.round(base))}`,
    `RTO ${PRIORITY_RTOS.includes(rto) ? '(Priority ✓)' : '(Non-priority −10%)'}: −₹${rs(rtoDed)}`,
    `Fitness Charges: −₹${rs(fitCost)}`,
    `Fine (₹500/mo): −₹${rs(fine)}`,
    `Insurance (month-wise): −₹${rs(insDed)}`,
    `Condition (${condSel||'—'}): −₹${rs(condDed)}`
  ].join('\n');

  return { min, max, mid, body, key, rto, insStatus, insTill, fitState, breakdown }
}
/* ------------ Fitness auto toggle (15+ yrs) ------------ */
(function(){
  const $ = id => document.getElementById(id);
  const yearEl = $('year'), fitEl  = $('fit'), fitExp = $('fitExpiry');
  const fitExpRow = fitExp ? fitExp.closest('div') : null;
  function age(){const y=parseInt(yearEl?.value||0,10);const n=new Date().getFullYear();return (y&&y>=1900&&y<=n+1)?(n-y):0;}
  function sync(){
    const a=age();
    if(a>=15){ fitEl.disabled=false; if(fitEl.value==='Not Required (age < 15)'||!fitEl.value) fitEl.value='Not Available'; if(fitExp){fitExp.disabled=false; if(fitExpRow) fitExpRow.style.display='block';}}
    else{ fitEl.value='Not Required (age < 15)'; fitEl.disabled=true; if(fitExp){fitExp.value=''; fitExp.disabled=true; if(fitExpRow) fitExpRow.style.display='none';}}
  }
  yearEl?.addEventListener('input',sync); yearEl?.addEventListener('change',sync); sync();
})();

/* ------------ Bindings + Save ------------ */
(function(){
  const $=id=>document.getElementById(id);
  const t=m=>{const x=$('toast'); if(x){ x.textContent=m; x.classList.add('show'); setTimeout(()=>x.classList.remove('show'),1500);}};

  $('next1')?.addEventListener('click', ()=>{
    const ok=$('name')?.value && /^\d{10}$/.test(($('phone')?.value||'').trim()) && $('city')?.value;
    if(!ok) return t('Please fill Name, 10-digit Mobile & City');
    go(1);
  });
  $('back2')?.addEventListener('click', ()=> go(0));
  $('next2')?.addEventListener('click', ()=>{
    if(!$('brand')?.value || !$('model')?.value){ return t('Enter brand & model'); }
    const m=($('body')?.value||'').toLowerCase();
    const k=m.includes('ev car')?'evcar':m.includes('ev bike')?'evbike':m.includes('ev scooter')?'evscoot':
            m.includes('sedan')?'sedan':m.includes('micro')?'micro':m.includes('suv')?'suv':
            m.includes('bike')?'bike':m.includes('scooter')?'scooter':'hatch';
    if($('transWrap')) $('transWrap').style.display=['suv','sedan','hatch','micro','evcar'].includes(k)?'block':'none';
    go(2);
  });
  $('back3')?.addEventListener('click', ()=> go(1));
  $('next3')?.addEventListener('click', ()=>{
    const y=+($('year')?.value||0);
    if(!y || y<2001 || y>2030) return t('Enter year 2001–2030');
    if(!$('km')?.value) return t('Enter KMs');
    const age=new Date().getFullYear()-y;
    if(age>=15 && $('fit')) $('fit').value='Not Available';
    if(age<15){ if($('fit')) $('fit').value='Not Required (age < 15)'; if($('fitExpiry')) $('fitExpiry').value=''; }
    go(3);
  });
  $('back4')?.addEventListener('click', ()=> go(2));

  $('calc')?.addEventListener('click', ()=>{
    const y=+($('year')?.value||0);
    if(!y || y<2001 || y>2030) return t('Enter year 2001–2030');
    if($('ins')?.value==='Valid' && !$('insTill')?.value) return t('Select Insurance month');
    const age=new Date().getFullYear()-y;
    if(age>=15 && $('fit')?.value==='Not Available' && !$('fitExpiry')?.value) return t('Enter Fitness expiry');

    const r=compute();
    const rsF=n=>'₹'+Number(n).toLocaleString('en-IN');
    $('min').textContent=rsF(r.min); $('max').textContent=rsF(r.max); $('mid').textContent=rsF(r.mid);

    $('tagBody').textContent = ($('body')?.value||'')+' • '+($('seats')?.value||'')+' seats';
    $('tagBrand').textContent= ( ($('brand')?.value||'')+' '+($('model')?.value||'') ).trim();
    $('tagYear').textContent = $('year')?.value||'—';
    $('tagKm').textContent   = (Number($('km')?.value||0)).toLocaleString('en-IN')+' km';
    const reg=($('reg')?.value||'').toUpperCase().replace(/\s+/g,''); $('tagRTO').textContent = reg?('RTO '+reg.slice(0,4)):'RTO —';
    $('tagIns').textContent  = 'Insurance: '+($('ins')?.value||'')+($('insTill')?.value?(' till '+$('insTill')?.value):'');
    $('tagFit').textContent  = 'Fitness: '+($('fit')?.value||'');
    $('tagCond').textContent = 'Condition: '+($('cond')?.value||'');
/* ------------ Google Sheet SAVE (frontend) ------------ */
  // 👇 इथे तुझा Web App (exec) URL
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwFHhAoK83U4vD60ucz7JOtj3xMvwUn3Jvf0G9rakBq3jLc_jIcrYxfe5V4GvGfXY6eHw/exec";

  // toast helper (already above; keep using same one)
  function toast(msg){
    const t=document.getElementById('toast');
    if(!t) return alert(msg);
    t.textContent=msg;
    t.classList.add('show');
    clearTimeout(window.__tt);
    window.__tt=setTimeout(()=>t.classList.remove('show'),2000);
  }

  // ======== SAVE button handler ========
  document.getElementById('saveLead').addEventListener('click', async () => {
    const $ = id => document.getElementById(id);

    const payload = {
      vid: String(Date.now()),
      name: $('name')?.value || '',
      phone: $('phone')?.value || '',
      city: $('city')?.value || '',
      notes: $('notes')?.value || '',

      type: $('body')?.value || '',
      brand: $('brand')?.value || '',
      model: $('model')?.value || '',
      variant: '',
      year: $('year')?.value || '',
      fuel: $('fuel')?.value || '',
      km: $('km')?.value || '',
      reg: $('reg')?.value || '',
      color: $('color')?.value || '',
      owner: $('owners')?.value || '',

      rcStatus: $('rc')?.value || '',
      insuranceStatus: $('ins')?.value || '',
      insTill: $('insTill')?.value || '',
      puc: $('puc')?.value || '',
      fit: $('fit')?.value || '',
      fitExp: $('fitExpiry')?.value || '',

      slotDate: $('datePick')?.value || '',
      slotTime: $('timePick')?.value || '',

      estMin: (document.getElementById('min')?.textContent||'').replace(/[^\d]/g,''),
      estMax: (document.getElementById('max')?.textContent||'').replace(/[^\d]/g,''),
      source: 'sell-form'
    };

    try {
      const res = await fetch(WEBAPP_URL, {
        method: 'POST',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      // GAS ने JSON परत दिलं नाही/ CORS मुळे वाचता आलं नाही तरही UI fail होऊ नये
      let ok = false, out = null;
      try { out = await res.json(); ok = !!out?.ok; } catch(_){ ok = res.ok; }

      if (!ok) throw new Error(out?.error || Save failed (${res.status}));

      toast("✅ Submitted! We’ll call you shortly.");

      // WhatsApp link अपडेट
      const msg = encodeURIComponent(
`Sell Lead
Name: ${payload.name}
Phone: ${payload.phone}
City: ${payload.city}
Vehicle: ${payload.brand} ${payload.model} (${payload.type})
Year/Fuel/KM: ${payload.year}/${payload.fuel}/${Number(payload.km||0).toLocaleString('en-IN')} km
Est: ₹${Number(payload.estMin||0).toLocaleString('en-IN')}–₹${Number(payload.estMax||0).toLocaleString('en-IN')}`
      );
      const wa = document.getElementById('wa');
      if (wa) wa.href = "https://wa.me/919822292955?text="+msg;

    } catch (err) {
      console.error("Save error:", err);
      toast("⚠️ Could not submit. Please try again.");
    }
  });
})();  /* IIFE END */
Name: ${payload.name}
Phone: ${payload.phone}
City: ${payload.city}
Vehicle: ${payload.brand} ${payload.model} (${payload.type})
Year/Fuel/KM: ${payload.year}/${payload.fuel}/${Number(payload.km||0).toLocaleString('en-IN')} km
Est: ₹${Number(payload.estMin||0).toLocaleString('en-IN')}–₹${Number(payload.estMax||0).toLocaleString('en-IN')}`
      );
      const wa = document.getElementById('wa');
      if (wa) wa.href = "https://wa.me/919822292955?text="+msg;

    } catch (err) {
      console.error("Save error:", err);
      toast("⚠️ Could not submit. Please try again.");
    }
  });
})(); // <— IIFE properly closed
</script>
</body>
</html>
